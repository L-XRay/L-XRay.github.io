<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Test</title>
      <link href="/posts/784dd132.html"/>
      <url>/posts/784dd132.html</url>
      
        <content type="html"><![CDATA[<div class="video"><video controls preload><source src='https://www.bilibili.com/bangumi/play/ep64315?from_spmid=666.4.feed.12' type='video/mp4'>Your browser does not support the video tag.</video></div>]]></content>
      
      
      <categories>
          
          <category> ä¸€äº› </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>HashMapæºç (ä¸Š)</title>
      <link href="/posts/235dfb88.html"/>
      <url>/posts/235dfb88.html</url>
      
        <content type="html"><![CDATA[<p>HashMap æœ€æ—©å‡ºç°åœ¨JDK1.2ä¸­ï¼Œåº•å±‚åŸºäºæ•£åˆ—ç®—æ³•å®ç°</p><ul><li>HashMap <strong>å…è®¸null é”®å’Œnull å€¼</strong>ï¼Œåœ¨è®¡ç®—å“ˆé”®çš„å“ˆå¸Œå€¼æ—¶ï¼Œ<strong>null é”®å“ˆå¸Œå€¼ä¸º0</strong>ã€‚</li><li>HashMap <strong>å¹¶ä¸ä¿è¯é”®å€¼å¯¹çš„é¡ºåº</strong>ï¼Œè¿™æ„å‘³ç€åœ¨è¿›è¡ŒæŸäº›æ“ä½œåï¼Œé”®å€¼å¯¹çš„é¡ºåºå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚</li><li>HashMap æ˜¯<strong>éçº¿ç¨‹å®‰å…¨ç±»</strong>ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜ã€‚</li></ul><p>HashMapåœ¨JDK 1.8ä¸­åŒ…æ‹¬ï¼›1ã€æ•£åˆ—è¡¨å®ç°ã€2ã€æ‰°åŠ¨å‡½æ•°ã€3ã€åˆå§‹åŒ–å®¹é‡ã€4ã€è´Ÿè½½å› å­ã€5ã€æ‰©å®¹å…ƒç´ æ‹†åˆ†ã€6ã€é“¾è¡¨æ ‘åŒ–ã€7ã€çº¢é»‘æ ‘ã€8ã€æ’å…¥ã€9ã€æŸ¥æ‰¾ã€10ã€åˆ é™¤ã€11ã€éå†ã€12ã€åˆ†æ®µé”ç­‰ç­‰<br>è¿™é‡Œæˆ‘ä»¬å…ˆæŠŠç›®å…‰æ”¾åœ¨å‰äº”é¡¹ä¸Šï¼Œä¹Ÿå°±æ˜¯å…³äºæ•°æ®ç»“æ„çš„ä½¿ç”¨ä¸Šã€‚</p><h1 id="æ•£åˆ—è¡¨å®ç°ï¼ˆä¸€ä¸ªç®€å•çš„HashMapï¼‰"><a href="#æ•£åˆ—è¡¨å®ç°ï¼ˆä¸€ä¸ªç®€å•çš„HashMapï¼‰" class="headerlink" title="æ•£åˆ—è¡¨å®ç°ï¼ˆä¸€ä¸ªç®€å•çš„HashMapï¼‰"></a>æ•£åˆ—è¡¨å®ç°ï¼ˆä¸€ä¸ªç®€å•çš„HashMapï¼‰</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        list.add(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;power&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;technology&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;environment&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;world&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String[] tab = <span class="keyword">new</span> <span class="title class_">String</span>[list.size()];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String value : list) &#123;</span><br><span class="line">            <span class="comment">// è®¡ç®—ç´¢å¼•: æŒ‡å®švalueçš„hashå€¼ æŒ‰ä½ä¸ tabæœ€å¤§ä¸‹æ ‡ ä¿è¯ä¸è¶Šç•Œ</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> value.hashCode() &amp; (tab.length - <span class="number">1</span>);</span><br><span class="line">            System.out.println(String.format(<span class="string">&quot;key: %d, value: %s&quot;</span>,key,value));</span><br><span class="line">            <span class="comment">// å¦‚æœæ•°ç»„å½“å‰ç´¢å¼•ä¸­ä¸å­˜åœ¨value,èµ‹å€¼</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == tab[key]) &#123;</span><br><span class="line">                tab[key] = value;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å­˜åœ¨åˆ™å°†å…¶é“¾æ¥èµ·æ¥</span></span><br><span class="line">            tab[key] = tab[key]+ <span class="string">&quot;-&gt;&quot;</span>+ value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(Arrays.toString(tab));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/hashmap-simple.png" alt="hashmap-simple"></p><h3 id="æ‰€å­˜åœ¨çš„é—®é¢˜"><a href="#æ‰€å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="æ‰€å­˜åœ¨çš„é—®é¢˜"></a>æ‰€å­˜åœ¨çš„é—®é¢˜</h3><ol><li>æ‰€æœ‰çš„å…ƒç´ å­˜æ”¾éƒ½éœ€è¦ä¸€ä¸ªç´¢å¼•ä½ç½®ï¼Œå¦‚æœç´¢å¼•ä½ç½®ä¸å¤Ÿå¯¼è‡´æ•£åˆ—ç¢°æ’ä¸¥é‡ï¼Œé‚£å°±æ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„æ€§èƒ½ï¼Œä¹Ÿå°±å¤±å»äº†æ•£åˆ—è¡¨çš„æ„ä¹‰</li><li>åœ¨è·å–ç´¢å¼• ID çš„è®¡ç®—å…¬å¼ä¸­ï¼Œéœ€è¦æ•°ç»„é•¿åº¦æ˜¯ 2 çš„å€æ•°ï¼ˆéœ€è¦ä¿è¯èƒ½è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œä¸è¶Šç•Œï¼‰ï¼Œæ•°ç»„å¤§å°å¦‚ä½•è®¾å®šï¼Ÿ</li><li>æ•°ç»„è¶Šå°ç¢°æ’è¶Šå¤§ï¼Œæ•°ç»„è¶Šå¤§ç¢°æ’è¶Šå°ï¼Œå¦‚ä½•å–èˆæ—¶é—´ä¸ç©ºé—´ï¼Ÿ</li><li>ç›®å‰å­˜æ”¾ 7 ä¸ªå…ƒç´ ï¼Œå·²ç»æœ‰ä¸¤ä¸ªä½ç½®éƒ½å­˜æ”¾äº† 2 ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆé“¾è¡¨è¶Šæ¥è¶Šé•¿æ€ä¹ˆä¼˜åŒ–ï¼Ÿ</li><li>éšç€å…ƒç´ çš„ä¸æ–­æ·»åŠ ï¼Œæ•°ç»„é•¿åº¦ä¸è¶³æ‰©å®¹æ—¶ï¼Œæ€ä¹ˆæŠŠåŸæœ‰çš„å…ƒç´ æ‹†åˆ†åˆ°æ–°çš„ä½ç½®ä¸Šå»ï¼Ÿ</li></ol><p>ä»¥ä¸Šè¿™äº›é—®é¢˜å¯ä»¥å½’çº³ä¸ºï¼›æ‰°åŠ¨å‡½æ•°ã€åˆå§‹åŒ–å®¹é‡ã€è´Ÿè½½å› å­ã€æ‰©å®¹æ–¹æ³•ä»¥åŠé“¾è¡¨å’Œçº¢é»‘æ ‘è½¬æ¢çš„ä½¿ç”¨ç­‰ã€‚</p><h1 id="æ‰°åŠ¨å‡½æ•°"><a href="#æ‰°åŠ¨å‡½æ•°" class="headerlink" title="æ‰°åŠ¨å‡½æ•°"></a>æ‰°åŠ¨å‡½æ•°</h1><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/hashmap-%E6%89%B0%E5%8A%A8%E5%87%BD%E6%95%B0.png" alt="hashmap-æ‰°åŠ¨å‡½æ•°"><br>åœ¨ HashMap å­˜æ”¾å…ƒç´ æ—¶å€™æœ‰è¿™æ ·ä¸€æ®µä»£ç æ¥å¤„ç†å“ˆå¸Œå€¼ï¼Œè¿™æ˜¯ Java 8 çš„æ•£åˆ—å€¼æ‰°åŠ¨å‡½æ•°ï¼Œç”¨äºä¼˜åŒ–æ•£åˆ—æ•ˆæœã€‚<br>ç†è®ºä¸Šæ¥è¯´å­—ç¬¦ä¸²çš„ hashCodeæ˜¯ä¸€ä¸ª int ç±»å‹å€¼ï¼Œé‚£å¯ä»¥ç›´æ¥ä½œä¸ºæ•°ç»„ä¸‹æ ‡äº†ï¼Œä¸”ä¸ä¼šå‡ºç°ç¢°æ’ã€‚ä½†æ˜¯è¿™ä¸ª hashCode çš„å–å€¼èŒƒå›´æ˜¯[-2147483648, 2147483647]ï¼Œ æœ‰å°†è¿‘ 40 äº¿çš„é•¿åº¦ï¼Œè°ä¹Ÿä¸èƒ½æŠŠæ•°ç»„åˆå§‹åŒ–çš„è¿™ä¹ˆå¤§ï¼Œå†…å­˜ä¹Ÿæ˜¯æ”¾ä¸ä¸‹çš„ã€‚ æˆ‘ä»¬<strong>é»˜è®¤åˆå§‹åŒ–çš„ Map å¤§å°æ˜¯ 16 ä¸ªé•¿åº¦ã€‚</strong>DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4ï¼Œ æ‰€ä»¥è·å–çš„ Hash å€¼å¹¶ä¸èƒ½ç›´æ¥ä½œä¸ºä¸‹æ ‡ä½¿ç”¨ï¼Œéœ€è¦ä¸æ•°ç»„é•¿åº¦è¿›è¡Œå–æ¨¡è¿ç®—å¾—åˆ°ä¸€ä¸ªä¸‹æ ‡å€¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢åšçš„æ•£åˆ—åˆ—å­ã€‚<br>hashMap æºç è¿™é‡Œä¸åªæ˜¯ç›´æ¥è·å–å“ˆå¸Œå€¼ï¼Œè¿˜è¿›è¡Œäº†ä¸€æ¬¡æ‰°åŠ¨è®¡ç®—ï¼Œ(h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)ã€‚æŠŠå“ˆå¸Œå€¼å³ç§» 16 ä½ï¼Œä¹Ÿå°±æ­£å¥½æ˜¯è‡ªå·±é•¿åº¦çš„ä¸€åŠï¼Œä¹‹åä¸åŸå“ˆå¸Œå€¼åšå¼‚æˆ–è¿ç®—ï¼Œè¿™æ ·å°±æ··åˆäº†åŸå“ˆå¸Œå€¼ä¸­çš„é«˜ä½å’Œä½ä½ï¼Œå¢å¤§äº†<strong>éšæœºæ€§</strong>ã€‚<br><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/HashMap-%E6%89%B0%E5%8A%A8%E5%87%BD%E6%95%B0.drawio.png" alt="HashMap-æ‰°åŠ¨å‡½æ•°.drawio"><br>ä½¿ç”¨æ‰°åŠ¨å‡½æ•°å°±æ˜¯ä¸ºäº†å¢åŠ éšæœºæ€§ï¼Œè®©æ•°æ®å…ƒç´ æ›´åŠ å‡è¡¡çš„æ•£åˆ—ï¼Œå‡å°‘hashç¢°æ’ï¼Œè®©æ•°æ®å­˜æ”¾å’Œè·å–çš„æ•ˆç‡æ›´å¥½</p><h1 id="åˆå§‹åŒ–å®¹é‡"><a href="#åˆå§‹åŒ–å®¹é‡" class="headerlink" title="åˆå§‹åŒ–å®¹é‡"></a>åˆå§‹åŒ–å®¹é‡</h1><p>æ•£åˆ—æ•°ç»„éœ€è¦ä¸€ä¸ª 2 çš„å€æ•°çš„é•¿åº¦ï¼Œå› ä¸ºåªæœ‰ 2 çš„ å€æ•°åœ¨å‡ 1 çš„æ—¶å€™ï¼Œæ‰ä¼šå‡ºç° 01111 è¿™æ ·çš„å€¼ã€‚é‚£ä¹ˆè¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨åˆå§‹åŒ– HashMap çš„æ—¶å€™ï¼Œå¦‚æœä¼ ä¸€ä¸ª 17 ä¸ªçš„å€¼ new HashMap&lt;&gt;(17);ï¼Œå®ƒä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><h2 id="å¯»æ‰¾æœ€å°äºŒè¿›åˆ¶æ•°"><a href="#å¯»æ‰¾æœ€å°äºŒè¿›åˆ¶æ•°" class="headerlink" title="å¯»æ‰¾æœ€å°äºŒè¿›åˆ¶æ•°"></a>å¯»æ‰¾æœ€å°äºŒè¿›åˆ¶æ•°</h2><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/hashmap-%E5%AF%BB%E6%89%BE%E6%9C%80%E5%B0%8F2%E7%9A%84n%E6%96%B9%E6%95%B0.png" alt="hashmap-å¯»æ‰¾æœ€å°2çš„næ–¹æ•°"></p><ul><li>åœ¨ HashMap çš„åˆå§‹åŒ–ä¸­ï¼Œé˜€å€¼ thresholdï¼Œé€šè¿‡æ–¹æ³• tableSizeFor è¿›è¡Œè®¡ç®—ï¼Œæ˜¯æ ¹æ®åˆå§‹åŒ–å¤§å°æ¥è®¡ç®—çš„ã€‚</li><li>è¿™ä¸ªæ–¹æ³•ä¹Ÿå°±æ˜¯è¦å¯»æ‰¾æ¯”åˆå§‹å€¼å¤§çš„ï¼Œæœ€å°çš„é‚£ä¸ª 2 è¿›åˆ¶æ•°å€¼ã€‚æ¯”å¦‚ä¼ äº† 17ï¼Œæˆ‘åº”è¯¥æ‰¾åˆ°çš„æ˜¯ 32ã€‚</li></ul><p>è®¡ç®—é˜€å€¼å¤§å°çš„æ–¹æ³•ï¼š<br><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/hashmap-tableSizeFor.png" alt="hashmap-tableSizeFor"></p><ul><li>MAXIMUM_CAPACITY = 1 &lt;&lt; 30ï¼Œè¿™ä¸ªæ˜¯ä¸´ç•ŒèŒƒå›´ï¼Œä¹Ÿå°±æ˜¯æœ€å¤§å®¹é‡ã€‚</li><li>ä¹ä¸€çœ‹å¯èƒ½æœ‰ç‚¹æ™•ğŸ˜µæ€ä¹ˆéƒ½åœ¨å‘å³ç§»ä½ 1ã€2ã€4ã€8ã€16ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº† æŠŠäºŒè¿›åˆ¶çš„å„ä¸ªä½ç½®éƒ½å¡«ä¸Š 1ï¼Œå½“äºŒè¿›åˆ¶çš„å„ä¸ªä½ç½®éƒ½æ˜¯ 1 ä»¥åï¼Œå°±æ˜¯ ä¸€ä¸ªæ ‡å‡†çš„ 2 çš„å€æ•°å‡ 1 äº†ï¼Œæœ€åæŠŠç»“æœåŠ  1 å†è¿”å›å³å¯ã€‚</li></ul><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/HashMap-%E8%AE%A1%E7%AE%97%E9%98%88%E5%80%BC.drawio.png" alt="HashMap-è®¡ç®—é˜ˆå€¼.drawio"></p><h1 id="è´Ÿè½½å› å­"><a href="#è´Ÿè½½å› å­" class="headerlink" title="è´Ÿè½½å› å­"></a>è´Ÿè½½å› å­</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* The default initial capacity - MUST be a power of two.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* The maximum capacity, used if a higher value is implicitly specified</span></span><br><span class="line"><span class="comment">* by either of the constructors with arguments.</span></span><br><span class="line"><span class="comment">* MUST be a power of two &lt;= 1&lt;&lt;30.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAXIMUM_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* The load factor used when none specified in constructor.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">DEFAULT_LOAD_FACTOR</span> <span class="operator">=</span> <span class="number">0.75f</span>;</span><br></pre></td></tr></table></figure><p>è´Ÿè½½å› å­ï¼Œå¯ä»¥ç†è§£æˆä¸€è¾†è½¦å¯æ‰¿é‡é‡é‡è¶…è¿‡æŸä¸ªé˜€å€¼æ—¶ï¼ŒæŠŠè´§æ”¾åˆ°æ–°çš„è½¦ä¸Šã€‚<br><strong>åœ¨ HashMap ä¸­ï¼Œè´Ÿè½½å› å­å†³å®šäº†æ•°æ®é‡å¤šå°‘äº†ä»¥åè¿›è¡Œæ‰©å®¹ã€‚</strong><br><em>è¿™é‡Œè¦æåˆ°ä¸Šé¢åšçš„ HashMap ä¾‹å­ï¼Œæˆ‘ä»¬å‡†å¤‡äº† 6 ä¸ªå…ƒç´ ï¼Œä½†æ˜¯æœ€åè¿˜æœ‰ 2 ä¸ªä½ç½®ç©ºä½™ï¼Œ2 ä¸ª </em><br><em>ä½ç½®å­˜æ”¾äº† 2 ä¸ªå…ƒç´ ã€‚ </em><br>æ‰€ä»¥å¯èƒ½å³ä½¿ä½ æ•°æ®ä¸æ•°ç»„å®¹é‡ä¸€æ ·å¤§æ—¶ä¹Ÿä¸ä¸€å®šèƒ½æ­£æ­£å¥½å¥½çš„æŠŠæ•°ç»„å æ»¡çš„ï¼Œè€Œæ˜¯åœ¨æŸäº›å°æ ‡ä½ç½®å‡ºç°äº†å¤§é‡çš„ç¢°æ’ï¼Œåªèƒ½åœ¨åŒä¸€ä¸ªä½ç½®ç”¨é“¾è¡¨å­˜æ”¾ï¼Œé‚£ä¹ˆè¿™æ ·å°±å¤±å»äº† Map æ•°ç»„çš„æ€§èƒ½ã€‚<br>è¦é€‰æ‹©ä¸€ä¸ªåˆç†çš„å¤§å°ä¸‹è¿›è¡Œæ‰©å®¹ï¼Œé»˜è®¤å€¼ 0.75 å°±æ˜¯è¯´å½“é˜€å€¼å®¹é‡å äº† 3/4 æ—¶èµ¶ç´§æ‰©å®¹ï¼Œå‡å°‘ Hash ç¢°æ’ã€‚åŒæ—¶ 0.75 æ˜¯ä¸€ä¸ªé»˜è®¤æ„é€ å€¼ï¼Œåœ¨åˆ›å»º HashMap ä¹Ÿå¯ä»¥è°ƒæ•´ï¼Œæ¯”å¦‚ä½ å¸Œæœ›ç”¨æ›´å¤šçš„ç©ºé—´æ¢å–æ—¶é—´ï¼Œå¯ä»¥æŠŠè´Ÿè½½å› å­è°ƒçš„æ›´å°ä¸€äº›ï¼Œå‡å°‘ç¢°æ’ã€‚</p><h1 id="æ‰©å®¹å…ƒç´ æ‹†åˆ†"><a href="#æ‰©å®¹å…ƒç´ æ‹†åˆ†" class="headerlink" title="æ‰©å®¹å…ƒç´ æ‹†åˆ†"></a>æ‰©å®¹å…ƒç´ æ‹†åˆ†</h1><p>ä¸ºä»€ä¹ˆæ‰©å®¹ï¼Œå› ä¸ºæ•°ç»„é•¿åº¦ä¸è¶³äº†ã€‚é‚£æ‰©å®¹æœ€ç›´æ¥çš„é—®é¢˜ï¼Œå°±æ˜¯éœ€è¦æŠŠå…ƒç´ æ‹†åˆ†åˆ°æ–°çš„æ•°ç»„ä¸­ã€‚æ‹†åˆ†å…ƒç´ çš„è¿‡ç¨‹ä¸­ï¼ŒåŸ jdk1.7 ä¸­ä¼šéœ€è¦é‡æ–°è®¡ç®—å“ˆå¸Œå€¼ï¼Œä½†æ˜¯åˆ° jdk1.8 ä¸­å·²ç»è¿›è¡Œä¼˜åŒ–ï¼Œä¸åœ¨éœ€è¦é‡æ–°è®¡ç®—ï¼Œæå‡äº†æ‹†åˆ†çš„æ€§èƒ½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        list.add(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;power&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;technology&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;environment&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;good&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;sad&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;god&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;yeah&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;uncle&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;Java&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;PHP&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;C#&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;C&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;Python&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;GO&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String value : list) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> value.hashCode() ^ (value.hashCode() &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">key16</span> <span class="operator">=</span> hash &amp; (<span class="number">16</span> - <span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">key32</span> <span class="operator">=</span> hash &amp; (<span class="number">32</span> - <span class="number">1</span>);</span><br><span class="line">            System.out.println(</span><br><span class="line">                <span class="string">&quot;value:&quot;</span> + value +</span><br><span class="line">                <span class="string">&quot;\n\tkey(16):&quot;</span> + key16 +</span><br><span class="line">                <span class="string">&quot;\tBitå€¼:&quot;</span> + Integer.toBinaryString(hash) + <span class="string">&quot; - &quot;</span> + Integer.toBinaryString(hash &amp; <span class="number">16</span>) +</span><br><span class="line">                <span class="string">&quot;\n\tkey(32):&quot;</span> + key32 +</span><br><span class="line">                <span class="string">&quot;\tBitå€¼:&quot;</span> + Integer.toBinaryString(hash) + <span class="string">&quot; - &quot;</span> + Integer.toBinaryString(hash &amp; (<span class="number">32</span> - <span class="number">1</span>))</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">value:one</span><br><span class="line">key(16):7Bitå€¼:11010111001100111 - 0</span><br><span class="line">key(32):7Bitå€¼:11010111001100111 - 111</span><br><span class="line">value:power</span><br><span class="line">key(16):11Bitå€¼:110010111101000111101011011 - 10000</span><br><span class="line">key(32):27Bitå€¼:110010111101000111101011011 - 11011</span><br><span class="line">value:technology</span><br><span class="line">key(16):11Bitå€¼:10011011111001110001111011101011 - 0</span><br><span class="line">key(32):11Bitå€¼:10011011111001110001111011101011 - 1011</span><br><span class="line">value:environment</span><br><span class="line">key(16):2Bitå€¼:11111010111000011100100011110010 - 10000</span><br><span class="line">key(32):18Bitå€¼:11111010111000011100100011110010 - 10010</span><br><span class="line">value:hello</span><br><span class="line">key(16):11Bitå€¼:101111010010001110100111011 - 10000</span><br><span class="line">key(32):27Bitå€¼:101111010010001110100111011 - 11011</span><br><span class="line">value:world</span><br><span class="line">key(16):3Bitå€¼:110110000010001110101010011 - 10000</span><br><span class="line">key(32):19Bitå€¼:110110000010001110101010011 - 10011</span><br><span class="line">value:good</span><br><span class="line">key(16):13Bitå€¼:1100001000000010001101 - 0</span><br><span class="line">key(32):13Bitå€¼:1100001000000010001101 - 1101</span><br><span class="line">value:sad</span><br><span class="line">key(16):7Bitå€¼:11011101111010111 - 10000</span><br><span class="line">key(32):23Bitå€¼:11011101111010111 - 10111</span><br><span class="line">value:god</span><br><span class="line">key(16):13Bitå€¼:11001000001111101 - 10000</span><br><span class="line">key(32):29Bitå€¼:11001000001111101 - 11101</span><br><span class="line">value:yeah</span><br><span class="line">key(16):11Bitå€¼:1110001000100000001011 - 0</span><br><span class="line">key(32):11Bitå€¼:1110001000100000001011 - 1011</span><br><span class="line">value:uncle</span><br><span class="line">key(16):7Bitå€¼:110101001000011100101000111 - 0</span><br><span class="line">key(32):7Bitå€¼:110101001000011100101000111 - 111</span><br><span class="line">value:Java</span><br><span class="line">key(16):1Bitå€¼:1000110001111001100001 - 0</span><br><span class="line">key(32):1Bitå€¼:1000110001111001100001 - 1</span><br><span class="line">value:PHP</span><br><span class="line">key(16):9Bitå€¼:10011010101011001 - 10000</span><br><span class="line">key(32):25Bitå€¼:10011010101011001 - 11001</span><br><span class="line">value:C#</span><br><span class="line">key(16):0Bitå€¼:100001000000 - 0</span><br><span class="line">key(32):0Bitå€¼:100001000000 - 0</span><br><span class="line">value:C</span><br><span class="line">key(16):3Bitå€¼:1000011 - 0</span><br><span class="line">key(32):3Bitå€¼:1000011 - 11</span><br><span class="line">value:Python</span><br><span class="line">key(16):15Bitå€¼:10001111011000111001001110011111 - 10000</span><br><span class="line">key(32):31Bitå€¼:10001111011000111001001110011111 - 11111</span><br><span class="line">value:GO</span><br><span class="line">key(16):8Bitå€¼:100011101000 - 0</span><br><span class="line">key(32):8Bitå€¼:100011101000 - 1000</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬éšæœºä½¿ç”¨ä¸€äº›å­—ç¬¦ä¸²è®¡ç®—ä»–ä»¬åˆ†åˆ«åœ¨ 16 ä½é•¿åº¦å’Œ 32 ä½é•¿åº¦æ•°ç»„ä¸‹çš„ç´¢å¼•åˆ†é…æƒ…å†µï¼Œçœ‹å“ªäº›æ•°æ®è¢«é‡æ–°è·¯ç”±åˆ°äº†æ–°çš„åœ°å€<br>åŒæ—¶ï¼Œè¿™é‡Œè¿˜å¯ä»¥è§‚å¯Ÿå‡ºä¸€ä¸ªéå¸¸é‡è¦çš„ä¿¡æ¯ï¼ŒåŸå“ˆå¸Œå€¼ä¸æ‰©å®¹æ–°å¢å‡ºæ¥çš„é•¿åº¦ 16ï¼Œè¿›è¡Œ&amp;è¿ç®—ï¼Œå¦‚æœå€¼ç­‰äº 0ï¼Œåˆ™ä¸‹æ ‡ä½ç½®ä¸å˜ã€‚å¦‚æœä¸ä¸º 0ï¼Œé‚£ä¹ˆæ–°çš„ä½ç½®åˆ™æ˜¯åŸæ¥ä½ç½®ä¸ŠåŠ  16ã€‚å¤šæ¬¡æµ‹è¯•å‘ç°è¿™é‡Œçš„16å¯ä»¥æ‰©å±•ä¸º 2 çš„næ¬¡æ–¹ã€‚å³ï¼š<br><strong>åŸå“ˆå¸Œå€¼ï¼ˆæ‰°åŠ¨å“ˆå¸Œï¼‰ä¸æ‰©å®¹æ–°å¢å‡ºæ¥çš„é•¿åº¦</strong> <strong>2 çš„ n æ¬¡æ–¹ï¼Œè¿›è¡Œ&amp;è¿ç®—</strong></p><ul><li><strong>å¦‚æœå€¼ç­‰äº 0ï¼Œåˆ™ä¸‹æ ‡ä½ç½®ä¸å˜ã€‚</strong></li><li><strong>å¦‚æœä¸ä¸º 0ï¼Œé‚£ä¹ˆæ–°çš„ä½ç½®åˆ™æ˜¯åŸæ¥ä½ç½®ä¸ŠåŠ  16</strong></li></ul><p><strong>ç”±æ­¤å¯è§,java 8 çš„æ•£åˆ—å€¼æ‰°åŠ¨å‡½æ•°ï¼Œåœ¨ä¼˜åŒ–æ•£åˆ—æ•ˆæœçš„åŒæ—¶ï¼Œä¹Ÿè®©æ‰©å®¹å…ƒç´ å˜å¾—æ›´åŠ çš„æ–¹ä¾¿ã€‚</strong></p>]]></content>
      
      
      <categories>
          
          <category> æˆ‘çš„å­¦ä¹ æ—¥è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SnowFlakeç®—æ³•</title>
      <link href="/posts/9a32a87d.html"/>
      <url>/posts/9a32a87d.html</url>
      
        <content type="html"><![CDATA[<p>snowflakeæ˜¯Twitterå¼€æºçš„åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•ï¼Œç»“æœæ˜¯ä¸€ä¸ªlongå‹çš„IDã€‚</p><p>å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä½¿ç”¨41bitä½œä¸ºæ¯«ç§’æ•°ï¼Œ10bitä½œä¸ºæœºå™¨çš„IDï¼ˆ5ä¸ªbitæ˜¯æ•°æ®ä¸­å¿ƒï¼Œ5ä¸ªbitçš„æœºå™¨IDï¼‰ï¼Œ12bitä½œä¸ºæ¯«ç§’å†…çš„æµæ°´å·ï¼ˆæ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹åœ¨æ¯æ¯«ç§’å¯ä»¥äº§ç”Ÿ 4096 ä¸ª IDï¼‰ï¼Œæœ€åè¿˜æœ‰ä¸€ä¸ªç¬¦å·ä½ï¼Œæ°¸è¿œæ˜¯0ã€‚</p><h2 id="å…·ä½“ä»‹ç»"><a href="#å…·ä½“ä»‹ç»" class="headerlink" title="å…·ä½“ä»‹ç»"></a>å…·ä½“ä»‹ç»</h2><p>é›ªèŠ±ç®—æ³•æ˜¯ 64 ä½ çš„äºŒè¿›åˆ¶ï¼Œä¸€å…±åŒ…å«äº†å››éƒ¨åˆ†ï¼š</p><ul><li>1ä½æ˜¯ç¬¦å·ä½ï¼Œä¹Ÿå°±æ˜¯æœ€é«˜ä½ï¼Œå§‹ç»ˆæ˜¯0ï¼Œæ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œå› ä¸ºè¦æ˜¯å”¯ä¸€è®¡ç®—æœºäºŒè¿›åˆ¶è¡¥ç ä¸­å°±æ˜¯è´Ÿæ•°ï¼Œ0æ‰æ˜¯æ­£æ•°ã€‚</li><li>41ä½æ˜¯æ—¶é—´æˆ³ï¼Œå…·ä½“åˆ°æ¯«ç§’ï¼Œ41ä½çš„äºŒè¿›åˆ¶å¯ä»¥ä½¿ç”¨69å¹´ï¼Œå› ä¸ºæ—¶é—´ç†è®ºä¸Šæ°¸æ’é€’å¢ï¼Œæ‰€ä»¥æ ¹æ®è¿™ä¸ªæ’åºæ˜¯å¯ä»¥çš„ã€‚</li><li>10ä½æ˜¯æœºå™¨æ ‡è¯†ï¼Œå¯ä»¥å…¨éƒ¨ç”¨ä½œæœºå™¨IDï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ ‡è¯†æœºæˆ¿ID + æœºå™¨IDï¼Œ10ä½æœ€å¤šå¯ä»¥è¡¨ç¤º1024å°æœºå™¨ã€‚</li><li>12ä½æ˜¯è®¡æ•°åºåˆ—å·ï¼Œä¹Ÿå°±æ˜¯åŒä¸€å°æœºå™¨ä¸ŠåŒä¸€æ—¶é—´ï¼Œç†è®ºä¸Šè¿˜å¯ä»¥åŒæ—¶ç”Ÿæˆä¸åŒçš„IDï¼Œ12ä½çš„åºåˆ—å·èƒ½å¤ŸåŒºåˆ†å‡º4096ä¸ªIDã€‚</li></ul><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/snowflake.png" alt="snowflake"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.domain.support.ids;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ray</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/12 16:18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> é›ªèŠ±ç®—æ³•ç”ŸæˆéšæœºID</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnowFlake</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SnowFlake.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ•°æ®ä¸­å¿ƒ(æœºæˆ¿)ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> dataCenterId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœºå™¨ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> workerId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒä¸€æ—¶é—´çš„åºåˆ—å·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> sequence;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼€å§‹æ—¶é—´æˆ³:2020-05-20 08:00:00 +0800 CST</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">twepoch</span> <span class="operator">=</span> <span class="number">1589923200000L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœºæˆ¿IDæ‰€å ä½æ•° 5bit æœ€å¤§:11111(äºŒè¿›åˆ¶)--&gt;31(åè¿›åˆ¶)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">dataCenterIdBits</span> <span class="operator">=</span> <span class="number">5L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœºå™¨IDæ‰€å ä½æ•° 5bit æœ€å¤§:11111(äºŒè¿›åˆ¶)--&gt;31(åè¿›åˆ¶)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">workerIdBits</span> <span class="operator">=</span> <span class="number">5L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒä¸€æ—¶é—´çš„åºåˆ—å·æ‰€å ä½æ•° 12bit æœ€å¤§:111111111111(äºŒè¿›åˆ¶)--&gt;4095(åè¿›åˆ¶)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">sequenceBits</span> <span class="operator">=</span> <span class="number">12L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 5 bitæœ€å¤šåªèƒ½æœ‰31ä¸ªæ•°å­—ï¼Œå³æœºæˆ¿idæ•°é‡æœ€å¤šåªèƒ½æ˜¯32ä»¥å†…</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">maxDataCenterId</span> <span class="operator">=</span> -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; dataCenterIdBits);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 5 bitæœ€å¤šåªèƒ½æœ‰31ä¸ªæ•°å­—ï¼Œå³æœºå™¨idæ•°é‡æœ€å¤šåªèƒ½æ˜¯32ä»¥å†…</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">maxWorkerId</span> <span class="operator">=</span> -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; workerIdBits);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åºåˆ—å·æ©ç (0b111111111111==&gt;0xfff==&gt;4096)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">sequenceMask</span> <span class="operator">=</span> -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; sequenceBits);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœºå™¨IDåç§»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">workerIdShift</span> <span class="operator">=</span> sequenceBits;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœºæˆ¿IDåç§»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">dataCenterIdShift</span> <span class="operator">=</span> workerIdBits + sequenceBits;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ—¶é—´æˆ³åç§»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timestampLeftShift</span> <span class="operator">=</span> dataCenterIdBits + workerIdBits + sequenceBits;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ€è¿‘ä¸€æ¬¡æ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastTimestamp</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SnowFlake</span><span class="params">(<span class="type">long</span> dataCenterId, <span class="type">long</span> workerId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(dataCenterId,workerId,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SnowFlake</span><span class="params">(<span class="type">long</span> dataCenterId, <span class="type">long</span> workerId, <span class="type">long</span> sequence)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( dataCenterId&gt;maxDataCenterId || dataCenterId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;æœºæˆ¿ID å¤§äºæœ€å¤§å€¼ %d æˆ–è€… å°äº 0&quot;</span>,maxDataCenterId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( workerId&gt;maxWorkerId || workerId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;æœºå™¨ID å¤§äºæœ€å¤§å€¼ %d æˆ–è€… å°äº 0&quot;</span>,maxWorkerId));</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">&quot;æœºå™¨å¯åŠ¨ä¸­: æ—¶é—´æˆ³åç§»é‡:&#123;&#125;,æœºæˆ¿IDå ä½:&#123;&#125;,æœºå™¨IDå ä½:&#123;&#125;,åºåˆ—å·å ä½:&#123;&#125;,æœºå™¨ID:&#123;&#125;&quot;</span>,</span><br><span class="line">                timestampLeftShift,dataCenterIdBits,workerIdBits,sequenceBits,workerId);</span><br><span class="line">        <span class="built_in">this</span>.dataCenterId = dataCenterId;</span><br><span class="line">        <span class="built_in">this</span>.workerId = workerId;</span><br><span class="line">        <span class="built_in">this</span>.sequence = sequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æœºæˆ¿ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æœºæˆ¿ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getDataCenterId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dataCenterId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æœºå™¨ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æœºå™¨ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getWorkerId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> workerId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æœ€æ–°çš„æ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ä¸Šä¸€æ¬¡ç”ŸæˆIDçš„æ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getLastTimestamp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> lastTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ä¸‹ä¸€ä¸ªéšæœºID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> éšæœºID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTimestamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentTimestamp &lt; lastTimestamp) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;æ—¶é—´å›é€€,æœ€æ–°æ—¶é—´æˆ³:&#123;&#125;&quot;</span>,lastTimestamp);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(String.format(<span class="string">&quot;æ—¶é—´å›é€€,æ‹’ç»ç”ŸæˆID,å®é™…ç›¸å·®: %d&quot;</span>,lastTimestamp - currentTimestamp));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å»é‡</span></span><br><span class="line">        <span class="keyword">if</span> (currentTimestamp == lastTimestamp) &#123;</span><br><span class="line">            sequence = (sequenceMask+<span class="number">1</span>) &amp; sequenceMask;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœ sequence åºåˆ—å· å¤§äº 4095</span></span><br><span class="line">            <span class="keyword">if</span>(sequence == <span class="number">0</span>) &#123;</span><br><span class="line">                currentTimestamp = nextTimestamp(lastTimestamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯å½“å‰æ—¶é—´ç¬¬ä¸€æ¬¡ç”ŸæˆID,å°±åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">            sequence = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®°å½•æœ€æ–°æ—¶é—´æˆ³</span></span><br><span class="line">        lastTimestamp = currentTimestamp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åç§»è®¡ç®—ç”ŸæˆéšæœºID</span></span><br><span class="line">        <span class="keyword">return</span> ((currentTimestamp - twepoch) &lt;&lt; timestampLeftShift) |</span><br><span class="line">                (dataCenterId &lt;&lt; dataCenterIdShift) |</span><br><span class="line">                (workerId &lt;&lt; workerIdShift) |</span><br><span class="line">                sequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">nextTimestamp</span><span class="params">(<span class="type">long</span> lastTimestamp)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTimestamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰æ—¶é—´æˆ³å°äºç­‰äº åºåˆ—å·å·²ç»è¶…è¿‡4095 é‚£ä¸ªæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="comment">// ç»§ç»­è·å–æœ€æ–°æ—¶é—´æˆ³</span></span><br><span class="line">        <span class="keyword">if</span> (currentTimestamp &lt;= lastTimestamp) &#123;</span><br><span class="line">            currentTimestamp = System.currentTimeMillis();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> currentTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/snowflake_shift.png" alt="snowflake_shift"></p><ul><li>æœ€åå°†ä¸‰éƒ¨åˆ†(æ—¶é—´æˆ³ã€æœºå™¨IDã€åºåˆ—å·)æŒ‰ç…§åç§»é‡è¿›è¡Œç§»ä½æ“ä½œï¼Œç„¶åæŒ‰ä½æˆ–å°†å…¶ç»„åˆå³å¯å¾—åˆ°éšæœºç”Ÿæˆçš„å”¯ä¸€ID</li></ul><h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><ul><li><p>ç”±äº41ä½æ˜¯æ—¶é—´æˆ³ï¼Œæˆ‘ä»¬çš„æ—¶é—´è®¡ç®—æ˜¯ä»1970å¹´å¼€å§‹çš„ï¼Œåªèƒ½ä½¿ç”¨69å¹´ï¼Œä¸ºäº†ä¸æµªè´¹ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥ç”¨æ—¶é—´çš„ç›¸å¯¹å€¼ï¼Œä¹Ÿå°±æ˜¯ä»¥é¡¹ç›®å¼€å§‹çš„æ—¶é—´ä¸ºåŸºå‡†æ—¶é—´ï¼Œå¾€åå¯ä»¥ä½¿ç”¨69å¹´ã€‚è·å–å”¯ä¸€IDçš„æœåŠ¡ï¼Œå¯¹å¤„ç†é€Ÿåº¦è¦æ±‚æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å…¨éƒ¨ä½¿ç”¨ä½è¿ç®—ä»¥åŠä½ç§»æ“ä½œï¼Œè·å–å½“å‰æ—¶é—´å¯ä»¥ä½¿ç”¨<code>System.currentTimeMillis()</code>ã€‚</p></li><li><h3 id="æ—¶é—´å›æ‹¨é—®é¢˜"><a href="#æ—¶é—´å›æ‹¨é—®é¢˜" class="headerlink" title="æ—¶é—´å›æ‹¨é—®é¢˜"></a>æ—¶é—´å›æ‹¨é—®é¢˜</h3><p>åœ¨è·å–æ—¶é—´çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°<code>æ—¶é—´å›æ‹¨</code>çš„é—®é¢˜ï¼Œæ—¶é—´å›æ‹¨å…¶å®å°±æ˜¯æœåŠ¡å™¨ä¸Šçš„æ—¶é—´çªç„¶å€’é€€åˆ°ä¹‹å‰çš„æ—¶é—´ã€‚</p><ol><li>äººä¸ºåŸå› ï¼ŒæŠŠç³»ç»Ÿç¯å¢ƒçš„æ—¶é—´æ”¹äº†ã€‚</li><li>æœ‰æ—¶å€™ä¸åŒçš„æœºå™¨ä¸Šéœ€è¦åŒæ­¥æ—¶é—´ï¼Œå¯èƒ½ä¸åŒæœºå™¨ä¹‹é—´å­˜åœ¨è¯¯å·®ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå‡ºç°æ—¶é—´å›æ‹¨é—®é¢˜ã€‚</li></ol><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><ol><li>å›æ‹¨æ—¶é—´å°çš„æ—¶å€™ï¼Œä¸ç”Ÿæˆ IDï¼Œå¾ªç¯ç­‰å¾…åˆ°æ—¶é—´ç‚¹åˆ°è¾¾ã€‚</li><li>ä¸Šé¢çš„æ–¹æ¡ˆåªé€‚åˆæ—¶é’Ÿå›æ‹¨è¾ƒå°çš„ï¼Œå¦‚æœé—´éš”è¿‡å¤§ï¼Œé˜»å¡ç­‰å¾…ï¼Œè‚¯å®šæ˜¯ä¸å¯å–çš„ï¼Œå› æ­¤è¦ä¹ˆè¶…è¿‡ä¸€å®šå¤§å°çš„å›æ‹¨ç›´æ¥æŠ¥é”™ï¼Œæ‹’ç»æœåŠ¡ï¼Œæˆ–è€…æœ‰ä¸€ç§æ–¹æ¡ˆæ˜¯åˆ©ç”¨æ‹“å±•ä½ï¼Œå›æ‹¨ä¹‹ååœ¨æ‹“å±•ä½ä¸ŠåŠ 1å°±å¯ä»¥äº†ï¼Œè¿™æ ·IDä¾ç„¶å¯ä»¥ä¿æŒå”¯ä¸€ã€‚ä½†æ˜¯è¿™ä¸ªè¦æ±‚æˆ‘ä»¬æå‰é¢„ç•™å‡ºä½æ•°ï¼Œè¦ä¹ˆä»æœºå™¨idä¸­ï¼Œè¦ä¹ˆä»åºåˆ—å·ä¸­ï¼Œè…¾å‡ºä¸€å®šçš„ä½ï¼Œåœ¨æ—¶é—´å›æ‹¨çš„æ—¶å€™ï¼Œè¿™ä¸ªä½ç½® <code>+1</code>ã€‚</li></ol></li></ul><h2 id="ç›¸å…³é—®é¢˜"><a href="#ç›¸å…³é—®é¢˜" class="headerlink" title="ç›¸å…³é—®é¢˜"></a>ç›¸å…³é—®é¢˜</h2><h3 id="1-ç¬¬ä¸€ä½ä¸ºä»€ä¹ˆä¸ä½¿ç”¨"><a href="#1-ç¬¬ä¸€ä½ä¸ºä»€ä¹ˆä¸ä½¿ç”¨" class="headerlink" title="1. ç¬¬ä¸€ä½ä¸ºä»€ä¹ˆä¸ä½¿ç”¨?"></a>1. ç¬¬ä¸€ä½ä¸ºä»€ä¹ˆä¸ä½¿ç”¨?</h3><p>åœ¨è®¡ç®—æœºçš„è¡¨ç¤ºä¸­ï¼Œç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½ï¼Œ0è¡¨ç¤ºæ•´æ•°ï¼Œç¬¬ä¸€ä½å¦‚æœæ˜¯1åˆ™è¡¨ç¤ºè´Ÿæ•°ï¼Œæˆ‘ä»¬ç”¨çš„IDé»˜è®¤å°±æ˜¯æ­£æ•°ï¼Œæ‰€ä»¥é»˜è®¤å°±æ˜¯0ï¼Œé‚£ä¹ˆè¿™ä¸€ä½é»˜è®¤å°±æ²¡æœ‰æ„ä¹‰ã€‚</p><h3 id="2-æœºå™¨ä½æ€ä¹ˆç”¨ï¼Ÿ"><a href="#2-æœºå™¨ä½æ€ä¹ˆç”¨ï¼Ÿ" class="headerlink" title="2.æœºå™¨ä½æ€ä¹ˆç”¨ï¼Ÿ"></a>2.æœºå™¨ä½æ€ä¹ˆç”¨ï¼Ÿ</h3><p>æœºå™¨ä½æˆ–è€…æœºæˆ¿ä½ï¼Œä¸€å…±10 bitï¼Œå¦‚æœå…¨éƒ¨è¡¨ç¤ºæœºå™¨ï¼Œé‚£ä¹ˆå¯ä»¥è¡¨ç¤º1024å°æœºå™¨ï¼Œå¦‚æœæ‹†åˆ†ï¼Œ5 bit è¡¨ç¤ºæœºæˆ¿ï¼Œ5bitè¡¨ç¤ºæœºæˆ¿é‡Œé¢çš„æœºå™¨ï¼Œé‚£ä¹ˆå¯ä»¥æœ‰32ä¸ªæœºæˆ¿ï¼Œæ¯ä¸ªæœºæˆ¿å¯ä»¥ç”¨32å°æœºå™¨ã€‚</p><h3 id="3-twepochè¡¨ç¤ºä»€ä¹ˆï¼Ÿ"><a href="#3-twepochè¡¨ç¤ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="3. twepochè¡¨ç¤ºä»€ä¹ˆï¼Ÿ"></a>3. twepochè¡¨ç¤ºä»€ä¹ˆï¼Ÿ</h3><p>ç”±äºæ—¶é—´æˆ³åªèƒ½ç”¨69å¹´ï¼Œæˆ‘ä»¬çš„è®¡æ—¶åˆæ˜¯ä»1970å¹´å¼€å§‹çš„ï¼Œæ‰€ä»¥è¿™ä¸ª<code>twepoch</code>è¡¨ç¤ºä»é¡¹ç›®å¼€å§‹çš„æ—¶é—´ï¼Œç”¨ç”ŸæˆIDçš„æ—¶é—´å‡å»<code>twepoch</code>ä½œä¸ºæ—¶é—´æˆ³ï¼Œå¯ä»¥ä½¿ç”¨æ›´ä¹…ã€‚</p><h3 id="4-1L-1L-lt-lt-x-è¡¨ç¤ºä»€ä¹ˆï¼Ÿ"><a href="#4-1L-1L-lt-lt-x-è¡¨ç¤ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="4. -1L ^ (-1L &lt;&lt; x) è¡¨ç¤ºä»€ä¹ˆï¼Ÿ"></a>4. -1L ^ (-1L &lt;&lt; x) è¡¨ç¤ºä»€ä¹ˆï¼Ÿ</h3><p>è¡¨ç¤º x ä½äºŒè¿›åˆ¶å¯ä»¥è¡¨ç¤ºå¤šå°‘ä¸ªæ•°å€¼ï¼Œå‡è®¾xä¸º3ï¼š</p><p>åœ¨è®¡ç®—æœºä¸­ï¼Œç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½ï¼Œè´Ÿæ•°çš„åç æ˜¯é™¤äº†ç¬¦å·ä½ï¼Œ1å˜0ï¼Œ0å˜1, è€Œè¡¥ç åˆ™æ˜¯åç +1ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-1L åŸç ï¼š1000 0001</span><br><span class="line">-1L åç ï¼š1111 1110</span><br><span class="line">-1L è¡¥ç ï¼š1111 1111</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çŸ¥é“ï¼Œ<strong>-1Lå…¶å®åœ¨äºŒè¿›åˆ¶é‡Œé¢å…¶å®å°±æ˜¯å…¨éƒ¨ä¸º1</strong>,é‚£ä¹ˆ -1L å·¦ç§»åŠ¨ 3ä½ï¼Œå…¶å®å¾—åˆ° <code>1111 1000</code>ï¼Œä¹Ÿå°±æ˜¯æœ€å3ä½æ˜¯0ï¼Œå†ä¸<code>-1L</code>å¼‚æˆ–è®¡ç®—ä¹‹åï¼Œå…¶å®å¾—åˆ°çš„ï¼Œå°±æ˜¯åé¢3ä½å…¨æ˜¯1ã€‚</p><p><code>-1L ^ (-1L &lt;&lt; x)</code>è¡¨ç¤ºçš„å…¶å®å°±æ˜¯xä½å…¨æ˜¯1çš„å€¼ï¼Œä¹Ÿå°±æ˜¯xä½çš„äºŒè¿›åˆ¶èƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼ã€‚</p><h3 id="5-æ—¶é—´æˆ³æ¯”è¾ƒ"><a href="#5-æ—¶é—´æˆ³æ¯”è¾ƒ" class="headerlink" title="5.æ—¶é—´æˆ³æ¯”è¾ƒ"></a>5.æ—¶é—´æˆ³æ¯”è¾ƒ</h3><p>åœ¨è·å–æ—¶é—´æˆ³å°äºä¸Šä¸€æ¬¡è·å–çš„æ—¶é—´æˆ³çš„æ—¶å€™ï¼Œä¸èƒ½ç”ŸæˆIDï¼Œè€Œæ˜¯ç»§ç»­å¾ªç¯ï¼Œç›´åˆ°ç”Ÿæˆå¯ç”¨çš„IDï¼Œè¿™é‡Œæ²¡æœ‰ä½¿ç”¨æ‹“å±•ä½é˜²æ­¢æ—¶é’Ÿå›æ‹¨ã€‚</p><h3 id="6-å‰ç«¯ç›´æ¥ä½¿ç”¨å‘ç”Ÿç²¾åº¦ä¸¢å¤±"><a href="#6-å‰ç«¯ç›´æ¥ä½¿ç”¨å‘ç”Ÿç²¾åº¦ä¸¢å¤±" class="headerlink" title="6.å‰ç«¯ç›´æ¥ä½¿ç”¨å‘ç”Ÿç²¾åº¦ä¸¢å¤±"></a>6.å‰ç«¯ç›´æ¥ä½¿ç”¨å‘ç”Ÿç²¾åº¦ä¸¢å¤±</h3><p>å¦‚æœå‰ç«¯ç›´æ¥ä½¿ç”¨æœåŠ¡ç«¯ç”Ÿæˆçš„ long ç±»å‹ idï¼Œä¼šå‘ç”Ÿç²¾åº¦ä¸¢å¤±çš„é—®é¢˜ï¼Œå› ä¸º JS ä¸­Numberæ˜¯16ä½çš„ï¼ˆæŒ‡çš„æ˜¯åè¿›åˆ¶çš„æ•°å­—ï¼‰ï¼Œè€Œé›ªèŠ±ç®—æ³•è®¡ç®—å‡ºæ¥æœ€é•¿çš„æ•°å­—æ˜¯19ä½çš„ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦ç”¨ String ä½œä¸ºä¸­é—´è½¬æ¢ï¼Œè¾“å‡ºåˆ°å‰ç«¯å³å¯ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ‰‹å†™Spring</title>
      <link href="/posts/8cc15261.html"/>
      <url>/posts/8cc15261.html</url>
      
        <content type="html"><![CDATA[<h1 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h1><h2 id="Step01ï¼šåˆ›å»ºç®€å•çš„Beanå®¹å™¨"><a href="#Step01ï¼šåˆ›å»ºç®€å•çš„Beanå®¹å™¨" class="headerlink" title="Step01ï¼šåˆ›å»ºç®€å•çš„Beanå®¹å™¨"></a>Step01ï¼šåˆ›å»ºç®€å•çš„Beanå®¹å™¨</h2><h3 id="å‡†å¤‡ï¼š"><a href="#å‡†å¤‡ï¼š" class="headerlink" title="å‡†å¤‡ï¼š"></a>å‡†å¤‡ï¼š</h3><ol><li>IOCï¼šæ§åˆ¶åè½¬ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªå¯¹è±¡å®šä¹‰å…¶ä¾èµ–å…³ç³»è€Œä¸åˆ›å»ºå®ƒä»¬çš„è¿‡ç¨‹ã€‚ </li><li>Beanè§„èŒƒï¼šæ‰€æœ‰å±æ€§éƒ½æ˜¯privateï¼Œæä¾›é»˜è®¤æ„é€ ã€getterã€setteræ–¹æ³•çš„å…¬å…±ç±»ã€‚</li><li>Beanï¼šæ˜¯ç¬¦åˆBeanè§„èŒƒçš„Javaå¯¹è±¡ã€‚ </li><li>Spring Bean å®¹å™¨ï¼šç®¡ç†å¯¹è±¡åŠå…¶ä¾èµ–ï¼Œä»¥åŠä¾èµ–çš„æ³¨å…¥ã€‚ </li></ol><h3 id="è®¾è®¡ï¼š"><a href="#è®¾è®¡ï¼š" class="headerlink" title="è®¾è®¡ï¼š"></a>è®¾è®¡ï¼š</h3><p>Spring Bean å®¹å™¨åœºæ™¯ä¸‹ï¼Œé€‰æ‹©HashMapä½œä¸ºå­˜æ”¾æ•°æ®çš„å…·ä½“æ•°æ®ç»“æ„ã€‚ </p><ol><li>å®šä¹‰Bean </li><li>æ³¨å†ŒBean </li><li>æ ¹æ®keyå€¼è·å–Bean</li></ol><h3 id="å®ç°ï¼š"><a href="#å®ç°ï¼š" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><p>BeanDefinition ï¼š</p><ol><li>å®šä¹‰Bean ï¼š å®šä¹‰ä¸€ä¸ªObjectç±»å‹å­˜æ”¾å¯¹è±¡ï¼Œé€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥ </li></ol><p>BeanFactoryï¼š</p><ol><li>æ³¨å†ŒBeanï¼šé€šè¿‡ HashMap å­˜æ”¾å®šä¹‰å¥½çš„Beanå³ BeanDefinition</li><li>è·å–Beanï¼šé€šè¿‡ key å€¼ å³ Bean çš„åå­—ï¼Œå–å‡ºæ³¨å†Œå¥½çš„Bean</li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step01.png" alt="step01"></p><h3 id="æµ‹è¯•ï¼š"><a href="#æµ‹è¯•ï¼š" class="headerlink" title="æµ‹è¯•ï¼š"></a>æµ‹è¯•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_beanFactory</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–Beanå·¥å‚</span></span><br><span class="line">        <span class="type">BeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanFactory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰ bean</span></span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(<span class="keyword">new</span> <span class="title class_">UserService</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å†Œ bean</span></span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;userService&quot;</span>,beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–bean</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) beanFactory.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line"></span><br><span class="line">        userService.queryUserInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Step02ï¼šå®ç°Beançš„å®šä¹‰ã€æ³¨å†Œã€è·å–"><a href="#Step02ï¼šå®ç°Beançš„å®šä¹‰ã€æ³¨å†Œã€è·å–" class="headerlink" title="Step02ï¼šå®ç°Beançš„å®šä¹‰ã€æ³¨å†Œã€è·å–"></a>Step02ï¼šå®ç°Beançš„å®šä¹‰ã€æ³¨å†Œã€è·å–</h2><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step02.png" alt="step02"></p><h3 id="æµ‹è¯•ï¼š-1"><a href="#æµ‹è¯•ï¼š-1" class="headerlink" title="æµ‹è¯•ï¼š"></a>æµ‹è¯•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_beanFactory</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–Beanå·¥å‚</span></span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultListableBeanFactory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰ bean</span></span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(UserService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å†Œ bean</span></span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;userService&quot;</span>,beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–bean</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) beanFactory.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line"></span><br><span class="line">        userService.queryUserInfo();</span><br><span class="line"></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService_singleton</span> <span class="operator">=</span> (UserService) beanFactory.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line"></span><br><span class="line">        userService_singleton.queryUserInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Step03ï¼šè§£å†³å«æœ‰æ„é€ å‡½æ•°çš„Beanå¯¹è±¡çš„å®ä¾‹åŒ–ï¼ŒåŠ å…¥å¯¹è±¡å®ä¾‹åŒ–ç­–ç•¥"><a href="#Step03ï¼šè§£å†³å«æœ‰æ„é€ å‡½æ•°çš„Beanå¯¹è±¡çš„å®ä¾‹åŒ–ï¼ŒåŠ å…¥å¯¹è±¡å®ä¾‹åŒ–ç­–ç•¥" class="headerlink" title="Step03ï¼šè§£å†³å«æœ‰æ„é€ å‡½æ•°çš„Beanå¯¹è±¡çš„å®ä¾‹åŒ–ï¼ŒåŠ å…¥å¯¹è±¡å®ä¾‹åŒ–ç­–ç•¥"></a>Step03ï¼šè§£å†³å«æœ‰æ„é€ å‡½æ•°çš„Beanå¯¹è±¡çš„å®ä¾‹åŒ–ï¼ŒåŠ å…¥å¯¹è±¡å®ä¾‹åŒ–ç­–ç•¥</h2><h3 id="å®ç°ï¼š-1"><a href="#å®ç°ï¼š-1" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>åœ¨BeanFactoryä¸Šé‡è½½getBeanå‡½æ•°ï¼Œå¢åŠ æ„é€ å‡½æ•°çš„å…¥å‚ä¿¡æ¯ï¼Œæ–¹ä¾¿å®ä¾‹åŒ–ã€‚ </p></li><li><p>åˆ›å»ºå®ä¾‹åŒ–ç­–ç•¥æ¥å£ï¼Œç›®å‰æœ‰ä¸¤ç§æ–¹å¼ï¼šJDKè‡ªå¸¦çš„æ–¹æ³•DeclaredConstructorå’ŒCglibåŠ¨æ€åˆ›å»º </p></li><li><p>å®šä¹‰ä¸¤ç§å®ä¾‹åŒ–ç­–ç•¥çš„å…·ä½“å®ç°ã€‚ </p></li><li><p>åˆ›å»ºç­–ç•¥è°ƒç”¨ï¼Œé¦–å…ˆé€šè¿‡beanClass.getDeclaredConstructors()è·å–beanå¯¹è±¡çš„æ‰€æœ‰æ„é€ å‡½æ•°ï¼Œè¿™é‡Œç®€å•æ¯”å¯¹å…¥å‚ä¸ªæ•°ä¸æ„é€ å‡½æ•°çš„å‚æ•°ä¸ªæ•°æ˜¯å¦ä¸€è‡´ï¼Œæ¥é€‰æ‹©éœ€è¦å…·ä½“å®ä¾‹åŒ–çš„å¯¹è±¡ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createBeanInstance</span><span class="params">(BeanDefinition beanDefinition, String beanName, Object[] args)</span> &#123;</span><br><span class="line">  <span class="type">Constructor</span> <span class="variable">constructorToUse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  Class&lt;?&gt; beanClass = beanDefinition.getBeanClass();</span><br><span class="line">  Constructor&lt;?&gt;[] declaredConstructors = beanClass.getDeclaredConstructors(); <span class="comment">// è·å–æ‰€æœ‰æ„é€ å‡½æ•°</span></span><br><span class="line">  <span class="keyword">for</span> (Constructor ctor : declaredConstructors) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != args &amp;&amp; ctor.getParameterTypes().length == args.length) &#123; <span class="comment">// ç®€å•æ¯”å¯¹å…¥å‚ä¸ªæ•°</span></span><br><span class="line">      constructorToUse = ctor;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> getInstantiationStrategy().instantiate(beanDefinition, beanName, constructorToUse, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š"><a href="#ç»“æœï¼š" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><ol><li>é€šè¿‡ç¬¬ä¸‰ç« å’Œç¬¬å››ç« çš„å­¦ä¹ ï¼Œæ„Ÿå—åˆ°äº†ä¸€ä¸ªå¥½çš„ä»£ç ç»“æ„è®¾è®¡å¯¹äºæ•´ä¸ªå·¥ç¨‹çš„é‡è¦æ€§ï¼Œè¿™ç›´æ¥å†³å®šåæœŸç»´æŠ¤ä¸æ‰©å±•æ˜¯å¦å¯è¡Œä¾¿åˆ©ã€‚</li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step03.png" alt="step03"></p><h2 id="Step04ï¼šè§£å†³å«æœ‰å±æ€§çš„Beanå¯¹è±¡çš„å®ä¾‹åŒ–ï¼Œåœ¨å®ä¾‹åŒ–ä¹‹åå¡«å……å±æ€§"><a href="#Step04ï¼šè§£å†³å«æœ‰å±æ€§çš„Beanå¯¹è±¡çš„å®ä¾‹åŒ–ï¼Œåœ¨å®ä¾‹åŒ–ä¹‹åå¡«å……å±æ€§" class="headerlink" title="Step04ï¼šè§£å†³å«æœ‰å±æ€§çš„Beanå¯¹è±¡çš„å®ä¾‹åŒ–ï¼Œåœ¨å®ä¾‹åŒ–ä¹‹åå¡«å……å±æ€§"></a>Step04ï¼šè§£å†³å«æœ‰å±æ€§çš„Beanå¯¹è±¡çš„å®ä¾‹åŒ–ï¼Œåœ¨å®ä¾‹åŒ–ä¹‹åå¡«å……å±æ€§</h2><h3 id="å®ç°ï¼š-2"><a href="#å®ç°ï¼š-2" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li>å®šä¹‰å±æ€§ç±»PropertyValueä»¥åŠPropertyValuesï¼Œç”¨äºä¼ é€’Beanå¯¹è±¡ä¸­çš„å±æ€§ä¿¡æ¯ã€‚</li><li>å®šä¹‰Beanå¯¹è±¡å¼•ç”¨ç±»BeanReferenceï¼Œç”¨äºåç»­å¯¹è±¡å±æ€§ä¸ºbeanå¯¹è±¡æ—¶çš„å®ä¾‹åŒ–ä»¥åŠå±æ€§å¡«å……ã€‚ </li><li>è¡¥å…¨Beanå®šä¹‰ï¼ŒåŠ å…¥PropertyValueså±æ€§ï¼Œä¾¿äºBeanæ³¨å†Œæ—¶ä¼ é€’å±æ€§ä¿¡æ¯ã€‚ </li><li>åœ¨å¯¹è±¡å®ä¾‹åŒ–ä¹‹åï¼Œé€šè¿‡å…¶å®šä¹‰ä¿¡æ¯è·å–å±æ€§åˆ—è¡¨ï¼Œå¾ªç¯è¿›è¡Œå¡«å……æ“ä½œã€‚å½“é‡åˆ°BeanReferenceæ—¶ï¼Œå³å­˜åœ¨ä¾èµ–æ—¶ï¼Œéœ€è¦é€’å½’è·å–è¯¥å¼•ç”¨çš„å®ä¾‹åŒ–ï¼Œè¿›è€Œå¡«å……å±æ€§ã€‚ </li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bean å±æ€§å¡«å……</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">applyPropertyValues</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">PropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> beanDefinition.getPropertyValues();</span><br><span class="line">    <span class="keyword">for</span> (PropertyValue propertyValue : propertyValues.getPropertyValues()) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> propertyValue.getName();</span><br><span class="line">      <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> propertyValue.getValue();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BeanReference) &#123;</span><br><span class="line">        <span class="comment">// A ä¾èµ– Bï¼Œè·å– B çš„å®ä¾‹åŒ–</span></span><br><span class="line">        <span class="type">BeanReference</span> <span class="variable">beanReference</span> <span class="operator">=</span> (BeanReference) value;</span><br><span class="line">        value = getBean(beanReference.getBeanName());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å±æ€§å¡«å……</span></span><br><span class="line">      BeanUtil.setFieldValue(bean, name, value);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Error setting property valuesï¼š&quot;</span> + beanName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ï¼š-2"><a href="#æµ‹è¯•ï¼š-2" class="headerlink" title="æµ‹è¯•ï¼š"></a>æµ‹è¯•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_BeanFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1.åˆå§‹åŒ– BeanFactory</span></span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultListableBeanFactory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. UserDao æ³¨å†Œ</span></span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;userDao&quot;</span>, <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(UserDao.class));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. UserService è®¾ç½®å±æ€§[uIdã€userDao]</span></span><br><span class="line">        <span class="type">PropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyValues</span>();</span><br><span class="line">        propertyValues.addPropertyValue(<span class="keyword">new</span> <span class="title class_">PropertyValue</span>(<span class="string">&quot;uId&quot;</span>, <span class="string">&quot;10002&quot;</span>));</span><br><span class="line">        propertyValues.addPropertyValue(<span class="keyword">new</span> <span class="title class_">PropertyValue</span>(<span class="string">&quot;userDao&quot;</span>,<span class="keyword">new</span> <span class="title class_">BeanReference</span>(<span class="string">&quot;userDao&quot;</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. UserService æ³¨å…¥bean</span></span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(UserService.class, propertyValues);</span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;userService&quot;</span>, beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. UserService è·å–bean</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) beanFactory.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        userService.queryUserInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»“æœï¼š-1"><a href="#ç»“æœï¼š-1" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><ol><li><p>åœ¨æœ€åæµ‹è¯•ä¸­ï¼ŒæŠ¥å‡ºå¼‚å¸¸  <em>Instantiation of bean failed</em>  ï¼Œç»è¿‡å•æ­¥è°ƒè¯•ä¹‹åï¼Œå‘ç°æ˜¯ç”±äºå­˜åœ¨ä¾èµ–å…³ç³»(Aä¾èµ–äºB)ï¼Œé€’å½’è·å–å®ä¾‹åŒ–æ—¶ï¼Œå› ä¸º B æ³¨å†Œ Bean å®šä¹‰ä¿¡æ¯æ—¶å¹¶æ— å±æ€§åˆ—è¡¨ï¼Œä»è€Œå¯¼è‡´å¡«å……å±æ€§è·å–å±æ€§åˆ—è¡¨æ—¶ï¼ŒæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå¯¼è‡´  <em>Error setting property values</em> å¼‚å¸¸ï¼Œè¿›è€ŒæŠ›å‡º ä¸Šçº§å¼‚å¸¸ <em>Instantiation of bean failed</em> ã€‚å‘ç°é—®é¢˜ä¹‹åï¼Œç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„ if..else ï¼Œç»“æœä¹Ÿæ˜¯æˆåŠŸè¾“å‡ºã€‚å›è¿‡å¤´æ¥çœ‹ï¼Œå¯ä»¥åœ¨ BeanDefinition çš„æ„é€ å‡½æ•°ä¸Šåšä¼˜åŒ–ï¼Œå½“æ²¡æœ‰å±æ€§åˆ—è¡¨æˆ–å±æ€§åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œç›´æ¥new å®ä¾‹åŒ–å±æ€§åˆ—è¡¨ï¼Œä»è€Œè§£å†³ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œç¨‹åºä¹Ÿå°±èƒ½æ­£å¸¸è¿è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BeanDefinition</span><span class="params">(Class beanClass, PropertyValues propertyValues)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.beanClass = beanClass;</span><br><span class="line">  <span class="built_in">this</span>.propertyValues = propertyValues != <span class="literal">null</span> ? propertyValues : <span class="keyword">new</span> <span class="title class_">PropertyValues</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step04.png" alt="step04"></p><h2 id="Step05ï¼šè§£æ”¾åŒæ‰‹ï¼Œåˆ©ç”¨èµ„æºåŠ è½½å™¨è§£æxmlæ–‡ä»¶æ³¨å†ŒBeanå®šä¹‰ä¿¡æ¯ï¼Œç®€åŒ–åˆ›å»ºè¿‡ç¨‹"><a href="#Step05ï¼šè§£æ”¾åŒæ‰‹ï¼Œåˆ©ç”¨èµ„æºåŠ è½½å™¨è§£æxmlæ–‡ä»¶æ³¨å†ŒBeanå®šä¹‰ä¿¡æ¯ï¼Œç®€åŒ–åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="Step05ï¼šè§£æ”¾åŒæ‰‹ï¼Œåˆ©ç”¨èµ„æºåŠ è½½å™¨è§£æxmlæ–‡ä»¶æ³¨å†ŒBeanå®šä¹‰ä¿¡æ¯ï¼Œç®€åŒ–åˆ›å»ºè¿‡ç¨‹"></a>Step05ï¼šè§£æ”¾åŒæ‰‹ï¼Œåˆ©ç”¨èµ„æºåŠ è½½å™¨è§£æxmlæ–‡ä»¶æ³¨å†ŒBeanå®šä¹‰ä¿¡æ¯ï¼Œç®€åŒ–åˆ›å»ºè¿‡ç¨‹</h2><h3 id="å®ç°ï¼š-3"><a href="#å®ç°ï¼š-3" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>å®šä¹‰Resourceæ¥å£ï¼Œæä¾›è·å–å­—èŠ‚æµçš„æ–¹æ³•ã€‚ </p></li><li><p>å®ç°Resoureæ¥å£ã€‚è·å–ä¸‰ç§ä¸åŒæ–‡ä»¶æµæ“ä½œã€‚  </p><ul><li><p>ClassPathï¼šclassLoader.getResourceAsStream(path)</p></li><li><p>FileSystemï¼šFiles.newInputStream(this.file.toPath())</p></li><li><p>URLï¼šthis.url.openConnection().getInputStream() </p></li></ul></li><li><p>åŒ…è£…èµ„æºåŠ è½½å™¨ï¼Œå°†ä¸‰ç§èµ„æºåŠ è½½æ–¹å¼é›†ä¸­åˆ°ç»Ÿä¸€çš„æ¥å£ä¸‹è¿›è¡Œå¤„ç†ã€‚</p><ol><li>å®šä¹‰èµ„æºåŠ è½½æ¥å£ResourceLoaderï¼Œæä¾›è·å–èµ„æºçš„æ–¹æ³•ã€‚ </li><li>å®ç°èµ„æºåŠ è½½æ¥å£ResourceLoaderï¼Œåˆ¤æ–­åœ°å€ç±»å‹ä»è€Œè·å–å¯¹åº”çš„èµ„æºã€‚ </li></ol></li><li><p>å®šä¹‰ åŠ è½½Beanå®šä¹‰ æ¥å£ BeanDefinitionLoaderï¼Œæä¾› è·å–Beanå®šä¹‰çš„æ³¨å†Œä¿¡æ¯ getRegistry() ï¼ŒgetResourceLoader() èµ„æºåŠ è½½ ä»¥åŠ ä¸‰ä¸ªåŠ è½½Beanå®šä¹‰çš„æ–¹æ³•ã€‚ </p></li><li><p>å®šä¹‰è¯»å–Beanå®šä¹‰çš„æŠ½è±¡ç±» AbstractBeanDefinitionReaderï¼Œé€šè¿‡æ„é€ å‡½æ•°çš„å½¢å¼è®©è°ƒç”¨æ–¹å°†BeanDefinitionRegistryå’ŒResourceLoaderä¼ é€’è¿›æ¥ï¼Œä»è€Œå®ç°æ¥å£ çš„ è·å–Beanå®šä¹‰æ³¨å†ŒgetRegistry()ä»¥åŠgetResourceLoader()èµ„æºåŠ è½½ æ–¹æ³•ï¼Œè¿™æ ·å°†ä¸‰ä¸ªåŠ è½½Beanå®šä¹‰çš„æ–¹æ³•æ‰€éœ€è¦ç”¨åˆ°çš„å·¥å…·ï¼Œäº‹å…ˆäº¤ç»™æŠ½è±¡ç±»å®ç°ï¼Œä¿è¯äº†ä¸‰ä¸ªå…·ä½“æ“ä½œä¸è¢«æ±¡æŸ“ã€‚</p></li><li><p>åˆ›å»ºxmlæ–‡ä»¶å¤„ç†ç±» XmlBeanDefinitionReaderï¼Œé€šè¿‡ç»§æ‰¿ AbstractBeanDefinitionReader æŠ½è±¡ç±»ï¼Œå®ç°ä¸‰ä¸ªåŠ è½½Beanå®šä¹‰çš„æ–¹æ³•ï¼Œé€šè¿‡è§£æxmlæ–‡ä»¶å®šä¹‰å¹¶æ³¨å†ŒBeanã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doLoadBeanDefinitions</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">  <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> XmlUtil.readXML(inputStream);</span><br><span class="line">  <span class="type">Element</span> <span class="variable">root</span> <span class="operator">=</span> doc.getDocumentElement();</span><br><span class="line">  <span class="type">NodeList</span> <span class="variable">childNodes</span> <span class="operator">=</span> root.getChildNodes();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; childNodes.getLength(); i++) &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å…ƒç´ </span></span><br><span class="line">    <span class="keyword">if</span> (!(childNodes.item(i) <span class="keyword">instanceof</span> Element)) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;bean&quot;</span>.equals(childNodes.item(i).getNodeName())) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£ææ ‡ç­¾</span></span><br><span class="line">    <span class="type">Element</span> <span class="variable">bean</span> <span class="operator">=</span> (Element) childNodes.item(i);</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> bean.getAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> bean.getAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> bean.getAttribute(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">    <span class="comment">// è·å– Classï¼Œæ–¹ä¾¿è·å–ç±»ä¸­çš„åç§°</span></span><br><span class="line">    Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">    <span class="comment">// ä¼˜å…ˆçº§ id &gt; name</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> StrUtil.isNotEmpty(id) ? id : name;</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isEmpty(beanName)) &#123;</span><br><span class="line">      beanName = StrUtil.lowerFirst(clazz.getSimpleName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰Bean</span></span><br><span class="line">    <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(clazz);</span><br><span class="line">    <span class="comment">// è¯»å–å±æ€§å¹¶å¡«å……</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; bean.getChildNodes().getLength(); j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(bean.getChildNodes().item(j) <span class="keyword">instanceof</span> Element)) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="string">&quot;property&quot;</span>.equals(bean.getChildNodes().item(j).getNodeName())) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="comment">// è§£ææ ‡ç­¾ï¼šproperty</span></span><br><span class="line">      <span class="type">Element</span> <span class="variable">property</span> <span class="operator">=</span> (Element) bean.getChildNodes().item(j);</span><br><span class="line">      <span class="type">String</span> <span class="variable">attrName</span> <span class="operator">=</span> property.getAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">attrValue</span> <span class="operator">=</span> property.getAttribute(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">attrRef</span> <span class="operator">=</span> property.getAttribute(<span class="string">&quot;ref&quot;</span>);</span><br><span class="line">      <span class="comment">// è·å–å±æ€§å€¼ï¼šå¼•å…¥å¯¹è±¡ã€å€¼å¯¹è±¡</span></span><br><span class="line">      <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> StrUtil.isNotEmpty(attrRef) ? <span class="keyword">new</span> <span class="title class_">BeanReference</span>(attrRef) : attrValue;</span><br><span class="line">      <span class="comment">// åˆ›å»ºå±æ€§ä¿¡æ¯</span></span><br><span class="line">      <span class="type">PropertyValue</span> <span class="variable">propertyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyValue</span>(attrName, value);</span><br><span class="line">      beanDefinition.getPropertyValues().addPropertyValue(propertyValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦é‡å¤æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">if</span> (getRegistry().containsBeanDefinition(beanName)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Duplicate beanName[&quot;</span> + beanName + <span class="string">&quot;] is not allowed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ³¨å†Œ BeanDefinition</span></span><br><span class="line">    getRegistry().registerBeanDefinition(beanName, beanDefinition);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯¹ç›®å‰springæ¡†æ¶çš„ä¼˜åŒ–ï¼š </p><ul><li>å¯¹ BeanFactory æ¥å£ï¼Œæ–°å¢æŒ‰ç…§ç±»å‹è·å–Beançš„æ–¹æ³•ã€‚ </li><li>æ–°å¢ ListableBeanFactory æ¥å£ï¼Œç»§æ‰¿ BeanFactory æ¥å£ï¼Œæä¾› æŒ‰ç…§ç±»å‹è¿”å› Bean å®ä¾‹ ä»¥åŠ è¿”å›æ³¨å†Œè¡¨ä¸­æ‰€æœ‰çš„Beanåç§° çš„æ–¹æ³•ã€‚ </li><li>æ–°å¢ HierarchicalBeanFactory æ¥å£ï¼Œç»§æ‰¿ BeanFactory æ¥å£ï¼Œå±äºæ‰©å±•å·¥å‚çš„å±‚æ¬¡å­æ¥å£ã€‚ </li><li>æ–°å¢ AutowireCapableBeanFactory æ¥å£ï¼Œç»§æ‰¿ BeanFactory æ¥å£ï¼Œç”¨äºè‡ªåŠ¨åŒ–å¤„ç†å·¥å‚é…ç½®ã€‚ </li><li>æ–°å¢ ConfigurableBeanFactory æ¥å£ï¼Œç”¨äºè·å–BeanPostProcessor,BeanClassLoader ç­‰ä¸€ç³»åˆ—çš„é…ç½® </li><li>æ–°å¢ ConfigurableListableBeanFactory æ¥å£ï¼Œæä¾›åˆ†æã€ä¿®æ”¹ä»¥åŠé¢„å…ˆå®ä¾‹åŒ–Beançš„æ“ä½œæ–¹æ³•ã€‚</li><li>ä»¤ DefaultListableBeanFactory å®ç° ConfigurableListableBeanFactory ï¼Œ æ–°å¢ æŸ¥è¯¢æ˜¯å¦åŒ…å«æŒ‡å®šbeanDefinition ã€æŒ‰ç…§æŒ‡å®šç±»å‹è·å–Bean ä»¥åŠ è·å–æ‰€æœ‰ BeanDefinitionNamesã€‚</li></ul></li></ol><h3 id="æµ‹è¯•ï¼š-3"><a href="#æµ‹è¯•ï¼š-3" class="headerlink" title="æµ‹è¯•ï¼š"></a>æµ‹è¯•ï¼š</h3><p><strong>spring.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.ray.springframework.bean.UserDao&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.ray.springframework.bean.UserService&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;uId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10001&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;userDao&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>ApiTest</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.IoUtil;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.bean.UserDao;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.bean.UserService;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValue;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValues;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanDefinition;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanReference;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.support.DefaultListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.xml.XmlBeanDefinitionReader;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.core.io.DefaultResourceLoader;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/17 15:26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_BeanFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1.åˆå§‹åŒ– BeanFactory</span></span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultListableBeanFactory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. UserDao æ³¨å†Œ</span></span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;userDao&quot;</span>, <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(UserDao.class));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. UserService è®¾ç½®å±æ€§[uIdã€userDao]</span></span><br><span class="line">        <span class="type">PropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyValues</span>();</span><br><span class="line">        propertyValues.addPropertyValue(<span class="keyword">new</span> <span class="title class_">PropertyValue</span>(<span class="string">&quot;uId&quot;</span>, <span class="string">&quot;10001&quot;</span>));</span><br><span class="line">        propertyValues.addPropertyValue(<span class="keyword">new</span> <span class="title class_">PropertyValue</span>(<span class="string">&quot;userDao&quot;</span>, <span class="keyword">new</span> <span class="title class_">BeanReference</span>(<span class="string">&quot;userDao&quot;</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. UserService æ³¨å…¥bean</span></span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(UserService.class, propertyValues);</span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;userService&quot;</span>, beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. UserService è·å–bean</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) beanFactory.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> userService.queryUserInfo();</span><br><span class="line">        System.out.println(<span class="string">&quot;æµ‹è¯•ç»“æœï¼š&quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        resourceLoader = <span class="keyword">new</span> <span class="title class_">DefaultResourceLoader</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_classpath</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> resourceLoader.getResource(<span class="string">&quot;classpath:important.properties&quot;</span>);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> resource.getInputStream();</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> IoUtil.readUtf8(inputStream);</span><br><span class="line">        System.out.println(content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_xml</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1.åˆå§‹åŒ– BeanFactory</span></span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultListableBeanFactory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è¯»å–é…ç½®æ–‡ä»¶&amp;æ³¨å†ŒBean</span></span><br><span class="line">        <span class="type">XmlBeanDefinitionReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmlBeanDefinitionReader</span>(beanFactory);</span><br><span class="line">        reader.loadBeanDefinitions(<span class="string">&quot;classpath:spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. è·å–Beanå¯¹è±¡è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> beanFactory.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> userService.queryUserInfo();</span><br><span class="line">        System.out.println(<span class="string">&quot;æµ‹è¯•ç»“æœï¼š&quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step05.png" alt="step05"></p><h2 id="Step06ï¼šåº”ç”¨ä¸Šä¸‹æ–‡ï¼Œå¯¹Beançš„å®ä¾‹åŒ–è¿‡ç¨‹è¿›è¡Œæ‰©å±•"><a href="#Step06ï¼šåº”ç”¨ä¸Šä¸‹æ–‡ï¼Œå¯¹Beançš„å®ä¾‹åŒ–è¿‡ç¨‹è¿›è¡Œæ‰©å±•" class="headerlink" title="Step06ï¼šåº”ç”¨ä¸Šä¸‹æ–‡ï¼Œå¯¹Beançš„å®ä¾‹åŒ–è¿‡ç¨‹è¿›è¡Œæ‰©å±•"></a>Step06ï¼šåº”ç”¨ä¸Šä¸‹æ–‡ï¼Œå¯¹Beançš„å®ä¾‹åŒ–è¿‡ç¨‹è¿›è¡Œæ‰©å±•</h2><h3 id="å®ç°ï¼š-4"><a href="#å®ç°ï¼š-4" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>å®šä¹‰ä¸¤ä¸ªæ‰©å±•æ¥å£ã€‚ </p><ul><li>BeanFactoryPostProcessorï¼šæä¾›åœ¨Beanå¯¹è±¡å®šä¹‰æ³¨å†Œåå®ä¾‹åŒ–å‰ï¼Œå¯¹Beanå®šä¹‰çš„å±æ€§è¿›è¡Œä¿®æ”¹çš„æ“ä½œã€‚ </li><li>BeanPostProcessorï¼šæä¾›åœ¨Beanå¯¹è±¡å®ä¾‹åŒ–åå¯¹Beanç›´æ¥è¿›è¡Œä¿®æ”¹çš„æ“ä½œã€‚åˆ†ä¸ºBeanå¯¹è±¡åˆå§‹åŒ–å‰ä¸Beanå¯¹è±¡åˆå§‹åŒ–åã€‚ </li></ul></li><li><p>å®šä¹‰ ApplicationContext ä¸Šä¸‹æ–‡æ¥å£ï¼Œç»§æ‰¿äºListableBeanFactoryï¼Œç”¨äºè·å–çˆ¶ç±»ä¸Šä¸‹æ–‡ã€‚ </p></li><li><p>å®šä¹‰ ConfigurableApplicationContext æ¥å£ï¼Œç»§æ‰¿äºApplicationContextï¼Œæä¾› refresh() åˆ·æ–°å®¹å™¨çš„æ–¹æ³•ã€‚</p></li><li><p>å®šä¹‰ AbstractApplicationContext æŠ½è±¡ç±»ï¼Œå®ç°ConfigurableApplicationContextæ¥å£ï¼Œå®ç°refreshæ–¹æ³•ã€‚å¹¶ç»§æ‰¿DefaultResourceLoaderä»¥åŠ è½½xmlæ–‡ä»¶ï¼Œä»è€Œå®ç°Beançš„å®šä¹‰æ³¨å†Œã€‚å¦å¤–ï¼ŒAbstractApplicationContext æŠ½è±¡ç±»æä¾› refreshBeanFactory(ï¼‰åˆ›å»º BeanFactoryï¼Œå¹¶åŠ è½½ BeanDefinitionä»¥åŠgetBeanFactory() è·å–Beanå·¥å‚æ–¹æ³•ä¾›ç»§æ‰¿ç±»å®ç°ã€‚ </p><p>refresh åˆ·æ–°å®¹å™¨çš„å®ç°è¿‡ç¨‹ï¼š</p><ol><li>åˆ›å»º BeanFactoryï¼Œå¹¶é€šè¿‡ XML æ–‡ä»¶åŠ è½½ BeanDefinition </li><li>è·å– BeanFactory </li><li>åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ‰§è¡Œ BeanFactoryPostProcessor </li><li>BeanPostProcessor éœ€è¦æå‰äºå…¶ä»– Bean å¯¹è±¡å®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œæ³¨å†Œæ“ä½œï¼Œä»è€Œä¿è¯åœ¨å®ä¾‹åŒ–è¿‡ç¨‹èƒ½æ­£å¸¸è·å–åˆ°BeanPostProcessorä»¥è¾¾åˆ°è‡ªå®šä¹‰ä¿®æ”¹Beançš„æ•ˆæœã€‚</li><li>æå‰å®ä¾‹åŒ–å•ä¾‹Beanå¯¹è±¡</li></ol></li><li><p>å®šä¹‰ AbstractRefreshableApplicationContext æŠ½è±¡ç±»ï¼Œç»§æ‰¿äºAbstractApplicationContext æŠ½è±¡ç±»ï¼Œå®ç°refreshBeanFactory(ï¼‰åˆ›å»º BeanFactoryï¼Œå¹¶åŠ è½½ BeanDefinitionä»¥åŠgetBeanFactory() è·å–Beanå·¥å‚æ–¹æ³•ï¼Œå¹¶æä¾›loadBeanDefinitions(DefaultListableBeanFactory) åŠ è½½xmlæ–‡ä»¶å®šä¹‰å¹¶æ³¨å†ŒBeanå¯¹è±¡ æ–¹æ³•ä¾›ç»§æ‰¿ç±»å®ç°ã€‚ </p></li><li><p>å®šä¹‰ AbstractXmlApplicationContext æŠ½è±¡ç±»ï¼Œç»§æ‰¿äºAbstractRefreshableApplicationContext æŠ½è±¡ç±»ï¼Œå®ç°loadBeanDefinitions(DefaultListableBeanFactory)  åŠ è½½xmlæ–‡ä»¶å®šä¹‰å¹¶æ³¨å†ŒBeanå¯¹è±¡ æ–¹æ³•ï¼Œå¹¶æä¾› getConfigLocations() æ–¹æ³• ä»å…¥å£ä¸Šä¸‹æ–‡å¤„è·å–é…ç½®æ–‡ä»¶è·¯å¾„ã€‚ </p></li><li><p>åˆ›å»º ClassPathXmlApplicationContext åº”ç”¨ä¸Šä¸‹æ–‡å®ç°ç±»ï¼Œç»§æ‰¿äºAbstractXmlApplicationContext æŠ½è±¡ç±»ï¼Œå®ç° getConfigLocations() æ–¹æ³•ï¼Œè¿”å›é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œä½¿èµ„æºåŠ è½½èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œã€‚å¹¶ä¸”è¿™é‡Œé€šè¿‡æ„é€ å‡½æ•°çš„æ–¹å¼æ‹¿åˆ°é…ç½®æ–‡ä»¶è·¯å¾„å»è°ƒç”¨å±‚å±‚ç»§æ‰¿ä¸‹æ¥çš„refresh() åˆ·æ–°å®¹å™¨çš„æ–¹æ³•ï¼Œä»è€Œå®ç°Beanå¯¹è±¡çš„æ‰©å±•ã€‚</p></li><li><p>è¡¥å…¨ AutowireCapableBeanFactory æ¥å£ï¼Œå¢åŠ  æ‰§è¡ŒBeanPostProcessor å‰ç½®å’Œåç½®çš„æ–¹æ³•ã€‚ </p></li><li><p>è¡¥å…¨ AbstractAutowireCapableBeanFactory ç±»ï¼Œåœ¨å®ä¾‹åŒ–Beanä¹‹åæ·»åŠ æ‰§è¡ŒBeançš„åˆå§‹åŒ–æ–¹æ³•ä»¥åŠæ‰§è¡ŒBeanPostProcessor å‰ç½®å’Œåç½®æ–¹æ³•ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.beans.factory.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValue;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValues;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.AutowireCapableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanDefinition;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/15 17:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractBeanFactory</span> <span class="keyword">implements</span> <span class="title class_">AutowireCapableBeanFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">InstantiationStrategy</span> <span class="variable">instantiationStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CglibSubclassingInstantiationStrategy</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> InstantiationStrategy <span class="title function_">getInstantiationStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instantiationStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInstantiationStrategy</span><span class="params">(InstantiationStrategy instantiationStrategy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.instantiationStrategy = instantiationStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, BeanDefinition beanDefinition, Object[] args)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bean = createBeanInstance(beanDefinition, beanName, args);</span><br><span class="line">            applyPropertyValues(beanName, bean, beanDefinition);</span><br><span class="line">            <span class="comment">// æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•</span></span><br><span class="line">            bean = initializeBean(beanName,bean,beanDefinition);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Instantiation of bean failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        addSingleton(beanName, bean);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">createBeanInstance</span><span class="params">(BeanDefinition beanDefinition, String beanName, Object[] args)</span> &#123;</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructorToUse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Class&lt;?&gt; beanClass = beanDefinition.getBeanClass();</span><br><span class="line">        Constructor&lt;?&gt;[] declaredConstructors = beanClass.getDeclaredConstructors(); <span class="comment">// è·å–æ„é€ å‡½æ•°çš„ä¸ªæ•°</span></span><br><span class="line">        <span class="keyword">for</span> (Constructor ctor : declaredConstructors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != args &amp;&amp; ctor.getParameterTypes().length == args.length) &#123; <span class="comment">// ç®€å•æ¯”å¯¹å…¥å‚ä¸ªæ•°</span></span><br><span class="line">                constructorToUse = ctor;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getInstantiationStrategy().instantiate(beanDefinition, beanName, constructorToUse, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bean å±æ€§å¡«å……</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">applyPropertyValues</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> beanDefinition.getPropertyValues();</span><br><span class="line">            <span class="keyword">for</span> (PropertyValue propertyValue : propertyValues.getPropertyValues()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> propertyValue.getName();</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> propertyValue.getValue();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BeanReference) &#123;</span><br><span class="line">                    <span class="comment">// A ä¾èµ– Bï¼Œè·å– B çš„å®ä¾‹åŒ–</span></span><br><span class="line">                    <span class="type">BeanReference</span> <span class="variable">beanReference</span> <span class="operator">=</span> (BeanReference) value;</span><br><span class="line">                    value = getBean(beanReference.getBeanName());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å±æ€§å¡«å……</span></span><br><span class="line">                BeanUtil.setFieldValue(bean, name, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Error setting property valuesï¼š&quot;</span> + beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">initializeBean</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ‰§è¡Œ BeanPostProcessor Before å¤„ç†</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> applyBeanPostProcessorsBeforeInitialization(bean, beanName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾…å®Œæˆå†…å®¹ï¼šinvokeInitMethods(beanName, wrappedBean, beanDefinition);</span></span><br><span class="line">        invokeInitMethods(beanName, wrappedBean, beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. æ‰§è¡Œ BeanPostProcessor After å¤„ç†</span></span><br><span class="line">        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">        <span class="keyword">return</span> wrappedBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokeInitMethods</span><span class="params">(String beanName, Object wrappedBean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> existingBean;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">current</span> <span class="operator">=</span> processor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == current) <span class="keyword">return</span> result;</span><br><span class="line">            result = current;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">applyBeanPostProcessorsAfterInitialization</span><span class="params">(Object existingBean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> existingBean;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">current</span> <span class="operator">=</span> processor.postProcessAfterInitialization(result, beanName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == current) <span class="keyword">return</span> result;</span><br><span class="line">            result = current;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š-2"><a href="#ç»“æœï¼š-2" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><p>æ•´ä¸ªæµç¨‹æ¦‚æ‹¬æ¥è®²æ ¸å¿ƒå°±æ˜¯ refresh() æ–¹æ³•ã€‚ </p><ol><li><p>é¦–å…ˆé€šè¿‡ ClassPathXmlApplicationContext ä¸Šä¸‹æ–‡å®ç°ç±»å…¥å£ï¼Œè¿›å…¥refresh()æ–¹æ³•ã€‚</p></li><li><p>ä¹‹åï¼Œåˆ›å»ºBeanFactoryï¼Œå®šä¹‰å¹¶æ³¨å†ŒBean </p></li><li><p>è·å–åˆ°Beanfactoryä¹‹åï¼Œæ‰§è¡Œå®šä¹‰çš„ BeanFactoryPostProcessorï¼Œä»¥æ­¤ä¿®æ”¹Beanå®šä¹‰çš„å±æ€§ä¿¡æ¯ã€‚ </p></li><li><p>åœ¨æ­¤ä¹‹åï¼Œå°†å®šä¹‰çš„ BeanPostProcessor æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚ </p></li><li><p>æœ€åï¼Œæå‰å®ä¾‹åŒ–Beanï¼Œç”±å·²ç»æ³¨å†Œçš„ BeanPostProcessor æ¥ä¿®æ”¹ å®ä¾‹åŒ–åçš„Beanä¿¡æ¯ã€‚ </p><p>Tipsï¼šBeanFactoryPostProcessor å’Œ BeanPostProcessor æœ¬èº«ä¹Ÿæ˜¯ Beanã€‚</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.context.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanFactoryPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.core.io.DefaultResourceLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/21 22:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractApplicationContext</span> <span class="keyword">extends</span> <span class="title class_">DefaultResourceLoader</span> <span class="keyword">implements</span> <span class="title class_">ConfigurableApplicationContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// 1. åˆ›å»º BeanFactoryï¼Œå¹¶åŠ è½½ BeanDefinition</span></span><br><span class="line">        <span class="comment">// 1.1  ClassPathXmlApplicationContext -&gt;  getConfigLocations()</span></span><br><span class="line">        <span class="comment">// 1.2  AbstractXmlApplicationContext  -&gt;  loadBeanDefinitions(DefaultListableBeanFactory beanFactory)</span></span><br><span class="line">        <span class="comment">// 1.3  AbstractRefreshableApplicationContext  -&gt;  refreshBeanFactory()</span></span><br><span class="line">        refreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è·å– BeanFactory</span></span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ‰§è¡Œ BeanFactoryPostProcessor (Invoke factory processors registered as beans in the context.)</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. BeanPostProcessor éœ€è¦æå‰äºå…¶ä»– Bean å¯¹è±¡å®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œæ³¨å†Œæ“ä½œ</span></span><br><span class="line">        registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. æå‰å®ä¾‹åŒ–å•ä¾‹Beanå¯¹è±¡ï¼Œæ–¹ä¾¿ä¹‹åä½¿ç”¨</span></span><br><span class="line">        beanFactory.preInstantiateSingletons();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> ConfigurableListableBeanFactory <span class="title function_">getBeanFactory</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">        Map&lt;String, BeanFactoryPostProcessor&gt; beanFactoryPostProcessorMap = beanFactory.getBeansOfType(BeanFactoryPostProcessor.class);</span><br><span class="line">        <span class="keyword">for</span> (BeanFactoryPostProcessor beanFactoryPostProcessor : beanFactoryPostProcessorMap.values()) &#123;</span><br><span class="line">            beanFactoryPostProcessor.postProcessBeanFactory(beanFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">        Map&lt;String, BeanPostProcessor&gt; beanPostProcessorMap = beanFactory.getBeansOfType(BeanPostProcessor.class);</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor beanPostProcessor : beanPostProcessorMap.values()) &#123;</span><br><span class="line">            beanFactory.addBeanPostProcessor(beanPostProcessor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Map&lt;String, T&gt; <span class="title function_">getBeansOfType</span><span class="params">(Class&lt;T&gt; type)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeansOfType(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getBeanDefinitionNames() &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeanDefinitionNames();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getBean</span><span class="params">(String name, Object... args)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(name, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(String name, Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(name, requiredType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step06.drawio.png" alt="step06.drawio"></p><h2 id="Step07ï¼šæ‰©å±•Beanå®ä¾‹åŒ–è¿‡ç¨‹ï¼Œå¢åŠ åˆå§‹åŒ–ä»¥åŠé”€æ¯æ–¹æ³•"><a href="#Step07ï¼šæ‰©å±•Beanå®ä¾‹åŒ–è¿‡ç¨‹ï¼Œå¢åŠ åˆå§‹åŒ–ä»¥åŠé”€æ¯æ–¹æ³•" class="headerlink" title="Step07ï¼šæ‰©å±•Beanå®ä¾‹åŒ–è¿‡ç¨‹ï¼Œå¢åŠ åˆå§‹åŒ–ä»¥åŠé”€æ¯æ–¹æ³•"></a>Step07ï¼šæ‰©å±•Beanå®ä¾‹åŒ–è¿‡ç¨‹ï¼Œå¢åŠ åˆå§‹åŒ–ä»¥åŠé”€æ¯æ–¹æ³•</h2><h3 id="å®ç°ï¼š-5"><a href="#å®ç°ï¼š-5" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>å®šä¹‰åˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•çš„æ¥å£ï¼Œä¸€èˆ¬ç”¨æ¥åšä¸€äº›å‚æ•°çš„åŠ è½½ä¸é”€æ¯ã€‚æ¯”å¦‚æ¥å£æš´éœ²ï¼Œæ•°æ®åº“è¿æ¥æ–­å¼€ç­‰ã€‚</p></li><li><p>æ–°å¢Beanå®šä¹‰ä¿¡æ¯ï¼Œåˆå§‹åŒ–ä»¥åŠé”€æ¯æ–¹æ³•åã€‚ä¾›xmlè§£æç”¨ã€‚ </p></li><li><p>å®Œå–„ AbstractAutowireCapableBeanFactory ä¸­beanå¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œä¸»è¦åˆ†ä¸º æ‰§è¡Œå®ç°åˆå§‹åŒ–æ¥å£çš„æ–¹æ³• ä»¥åŠ é€šè¿‡xmlæ–‡ä»¶è§£æåˆ¤æ–­init-Methodæ˜¯å¦å­˜åœ¨ï¼Œä¹‹åæ‰§è¡Œåå°„è°ƒç”¨ method.invoke(bean) </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">initializeBean</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">  <span class="comment">// 1. æ‰§è¡Œ BeanPostProcessor Before å¤„ç†</span></span><br><span class="line">  <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> applyBeanPostProcessorsBeforeInitialization(bean, beanName);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¾…å®Œæˆå†…å®¹ï¼šinvokeInitMethods(beanName, wrappedBean, beanDefinition);</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    invokeInitMethods(beanName, wrappedBean, beanDefinition);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Invocation of init method of bean[&quot;</span> + beanName + <span class="string">&quot;] failed&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. æ‰§è¡Œ BeanPostProcessor After å¤„ç†</span></span><br><span class="line">  wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">  <span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokeInitMethods</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="comment">// 1. å®ç°æ¥å£ InitializingBean</span></span><br><span class="line">  <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> InitializingBean) &#123;</span><br><span class="line">    ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. æ³¨è§£é…ç½® init-method &#123;åˆ¤æ–­æ˜¯ä¸ºäº†é¿å…äºŒæ¬¡æ‰§è¡Œåˆå§‹åŒ–&#125;</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">initMethodName</span> <span class="operator">=</span> beanDefinition.getInitMethodName();</span><br><span class="line">  <span class="keyword">if</span> (StrUtil.isNotEmpty(initMethodName) &amp;&amp; !(bean <span class="keyword">instanceof</span> InitializingBean)) &#123;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">initMethod</span> <span class="operator">=</span> beanDefinition.getBeanClass().getMethod(initMethodName);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == initMethod) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Could not find an init method named &#x27;&quot;</span> + initMethodName + <span class="string">&quot;&#x27; on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    initMethod.invoke(bean);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰é”€æ¯æ–¹æ³•é€‚é…å™¨ï¼Œæä¾› æ‰§è¡Œå®ç°åˆå§‹åŒ–æ¥å£çš„æ–¹æ³• ä»¥åŠ é€šè¿‡xmlæ–‡ä»¶è§£æåˆ¤æ–­destroy-Method æ˜¯å¦å­˜åœ¨ ä¸¤ç§é”€æ¯æ–¹æ³•ï¼Œä¸åˆå§‹åŒ–æ–¹æ³•ç›¸ä¼¼ã€‚è¿™ä¸¤ç§æ–¹æ³•éƒ½æ˜¯åœ¨AbstractApplicationContext æ³¨å†Œè™šæ‹Ÿæœºå‹¾å­åï¼Œè™šæ‹Ÿæœºå…³é—­å‰æ‰§è¡Œçš„æ“ä½œã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="comment">// 1. å®ç°æ¥å£ DisposableBean</span></span><br><span class="line">  <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> DisposableBean) &#123;</span><br><span class="line">    ((DisposableBean) bean).destroy();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. æ³¨è§£é…ç½® destroy-method &#123;åˆ¤æ–­æ˜¯ä¸ºäº†é¿å…äºŒæ¬¡æ‰§è¡Œé”€æ¯&#125;</span></span><br><span class="line">  <span class="keyword">if</span> (StrUtil.isNotEmpty(destroyMethodName) &amp;&amp; !(bean <span class="keyword">instanceof</span> DisposableBean &amp;&amp; <span class="string">&quot;destroy&quot;</span>.equals(<span class="built_in">this</span>.destroyMethodName))) &#123;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">destroyMethod</span> <span class="operator">=</span> bean.getClass().getMethod(destroyMethodName);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == destroyMethod) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Couldn&#x27;t find a destroy method named &#x27;&quot;</span> + destroyMethodName + <span class="string">&quot;&#x27; on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    destroyMethod.invoke(bean);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®Œå–„ AbstractAutowireCapableBeanFactory ï¼Œåœ¨Beanå®ä¾‹åŒ–åï¼Œå°†é”€æ¯æ–¹æ³•ä¿å­˜èµ·æ¥ï¼Œæ–¹ä¾¿åç»­è°ƒç”¨ã€‚è¿™é‡Œå°†é”€æ¯æ–¹æ³•æ³¨å†Œåˆ° DefaultSingletonRegistry çš„ Map<String,DisposableBean> å±æ€§ä¸­ã€‚ </p></li><li><p>å®Œå–„ DefaultSingletonRegistry ï¼Œå¢åŠ  Map<String,DisposableBean> é”€æ¯æ–¹æ³•æ³¨å†Œè¡¨ ä»¥åŠ  destroySingletons() æ‰§è¡Œæ³¨å†Œè¡¨ä¸­çš„é”€æ¯æ–¹æ³•ã€‚</p></li><li><p>åœ¨é…ç½®åº”ç”¨ä¸Šä¸‹æ–‡ ConfigurableApplicationContext ä¸­ï¼Œå®šä¹‰ æ³¨å†Œè™šæ‹Ÿæœºå‹¾å­ä»¥åŠå…³é—­çš„æ–¹æ³•ã€‚</p></li><li><p>åœ¨ åº”ç”¨ä¸Šä¸‹æ–‡æŠ½è±¡ç±» AbstractApplicationContext å®ç°æ³¨å†Œè™šæ‹Ÿæœºå‹¾å­(Runtime.getRuntime().addShutdownHook(new Thread(this::close)) ) ä»¥åŠ å…³é—­æ–¹æ³•(getBeanFactory().destroySingletons())ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerShutdownHook</span><span class="params">()</span> &#123;</span><br><span class="line">  Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>::close));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">  getBeanFactory().destroySingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š-3"><a href="#ç»“æœï¼š-3" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><ol><li>InitializingBean å’Œ DisposableBean ä¹Ÿå¯æ˜¯Beanã€‚ å®¹å™¨ä¸­ï¼Œä¸‡ç‰©çš†å¯ä¸ºBeanã€‚ </li><li>ä¸€ç§æœ‰æ„æ€çš„æ¥å£å®ç°æ–¹å¼ï¼š å½“ A ç»§æ‰¿ B ï¼Œå®ç° C æ—¶ï¼Œç”± A ç»§æ‰¿ çš„ B æ¥å®ç° C çš„æ¥å£æ–¹æ³•ã€‚</li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step07.drawio.png" alt="step07.drawio"></p><h2 id="Step08ï¼šAwareæ„ŸçŸ¥å®¹å™¨å¯¹è±¡ï¼Œå®ç°è‡ªå®šä¹‰æ‰©å±•æ¡†æ¶"><a href="#Step08ï¼šAwareæ„ŸçŸ¥å®¹å™¨å¯¹è±¡ï¼Œå®ç°è‡ªå®šä¹‰æ‰©å±•æ¡†æ¶" class="headerlink" title="Step08ï¼šAwareæ„ŸçŸ¥å®¹å™¨å¯¹è±¡ï¼Œå®ç°è‡ªå®šä¹‰æ‰©å±•æ¡†æ¶"></a>Step08ï¼šAwareæ„ŸçŸ¥å®¹å™¨å¯¹è±¡ï¼Œå®ç°è‡ªå®šä¹‰æ‰©å±•æ¡†æ¶</h2><h3 id="å®ç°ï¼š-6"><a href="#å®ç°ï¼š-6" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>å®šä¹‰æ ‡è®°æ¥å£Awareï¼Œå…¶å­ç±»å®šä¹‰å’Œå®ç°æ„ŸçŸ¥å®¹å™¨ä¸­çš„å¯¹è±¡ï¼Œç›¸å½“äºä¸€ä¸ªå…¥å£ï¼Œæ›´å¥½çš„ç»Ÿä¸€äº†å„ä¸ªæ„ŸçŸ¥å¯¹è±¡ï¼Œä¹Ÿå°±å‡å°‘äº†å¤šä½™çš„åˆ¤æ–­ã€‚</p></li><li><p>æ–°å¢BeanFactoryAwareã€BeanNameAwareã€BeanClassLoaderAwareã€ApplicationContextAware æ¥å£ ç»§æ‰¿ Aware ï¼Œå¹¶å®šä¹‰å¯¹åº”çš„æ„ŸçŸ¥æ–¹æ³•ã€‚ </p></li><li><p>ç”±äºä¸èƒ½ç›´æ¥åœ¨åˆ›å»ºBeanæ—¶ ç›´æ¥è·å–åˆ° ApplicationContextï¼Œæ•… å®šä¹‰ ApplicationContextAwareProcessor å®ç° BeanPostProcessorï¼Œåœ¨å…¶åˆå§‹åŒ–å‰ç½®æ–¹æ³•ä¸­å¢åŠ æ„ŸçŸ¥ ApplicationContext çš„æ“ä½œï¼Œå†ç”±   AbstractAutowireCapableBeanFactory .applyBeanPostProcessorsBeforeInitialization  å»è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">  <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ApplicationContextAware)&#123;</span><br><span class="line">    ((ApplicationContextAware) bean).setApplicationContext(applicationContext);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ AbstractApplicationContext çš„ refresh() æ–¹æ³• ä¸­ï¼Œåœ¨è·å–åˆ° BeanFactory ä¹‹åï¼Œæ·»åŠ  ApplicationContextAwareProcessor ï¼Œè®©ç»§æ‰¿ ApplicationContextAware çš„Beanå¯¹è±¡éƒ½èƒ½æ„ŸçŸ¥åˆ° æ‰€å±çš„ ApplicationContextã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">  <span class="comment">// 1. åˆ›å»º BeanFactoryï¼Œå¹¶åŠ è½½ BeanDefinition</span></span><br><span class="line">  refreshBeanFactory();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. è·å– BeanFactory</span></span><br><span class="line">  <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. æ·»åŠ  ApplicationContextAwareProcessorï¼Œè®©ç»§æ‰¿è‡ª ApplicationContextAware çš„ Bean å¯¹è±¡éƒ½èƒ½æ„ŸçŸ¥æ‰€å±çš„ ApplicationContext</span></span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationContextAwareProcessor</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ‰§è¡Œ BeanFactoryPostProcessor (Invoke factory processors registered as beans in the context.)</span></span><br><span class="line">  invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 5. BeanPostProcessor éœ€è¦æå‰äºå…¶ä»– Bean å¯¹è±¡å®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œæ³¨å†Œæ“ä½œ</span></span><br><span class="line">  registerBeanPostProcessors(beanFactory);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 6. æå‰å®ä¾‹åŒ–å•ä¾‹Beanå¯¹è±¡</span></span><br><span class="line">  beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®Œå–„ AbstractAutowireCapableBeanFactory çš„ initializeBean æ–¹æ³•ï¼Œåœ¨Beanåˆå§‹åŒ–ä¹‹å‰ï¼Œåˆ¤æ–­æ˜¯å¦èƒ½æ„ŸçŸ¥ï¼Œå¹¶æ‰§è¡Œå…¶å¯¹åº”çš„æ„ŸçŸ¥æ–¹æ³•ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">initializeBean</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">  <span class="comment">// 1. æ‰§è¡Œ BeanPostProcessor Before å¤„ç†</span></span><br><span class="line">  <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> applyBeanPostProcessorsBeforeInitialization(bean, beanName);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¾…å®Œæˆå†…å®¹ï¼šinvokeInitMethods(beanName, wrappedBean, beanDefinition);</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    invokeInitMethods(beanName, wrappedBean, beanDefinition);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Invocation of init method of bean[&quot;</span> + beanName + <span class="string">&quot;] failed&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. æ‰§è¡Œ BeanPostProcessor After å¤„ç†</span></span><br><span class="line">  wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">  <span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokeInitMethods</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// invokeAwareMethods</span></span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">      <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanFactoryAware) &#123;</span><br><span class="line">        ((BeanFactoryAware) bean).setBeanFactory(<span class="built_in">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanClassLoaderAware)&#123;</span><br><span class="line">        ((BeanClassLoaderAware) bean).setBeanClassLoader(getBeanClassLoader());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanNameAware) &#123;</span><br><span class="line">        ((BeanNameAware) bean).setBeanName(beanName);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1. å®ç°æ¥å£ InitializingBean</span></span><br><span class="line">  <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> InitializingBean) &#123;</span><br><span class="line">    ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. æ³¨è§£é…ç½® init-method &#123;åˆ¤æ–­æ˜¯ä¸ºäº†é¿å…äºŒæ¬¡æ‰§è¡Œåˆå§‹åŒ–&#125;</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">initMethodName</span> <span class="operator">=</span> beanDefinition.getInitMethodName();</span><br><span class="line">  <span class="keyword">if</span> (StrUtil.isNotEmpty(initMethodName) &amp;&amp; !(bean <span class="keyword">instanceof</span> InitializingBean)) &#123;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">initMethod</span> <span class="operator">=</span> beanDefinition.getBeanClass().getMethod(initMethodName);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == initMethod) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Could not find an init method named &#x27;&quot;</span> + initMethodName + <span class="string">&quot;&#x27; on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    initMethod.invoke(bean);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š-4"><a href="#ç»“æœï¼š-4" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><ol><li>è¿›ä¸€æ­¥äº†è§£å’Œå®Œå–„äº†Beançš„ç”Ÿå‘½å‘¨æœŸã€‚</li></ol><p><img src="../../../../Notes/Springå…¨å®¶æ¡¶/images/step08.drawio.png" alt="step08-ç¬¬ 2 é¡µ.drawio"></p><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/Bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="Beançš„ç”Ÿå‘½å‘¨æœŸ"></p><h2 id="Step09ï¼šå•ä¾‹åˆ¤æ–­ä»¥åŠé€šè¿‡ç”¨æˆ·åˆ›å»ºçš„FactoryBeanå®ç°å¤æ‚Beanå¯¹è±¡çš„åˆ›å»º"><a href="#Step09ï¼šå•ä¾‹åˆ¤æ–­ä»¥åŠé€šè¿‡ç”¨æˆ·åˆ›å»ºçš„FactoryBeanå®ç°å¤æ‚Beanå¯¹è±¡çš„åˆ›å»º" class="headerlink" title="Step09ï¼šå•ä¾‹åˆ¤æ–­ä»¥åŠé€šè¿‡ç”¨æˆ·åˆ›å»ºçš„FactoryBeanå®ç°å¤æ‚Beanå¯¹è±¡çš„åˆ›å»º"></a>Step09ï¼šå•ä¾‹åˆ¤æ–­ä»¥åŠé€šè¿‡ç”¨æˆ·åˆ›å»ºçš„FactoryBeanå®ç°å¤æ‚Beanå¯¹è±¡çš„åˆ›å»º</h2><h3 id="å®ç°ï¼š-7"><a href="#å®ç°ï¼š-7" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>BeanDefinition æ–°å¢ ä½œç”¨èŒƒå›´ å®šä¹‰ scope ï¼Œå¹¶åœ¨ XmlBeanDefintionReader æ–°å¢ å¯¹ xml æ–‡ä»¶ä¸­ scope çš„è§£æï¼Œå¹¶å¡«å……åˆ° BeanDefinition çš„ scope å±æ€§ä¸­ã€‚</p></li><li><p>åœ¨ AbstractAutowireCapableBeanFactory çš„ createBean() åˆ›å»ºå¯¹è±¡æ—¶ï¼Œæ ¹æ®æ˜¯å¦æ˜¯ å•ä¾‹ å’Œ åŸå‹ æ¨¡å¼ï¼Œåˆ¤æ–­æ˜¯å¦å­˜å…¥å†…å­˜ä¸­ã€‚ä¸”åœ¨ registerDisposableBeanIfNecessary æ³¨å†Œé”€æ¯æ–¹æ³•æ—¶ï¼Œéå•ä¾‹Beanä¸éœ€è¦æ³¨å†Œä¸”æ‰§è¡Œé”€æ¯æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, BeanDefinition beanDefinition, Object[] args)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">  <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    bean = createBeanInstance(beanDefinition, beanName, args);</span><br><span class="line">    applyPropertyValues(beanName, bean, beanDefinition);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•</span></span><br><span class="line">    bean = initializeBean(beanName,bean,beanDefinition);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Instantiation of bean failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ³¨å†Œå®ç°äº† DisposableBean æ¥å£çš„ Bean å¯¹è±¡</span></span><br><span class="line">  registerDisposableBeanIfNecessary(beanName,bean,beanDefinition);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­ SCOPE_SINGLETONã€SCOPE_PROTOTYPE</span></span><br><span class="line">  <span class="keyword">if</span> (beanDefinition.isSingleton()) &#123;</span><br><span class="line">    addSingleton(beanName, bean);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerDisposableBeanIfNecessary</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// é Singleton ç±»å‹çš„ Bean ä¸æ‰§è¡Œé”€æ¯æ–¹æ³•ï¼Œå•ä¾‹Beanåªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œä½¿ç”¨å®Œæˆä¹‹åä»£è¡¨æ•´ä¸ªç¨‹åºä¹Ÿå°±æ‰§è¡Œå®Œæ¯•ã€‚è€ŒåŸå‹åˆ™ä¸ä¸€å®šã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (!beanDefinition.isSingleton()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> DisposableBean || StrUtil.isNotEmpty(beanDefinition.getDestroyMethodName())) &#123;</span><br><span class="line">    registerDisposableBean(beanName, <span class="keyword">new</span> <span class="title class_">DisposableBeanAdapter</span>(bean, beanName,</span><br><span class="line">beanDefinition));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰ FactoryBean æ¥å£ ï¼Œæä¾› è·å–å¯¹è±¡ ï¼Œ è·å–å¯¹è±¡ç±»å‹ ï¼Œæ˜¯å¦å•ä¾‹ ä¸‰ä¸ªæ–¹æ³•ã€‚</p></li><li><p>å®šä¹‰ FactoryBeanRegistrySupport æŠ½è±¡ç±» ç»§æ‰¿äº DefaultSingletonBeanRegistry ï¼Œæä¾›å¯¹ FactoryBean çš„ ä¸€ç³»åˆ—æ³¨å†Œæ“ä½œï¼š getCachedObjectForFactoryBean è·å–ç¼“å­˜ä¸­çš„å•ä¾‹å¯¹è±¡ ï¼›getObjectFromFactoryBean è·å–å¯¹è±¡çš„é€»è¾‘æ“ä½œï¼Œåˆ¤æ–­æ˜¯å¦å•ä¾‹ï¼Œè‹¥æ˜¯å•ä¾‹åˆ™ä»ç¼“å­˜ä¸­è·å–ï¼Œç¬¬ä¸€æ¬¡è·å–åˆ™éœ€å­˜å…¥ç¼“å­˜ï¼Œè‹¥ä¸æ˜¯å•ä¾‹ï¼Œåˆ™ç›´æ¥è·å–ä¸”ä¸å­˜å…¥ç¼“å­˜ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.beans.factory.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.FactoryBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/28 16:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FactoryBeanRegistrySupport</span> <span class="keyword">extends</span> <span class="title class_">DefaultSingletonBeanRegistry</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; factoryBeanObjectCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">getCachedObjectForFactoryBean</span><span class="params">(String beanName)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> <span class="built_in">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line">        <span class="keyword">return</span> (object != NULL_OBJECT ? object : <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">getObjectFromFactoryBean</span><span class="params">(FactoryBean factory, String beanName)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (factory.isSingleton()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> <span class="built_in">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</span><br><span class="line">                object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">                <span class="built_in">this</span>.factoryBeanObjectCache.put(beanName, (object != <span class="literal">null</span> ? object : NULL_OBJECT));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (object != NULL_OBJECT ? object : <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">doGetObjectFromFactoryBean</span><span class="params">(<span class="keyword">final</span> FactoryBean factory, <span class="keyword">final</span> String beanName)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> factory.getObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;FactoryBean threw exception on object[&quot;</span> + beanName + <span class="string">&quot;] creation&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ‰©å±• AbstractBeanFactory åˆ›å»ºå¯¹è±¡é€»è¾‘ï¼Œå°† åŸæœ¬ç»§æ‰¿DefaultSingletonBeanRegistry ä¿®æ”¹ä¸º ç»§æ‰¿ FactoryBeanRegistrySupportï¼Œå³åœ¨åŸæ¥çš„åŸºç¡€ä¸Šæ’å…¥ ä¸€ä¸ªé€»è¾‘å—ï¼Œè¿™æ ·å³æ–¹ä¾¿æ‰©å±•ä¹Ÿä¸å½±å“åŸæ¥çš„åŠŸèƒ½ã€‚æ–°å¢ getObjectForBeanInstance(beanInstance,beanName) æ–¹æ³• ï¼Œåˆ¤æ–­æ˜¯å¦å±äºFactoryBeanä»¥åŠè°ƒç”¨ getObjectFromFactoryBean æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦èƒ½è·å–FactoryBeanç¼“å­˜ä¸­çš„å¯¹è±¡ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">doGetBean</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> Object[] args)</span> &#123;</span><br><span class="line">  <span class="type">Object</span> <span class="variable">sharedInstance</span> <span class="operator">=</span> getSingleton(name);</span><br><span class="line">  <span class="keyword">if</span> (sharedInstance != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ FactoryBeanï¼Œåˆ™éœ€è¦è°ƒç”¨ FactoryBean.getObject</span></span><br><span class="line">    <span class="keyword">return</span> (T) getObjectForBeanInstance(sharedInstance, name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> getBeanDefinition(name);</span><br><span class="line">  <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> createBean(name, beanDefinition, args);</span><br><span class="line">  <span class="keyword">return</span> (T) getObjectForBeanInstance(bean, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">getObjectForBeanInstance</span><span class="params">(Object beanInstance, String beanName)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(beanInstance <span class="keyword">instanceof</span> FactoryBean)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beanInstance;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> getCachedObjectForFactoryBean(beanName);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</span><br><span class="line">    FactoryBean&lt;?&gt; factoryBean = (FactoryBean&lt;?&gt;) beanInstance;</span><br><span class="line">    object = getObjectFromFactoryBean(factoryBean, beanName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š-5"><a href="#ç»“æœï¼š-5" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><ol><li>é Singleton ç±»å‹çš„ Bean ä¸æ‰§è¡Œé”€æ¯æ–¹æ³•ï¼Œå•ä¾‹Beanåªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œä½¿ç”¨å®Œæˆä¹‹åä»£è¡¨æ•´ä¸ªç¨‹åºä¹Ÿå°±æ‰§è¡Œå®Œæ¯•ã€‚è€Œå…¶ä»–ç±»å‹åˆ™ä¸ä¸€å®šã€‚</li><li>FactoryBean é€šå¸¸ç”¨äºæ„é€ å…·æœ‰è®¸å¤šä¾èµ–é¡¹çš„å¤æ‚å¯¹è±¡ ã€‚</li><li>FactoryBeançš„ç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒå¯ä»¥å‘å®¹å™¨ä¸­æ³¨å†Œä¸¤ä¸ªBeanï¼Œä¸€ä¸ªæ˜¯å®ƒæœ¬èº«ï¼Œä¸€ä¸ªæ˜¯FactoryBean.getObject()æ–¹æ³•è¿”å›å€¼æ‰€ä»£è¡¨çš„ç›®æ ‡å¯¹è±¡ã€‚æœ¬demoä¸­åªå¯¹ç›®æ ‡å¯¹è±¡åšäº†è·å–ï¼ŒSpringæºç ä¸­ é€šè¿‡ &amp; + BeanName çš„å½¢å¼ è·å–åŸç”ŸFactoryBean å¯¹è±¡ ã€‚</li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step09.drawio.png" alt="step09.drawio"></p><h2 id="Step10ï¼šåœ¨é¢å‘ç”¨æˆ·çš„åº”ç”¨ä¸Šä¸‹æ–‡ä¸­è®¾è®¡äº‹ä»¶"><a href="#Step10ï¼šåœ¨é¢å‘ç”¨æˆ·çš„åº”ç”¨ä¸Šä¸‹æ–‡ä¸­è®¾è®¡äº‹ä»¶" class="headerlink" title="Step10ï¼šåœ¨é¢å‘ç”¨æˆ·çš„åº”ç”¨ä¸Šä¸‹æ–‡ä¸­è®¾è®¡äº‹ä»¶"></a>Step10ï¼šåœ¨é¢å‘ç”¨æˆ·çš„åº”ç”¨ä¸Šä¸‹æ–‡ä¸­è®¾è®¡äº‹ä»¶</h2><h3 id="å®ç°ï¼š-8"><a href="#å®ç°ï¼š-8" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>å®šä¹‰ ApplicationEvent æŠ½è±¡ç±»ï¼Œç»§æ‰¿äºjava.util.EventObject,ä»è€Œå…·å¤‡äº‹ä»¶åŠŸèƒ½ï¼Œæ‰€æœ‰çš„äº‹ä»¶ç±»éƒ½éœ€è¦ç»§æ‰¿è¯¥ç±»ã€‚</p></li><li><p>å®šä¹‰ä¸Šä¸‹æ–‡ä¸­çš„ äº‹ä»¶ç±» ApplicationContextEventï¼Œç»§æ‰¿äº ApplicationEvent ï¼Œå¹¶ æ–°å¢ getApplicationContext() è·å–äº‹ä»¶æ¥æº çš„æ–¹æ³•ï¼Œå®¹å™¨ä¸­çš„äº‹ä»¶ ä»¥åŠ ç”¨æˆ·è‡ªå®šä¹‰çš„äº‹ä»¶ éƒ½éœ€ç»§æ‰¿è¯¥ç±»ã€‚</p></li><li><p>å®šä¹‰ å®¹å™¨åˆ·æ–° ContextRefreshedEvent ä»¥åŠ å®¹å™¨å…³é—­ ContextClosedEvent äº‹ä»¶ç±»ã€‚</p></li><li><p>å®šä¹‰ ApplicationListener\<E extends ApplicationEvent> äº‹ä»¶ç›‘å¬å™¨ æ³›å‹æ¥å£ï¼Œæä¾› äº‹ä»¶å¤„ç† çš„æ–¹æ³•ã€‚ </p></li><li><p>å®šä¹‰ ApplicationEventMulticaster äº‹ä»¶å¤„ç†å™¨æ¥å£ï¼Œæä¾› æ·»åŠ ã€åˆ é™¤äº‹ä»¶ç›‘å¬å™¨ä»¥åŠå‘å¸ƒäº‹ä»¶ çš„æ–¹æ³•ã€‚</p></li><li><p>å®šä¹‰ AbstractApplicationEventMulticaster æŠ½è±¡ç±»ï¼Œ å®ç°ApplicationEventMulticaster ã€BeanFactoryAware æ¥å£ï¼Œæå–äº‹ä»¶å¤„ç†å™¨ä¸­å…¬ç”¨æ–¹æ³• æ·»åŠ ã€åˆ é™¤äº‹ä»¶ç›‘å¬å™¨ ä»¥åŠ æ„ŸçŸ¥ beanFactory çš„æ–¹æ³• å®ç°ï¼Œå¹¶ æ–°å¢ è¿‡æ»¤ç›‘å¬å™¨çš„æ–¹æ³•ï¼šä¸»è¦æ˜¯é€šè¿‡ è·å– ç›‘å¬å™¨æ¥å£ çš„ç±»å‹å‚æ•°ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦å¯ä»¥ä¸ event  è¿›è¡Œç›¸äº’è½¬æ¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.context.event;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactoryAware;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.ApplicationEvent;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.ApplicationListener;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.utils.ClassUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.ParameterizedType;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Type;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/1 21:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractApplicationEventMulticaster</span> <span class="keyword">implements</span> <span class="title class_">ApplicationEventMulticaster</span>, BeanFactoryAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Set&lt;ApplicationListener&lt;ApplicationEvent&gt;&gt; applicationListeners = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addApplicationListener</span><span class="params">(ApplicationListener&lt;?&gt; listener)</span> &#123;</span><br><span class="line">        applicationListeners.add((ApplicationListener&lt;ApplicationEvent&gt;) listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeApplicationListener</span><span class="params">(ApplicationListener&lt;?&gt; listener)</span> &#123;</span><br><span class="line">        applicationListeners.remove(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.beanFactory = beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return a Collection of ApplicationListeners matching the given</span></span><br><span class="line"><span class="comment">     * event type. Non-matching listeners get excluded early.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the event to be propagated. Allows for excluding</span></span><br><span class="line"><span class="comment">     * non-matching listeners early, based on cached matching information.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a Collection of ApplicationListeners</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> cn.ray.springframework.context.ApplicationListener</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Collection&lt;ApplicationListener&gt; <span class="title function_">getApplicationListeners</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">        LinkedList&lt;ApplicationListener&gt; allListeners = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ApplicationListener&lt;ApplicationEvent&gt; listener : applicationListeners) &#123;</span><br><span class="line">            <span class="keyword">if</span> (supportsEvent(listener, event)) allListeners.add(listener);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allListeners;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›‘å¬å™¨æ˜¯å¦å¯¹è¯¥äº‹ä»¶æ„Ÿå…´è¶£</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">supportsEvent</span><span class="params">(ApplicationListener&lt;ApplicationEvent&gt; applicationListener, ApplicationEvent event)</span> &#123;</span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationListener</span>&gt; listenerClass = applicationListener.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‰ç…§ CglibSubclassingInstantiationStrategyã€SimpleInstantiationStrategy ä¸åŒçš„å®ä¾‹åŒ–ç±»å‹ï¼Œéœ€è¦åˆ¤æ–­åè·å–ç›®æ ‡ class</span></span><br><span class="line">        Class&lt;?&gt; targetClass = ClassUtil.isCglibProxyClass(listenerClass) ? listenerClass.getSuperclass() : listenerClass;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Class.getGenericInterfaces()  è·å–è¯¥ç›®æ ‡å¯¹è±¡ç›´æ¥å®ç°çš„æ¥å£ç±»å‹æ•°ç»„</span></span><br><span class="line">        <span class="comment">// ApplicationEvent</span></span><br><span class="line">        <span class="type">Type</span> <span class="variable">genericInterface</span> <span class="operator">=</span> targetClass.getGenericInterfaces()[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// getActualTypeArguments() è·å–è¡¨ç¤ºæ­¤ç±»å‹å®é™…ç±»å‹å‚æ•°çš„ Type å¯¹è±¡çš„æ•°ç»„</span></span><br><span class="line">        <span class="comment">// å³ ApplicationEvent å®ç°çš„ å…·ä½“äº‹ä»¶ç±»å‹</span></span><br><span class="line">        <span class="type">Type</span> <span class="variable">actualTypeArgument</span> <span class="operator">=</span> ((ParameterizedType) genericInterface).getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> actualTypeArgument.getTypeName();</span><br><span class="line">        Class&lt;?&gt; eventClassName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            eventClassName = Class.forName(className);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;wrong event class name: &quot;</span> + className);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤å®šæ­¤ eventClassName å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£ä¸æŒ‡å®šçš„ event.getClass() å‚æ•°æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£æ˜¯å¦ç›¸åŒï¼Œæˆ–æ˜¯å¦æ˜¯å…¶çˆ¶ç±»æˆ–çˆ¶æ¥å£ã€‚</span></span><br><span class="line">        <span class="comment">// isAssignableFromæ˜¯ç”¨æ¥åˆ¤æ–­å­ç±»å’Œçˆ¶ç±»çš„å…³ç³»çš„ï¼Œæˆ–è€…æ¥å£çš„å®ç°ç±»å’Œæ¥å£çš„å…³ç³»çš„ï¼Œé»˜è®¤æ‰€æœ‰çš„ç±»çš„ç»ˆæçˆ¶ç±»éƒ½æ˜¯Objectã€‚å¦‚æœA.isAssignableFrom(B)ç»“æœæ˜¯trueï¼Œè¯æ˜Bå¯ä»¥è½¬æ¢æˆä¸ºA,ä¹Ÿå°±æ˜¯Aå¯ä»¥ç”±Bè½¬æ¢è€Œæ¥ã€‚</span></span><br><span class="line">        <span class="keyword">return</span> eventClassName.isAssignableFrom(event.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰ SimpleApplicationEventMulticaster ç±»ï¼Œç»§æ‰¿äºAbstractApplicationEventMulticaster æŠ½è±¡ç±»ï¼Œæä¾› æ„é€ å‡½æ•°æ„ŸçŸ¥BeanFactoryï¼Œå¹¶å®ç° ApplicationEventMulticaster äº‹ä»¶å¤„ç†å™¨ä¸­å‘å¸ƒäº‹ä»¶ çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.context.event;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.ApplicationEvent;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.ApplicationListener;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/1 21:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleApplicationEventMulticaster</span> <span class="keyword">extends</span> <span class="title class_">AbstractApplicationEventMulticaster</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleApplicationEventMulticaster</span><span class="params">(BeanFactory beanFactory)</span> &#123;</span><br><span class="line">        setBeanFactory(beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">multicastEvent</span><span class="params">(<span class="keyword">final</span> ApplicationEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> ApplicationListener listener : getApplicationListeners(event)) &#123;</span><br><span class="line">            listener.onApplicationEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰ ApplicationEventPublisher äº‹ä»¶å‘å¸ƒè€…æ¥å£ï¼Œæä¾› äº‹ä»¶çš„å‘å¸ƒæ–¹æ³•ã€‚</p></li><li><p>å®Œå–„ AbstractApplicationContextï¼Œæ–°å¢ publishEvent(ApplicationEvent) å‘å¸ƒäº‹ä»¶æ–¹æ³•ï¼Œå¹¶åœ¨åˆ·æ–°å®¹å™¨ refresh()æ–¹æ³•ä¸­ æ–°å¢ æ³¨å†Œäº‹ä»¶å‘å¸ƒè€…ã€æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ä»¥åŠå‘å¸ƒå®¹å™¨åˆ·æ–°äº‹ä»¶ çš„åŠ¨ä½œï¼Œä»¥åŠ å®Œå–„ close() æ–¹æ³•ï¼Œæ–°å¢ å‘å¸ƒå®¹å™¨å…³é—­äº‹ä»¶ çš„æ–¹æ³•ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.context.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanFactoryPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.ApplicationEvent;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.ApplicationListener;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.event.ApplicationEventMulticaster;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.event.ContextClosedEvent;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.event.ContextRefreshedEvent;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.context.event.SimpleApplicationEventMulticaster;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.core.io.DefaultResourceLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/21 22:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractApplicationContext</span> <span class="keyword">extends</span> <span class="title class_">DefaultResourceLoader</span> <span class="keyword">implements</span> <span class="title class_">ConfigurableApplicationContext</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;applicationEventMulticaster&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationEventMulticaster applicationEventMulticaster;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// 1. åˆ›å»º BeanFactoryï¼Œå¹¶åŠ è½½ BeanDefinition</span></span><br><span class="line">        refreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è·å– BeanFactory</span></span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. æ·»åŠ  ApplicationContextAwareProcessorï¼Œè®©ç»§æ‰¿è‡ª ApplicationContextAware çš„ Bean å¯¹è±¡éƒ½èƒ½æ„ŸçŸ¥æ‰€å±çš„ ApplicationContext</span></span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationContextAwareProcessor</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ‰§è¡Œ BeanFactoryPostProcessor (Invoke factory processors registered as beans in the context.)</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. BeanPostProcessor éœ€è¦æå‰äºå…¶ä»– Bean å¯¹è±¡å®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œæ³¨å†Œæ“ä½œ</span></span><br><span class="line">        registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. æ³¨å†Œäº‹ä»¶å‘å¸ƒè€…</span></span><br><span class="line">        initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. æ·»åŠ äº‹ä»¶ç›‘å¬å™¨</span></span><br><span class="line">        registerListeners();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. æå‰å®ä¾‹åŒ–å•ä¾‹Beanå¯¹è±¡</span></span><br><span class="line">        beanFactory.preInstantiateSingletons();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 9. å‘å¸ƒå®¹å™¨åˆ·æ–°å®Œæˆäº‹ä»¶</span></span><br><span class="line">        finishRefresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> ConfigurableListableBeanFactory <span class="title function_">getBeanFactory</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">        Map&lt;String, BeanFactoryPostProcessor&gt; beanFactoryPostProcessorMap = beanFactory.getBeansOfType(BeanFactoryPostProcessor.class);</span><br><span class="line">        <span class="keyword">for</span> (BeanFactoryPostProcessor beanFactoryPostProcessor : beanFactoryPostProcessorMap.values()) &#123;</span><br><span class="line">            beanFactoryPostProcessor.postProcessBeanFactory(beanFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">        Map&lt;String, BeanPostProcessor&gt; beanPostProcessorMap = beanFactory.getBeansOfType(BeanPostProcessor.class);</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor beanPostProcessor : beanPostProcessorMap.values()) &#123;</span><br><span class="line">            beanFactory.addBeanPostProcessor(beanPostProcessor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initApplicationEventMulticaster</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line">        applicationEventMulticaster = <span class="keyword">new</span> <span class="title class_">SimpleApplicationEventMulticaster</span>(beanFactory);</span><br><span class="line">        beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, applicationEventMulticaster);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerListeners</span><span class="params">()</span> &#123;</span><br><span class="line">        Collection&lt;ApplicationListener&gt; applicationListeners = getBeansOfType(ApplicationListener.class).values();</span><br><span class="line">        <span class="keyword">for</span> (ApplicationListener listener : applicationListeners) &#123;</span><br><span class="line">            applicationEventMulticaster.addApplicationListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publishEvent</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">        applicationEventMulticaster.multicastEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">finishRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">        publishEvent(<span class="keyword">new</span> <span class="title class_">ContextRefreshedEvent</span>(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Map&lt;String, T&gt; <span class="title function_">getBeansOfType</span><span class="params">(Class&lt;T&gt; type)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeansOfType(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getBeanDefinitionNames() &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeanDefinitionNames();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getBean</span><span class="params">(String name, Object... args)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(name, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(String name, Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(name, requiredType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerShutdownHook</span><span class="params">()</span> &#123;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>::close));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å‘å¸ƒå®¹å™¨å…³é—­äº‹ä»¶</span></span><br><span class="line">        publishEvent(<span class="keyword">new</span> <span class="title class_">ContextClosedEvent</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">        getBeanFactory().destroySingletons();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š-6"><a href="#ç»“æœï¼š-6" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><ol><li>è¿‡æ»¤ç›‘å¬å™¨ä¸»è¦æ˜¯åˆ¤å®šæ­¤ eventClassName å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£ä¸æŒ‡å®šçš„ event.getClass() å‚æ•°æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£æ˜¯å¦ç›¸åŒï¼Œæˆ–æ˜¯å¦æ˜¯å…¶çˆ¶ç±»æˆ–çˆ¶æ¥å£ã€‚ é¦–å…ˆè·å–ä¸åŒå®ä¾‹åŒ–å¯¹è±¡çš„Classï¼ŒCglibä»£ç†ç±»éœ€è¦è·å–çˆ¶ç±»Classï¼Œæ™®é€šçš„åˆ™ä¸éœ€è¦ï¼Œåœ¨è·å–åˆ°Classä¹‹åé€šè¿‡æå–æ¥å£ .getGenericInterfaces() å’Œå¯¹åº”çš„ç±»å‹å‚æ•° .getActualTypeArguments() ä»¥åŠeventClassNameï¼Œæœ€åä¸å…¥å‚ä¸­çš„eventè¿›è¡Œ isAssignableFrom åˆ¤æ–­ã€‚</li><li>isAssignableFromæ˜¯ç”¨æ¥åˆ¤æ–­å­ç±»å’Œçˆ¶ç±»çš„å…³ç³»çš„ï¼Œæˆ–è€…æ¥å£çš„å®ç°ç±»å’Œæ¥å£çš„å…³ç³»çš„ï¼Œé»˜è®¤æ‰€æœ‰çš„ç±»çš„ç»ˆæçˆ¶ç±»éƒ½æ˜¯Objectã€‚å¦‚æœA.isAssignableFrom(B)ç»“æœæ˜¯trueï¼Œè¯æ˜Bå¯ä»¥è½¬æ¢æˆä¸ºA å³ Bä¸AåŒç±» æˆ– Aæ˜¯Bçš„çˆ¶ç±»ã€‚</li><li>IOC é˜¶æ®µå®Œæˆï¼</li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step10.drawio.png" alt="step10.drawio"></p><h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><h2 id="Step11ï¼šåŸºäºJDKã€CglibåŠ¨æ€ä»£ç†å®ç°AOPåˆ‡é¢"><a href="#Step11ï¼šåŸºäºJDKã€CglibåŠ¨æ€ä»£ç†å®ç°AOPåˆ‡é¢" class="headerlink" title="Step11ï¼šåŸºäºJDKã€CglibåŠ¨æ€ä»£ç†å®ç°AOPåˆ‡é¢"></a>Step11ï¼šåŸºäºJDKã€CglibåŠ¨æ€ä»£ç†å®ç°AOPåˆ‡é¢</h2><h3 id="å‡†å¤‡ï¼š-1"><a href="#å‡†å¤‡ï¼š-1" class="headerlink" title="å‡†å¤‡ï¼š"></a>å‡†å¤‡ï¼š</h3><ol><li><p>è¿æ¥ç‚¹(JoinPoint) ï¼šç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä»»æ„ä½ç½®ã€‚æ¯”å¦‚ æ–¹æ³•æ‰§è¡Œã€è®¾ç½®å˜é‡ã€æŠ›å‡ºå¼‚å¸¸ç­‰ã€‚ </p></li><li><p>åˆ‡å…¥ç‚¹(Pointcut) ï¼šåŒ¹é…è¿æ¥ç‚¹çš„è¡¨è¾¾å¼ã€‚ä¸€èˆ¬æ˜¯ï¼šä¸€ä¸ªå…·ä½“çš„æ–¹æ³•æˆ–è€…åŒ¹é…å¤šä¸ªæ–¹æ³•ã€‚ </p><p>Tipsï¼šè¿æ¥ç‚¹èŒƒå›´æ¯”åˆ‡å…¥ç‚¹å¤§ï¼Œåˆ‡å…¥ç‚¹çš„æ–¹æ³•ä¸€å®šæ˜¯è¢«å¢å¼ºçš„ï¼Œå³æ˜¯åˆ‡å…¥ç‚¹çš„æ–¹æ³•ä¸€å®šæ˜¯è¿æ¥ç‚¹çš„ï¼Œä½†æ˜¯è¿æ¥ç‚¹çš„æ–¹æ³•ä¸ä¸€å®šæ˜¯åˆ‡å…¥ç‚¹çš„ï¼Œå› ä¸ºå­˜åœ¨ è¿æ¥ç‚¹çš„æ–¹æ³• ä¸è¢«å¢å¼º çš„å¯èƒ½ã€‚ </p></li><li><p>é€šçŸ¥(Advice) ï¼šåœ¨åˆ‡å…¥ç‚¹æ‰§è¡Œçš„æ“ä½œï¼Œå³å…±æ€§åŠŸèƒ½ï¼Œå³æ‹¦æˆªæ–¹æ³•ã€‚</p></li><li><p>é€šçŸ¥ç±» ï¼šå®šä¹‰é€šçŸ¥çš„ç±»ã€‚</p></li><li><p>åˆ‡é¢(Aspect) ï¼šæè¿°é€šçŸ¥ä¸åˆ‡å…¥ç‚¹çš„å…³ç³»ã€‚</p></li></ol><h3 id="å®ç°ï¼š-9"><a href="#å®ç°ï¼š-9" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>å®šä¹‰ç±»è¿‡æ»¤å™¨ ClassFilter æ¥å£ä»¥åŠæ–¹æ³•åŒ¹é…å™¨ MethodMatcher æ¥å£ã€‚åˆ†åˆ«æä¾› matches(Class&lt;?&gt; clazz) æ£€æŸ¥è¡¨è¾¾å¼åŒ¹é…èŒƒå›´å†…æ˜¯å¦å­˜åœ¨ç»™å®šçš„ç›®æ ‡ç±» ä»¥åŠ matches(Method method, Class&lt;? targetClass) æ£€æŸ¥è¡¨è¾¾å¼åŒ¹é…èŒƒå›´å†…æ˜¯å¦å­˜åœ¨ç»™å®šçš„ç›®æ ‡ç±»çš„ç»™å®šæ–¹æ³• çš„æ–¹æ³•ã€‚</p></li><li><p>å®šä¹‰åˆ‡å…¥ç‚¹ Pointcut æ¥å£ï¼Œæä¾›è·å– ClassFilter ä»¥åŠ MethodMatcher çš„æ–¹æ³•ã€‚</p></li><li><p>å®šä¹‰åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ç±» AspectJExpressionPointcut ï¼Œå®ç° ClassFilterã€MethodMatcher ä»¥åŠ Pointcut æ¥å£ï¼Œåˆ©ç”¨ aspectjåŒ… æä¾›çš„è¡¨è¾¾å¼æ ¡éªŒæ–¹æ³•å®ç° åŒ¹é…æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.aop.aspectj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.ClassFilter;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.MethodMatcher;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.PointCut;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.weaver.tools.PointcutExpression;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.weaver.tools.PointcutParser;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.weaver.tools.PointcutPrimitive;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/4 20:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AspectJExpressionPointcut</span> <span class="keyword">implements</span> <span class="title class_">PointCut</span>, ClassFilter, MethodMatcher &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;PointcutPrimitive&gt; SUPPORTED_PRIMITIVES = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;PointcutPrimitive&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SUPPORTED_PRIMITIVES.add(PointcutPrimitive.EXECUTION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PointcutExpression pointcutExpression;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AspectJExpressionPointcut</span><span class="params">(String expression)</span> &#123;</span><br><span class="line">        <span class="type">PointcutParser</span> <span class="variable">pointcutParser</span> <span class="operator">=</span> PointcutParser.getPointcutParserSupportingSpecifiedPrimitivesAndUsingSpecifiedClassLoaderForResolution(SUPPORTED_PRIMITIVES, <span class="built_in">this</span>.getClass().getClassLoader());</span><br><span class="line">        pointcutExpression = pointcutParser.parsePointcutExpression(expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pointcutExpression.couldMatchJoinPointsInType(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(Method method, Class&lt;?&gt; targetClass)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pointcutExpression.matchesMethodExecution(method).alwaysMatches();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ClassFilter <span class="title function_">getClassFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodMatcher <span class="title function_">getMethodMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰ç›®æ ‡å¯¹è±¡ TargetSource ç±»ï¼Œé€šè¿‡æ„é€ å‡½æ•°çš„æ–¹å¼ä¼ å…¥ç›®æ ‡å¯¹è±¡ï¼Œå¹¶æä¾› è·å–ç›®æ ‡å¯¹è±¡åŠå…¶å®ç°æ¥å£åˆ—è¡¨ çš„æ–¹æ³•ã€‚</p></li><li><p>å®šä¹‰ åˆ‡é¢é€šçŸ¥ä¿¡æ¯ AdvisedSupport ç±»ï¼Œå°† ç›®æ ‡å¯¹è±¡ TargetSource ã€æ–¹æ³•æ‹¦æˆªå™¨ MethodInterceptorã€æ–¹æ³•åŒ¹é…å™¨ MethodMatcher è¿›è¡ŒåŒ…è£…ã€‚</p></li><li><p>å®šä¹‰æ ‡å‡†æ¥å£ AopProxy ï¼Œç”¨äºç»Ÿä¸€JDKã€Cglibå®ç°ç±» è·å–ä»£ç†ç±»ã€‚</p></li><li><p>å®šä¹‰åå°„æ–¹æ³•è°ƒç”¨ ReflectiveMethodInvocation ç±»ï¼Œå°† ç›®æ ‡å¯¹è±¡ã€æ–¹æ³•ã€å…¥å‚ è¿›è¡ŒåŒ…è£…å¹¶æä¾›ä¸€ä¸ªç›´æ¥åå°„è°ƒç”¨çš„æ–¹æ³• method.invoke(target, arguments) ã€‚</p></li><li><p>å®šä¹‰ JDKå®ç°ä»£ç† JdkDynamicAopProxy ç±»ï¼Œå®ç° AopProxy, InvocationHandler ï¼Œå®ç° getProxy() è·å–ä»£ç†ç±» ä»¥åŠ invoke(Object proxy, Method method, Object[] args) åå°„è°ƒç”¨æ–¹æ³•ã€‚</p><ol><li>invoke æ–¹æ³• ä¸»è¦å¤„ç†åŒ¹é…æ–¹æ³•åï¼Œä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å®ç°ï¼ŒåšmethodInterceptor.invoke(new ReflectiveMethodInvocation(advised.getTargetSource().getTarget(), method, args) åå°„è°ƒç”¨ã€‚</li><li>getProxy æ–¹æ³• ä½¿ç”¨Proxyç±»çš„newProxyInstanceæ–¹æ³•æ¥è·å–ä¸€ä¸ªä»£ç†ç±»å®ä¾‹ã€‚å› ä¸ºå®ç°äº† InvocationHandlerï¼Œæ­¤æ—¶è°ƒç”¨å¤„ç†å™¨ä¸º this ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.aop.framework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.AdvisedSupport;</span><br><span class="line"><span class="keyword">import</span> org.aopalliance.intercept.MethodInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/4 22:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdkDynamicAopProxy</span> <span class="keyword">implements</span> <span class="title class_">AopProxy</span>, InvocationHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdvisedSupport advised;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JdkDynamicAopProxy</span><span class="params">(AdvisedSupport advised)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.advised = advised;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getProxy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),advised.getTargetSource().getTargetClass(),<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (advised.getMethodMatcher().matches(method, advised.getTargetSource().getTarget().getClass())) &#123;</span><br><span class="line">            <span class="type">MethodInterceptor</span> <span class="variable">methodInterceptor</span> <span class="operator">=</span> advised.getMethodInterceptor();</span><br><span class="line">            <span class="keyword">return</span> methodInterceptor.invoke(<span class="keyword">new</span> <span class="title class_">ReflectiveMethodInvocation</span>(advised.getTargetSource().getTarget(), method, args));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(advised.getTargetSource().getTarget(), args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰ Cglibå®ç°ä»£ç† Cglib2AopProxy ç±»ï¼Œå®ç° AopProxy æ¥å£ ï¼Œä¸»è¦é€šè¿‡ Enhancer ç”Ÿæˆä»£ç†å¯¹è±¡ å®ç° getProxy() è·å–ä»£ç†ç±» çš„æ–¹æ³•ã€‚</p><ol><li>æ–¹æ³•æ‹¦æˆª åˆ™æ˜¯åœ¨ enhancer.setCallback() ä¸­å¤„ç†ã€‚è¿™é‡Œå®šä¹‰äº†ä¸¤ä¸ªå†…éƒ¨ç±»ï¼ŒDynamicAdvisedInterceptor å’Œ CglibMethodInvocation ã€‚</li><li>DynamicAdvisedInterceptor å®ç° MethodInterceptor æ¥å£ï¼Œå¹¶å®ç° intercept(Object, Method, Object[] , MethodProxy) æ¥å£ ï¼Œä¸»è¦å¤„ç†åŒ¹é…æ–¹æ³•åï¼Œä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å®ç°ï¼Œåšadvised.getMethodInterceptor().invoke(methodInvocation) ã€‚</li><li>CglibMethodInvocation åˆ™æ˜¯ç»§æ‰¿äº† ReflectiveMethodInvocation ï¼Œå°† MethodProxy ä¹Ÿè¿›è¡Œäº†åŒ…è£…ï¼Œå¹¶ä¸”é‡å†™äº† proceed() æ–¹æ³• ï¼š this.methodProxy.invoke(this.target, this.arguments) ã€‚ </li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.aop.framework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.AdvisedSupport;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Enhancer;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodProxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/4 22:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cglib2AopProxy</span> <span class="keyword">implements</span> <span class="title class_">AopProxy</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdvisedSupport advised;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Cglib2AopProxy</span><span class="params">(AdvisedSupport advised)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.advised = advised;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getProxy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">        enhancer.setSuperclass(advised.getTargetSource().getTarget().getClass());</span><br><span class="line">        enhancer.setInterfaces(advised.getTargetSource().getTargetClass());</span><br><span class="line">        enhancer.setCallback(<span class="keyword">new</span> <span class="title class_">DynamicAdvisedInterceptor</span>(advised));</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DynamicAdvisedInterceptor</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AdvisedSupport advised;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">DynamicAdvisedInterceptor</span><span class="params">(AdvisedSupport advised)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.advised = advised;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="type">CglibMethodInvocation</span> <span class="variable">methodInvocation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CglibMethodInvocation</span>(advised.getTargetSource().getTarget(), method, objects, methodProxy);</span><br><span class="line">            <span class="keyword">if</span> (advised.getMethodMatcher().matches(method, advised.getTargetSource().getTarget().getClass())) &#123;</span><br><span class="line">                <span class="keyword">return</span> advised.getMethodInterceptor().invoke(methodInvocation);</span><br><span class="line">                <span class="comment">//return advised.getMethodInterceptor().invoke(new ReflectiveMethodInvocation(advised.getTargetSource().getTarget(), method, objects));</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> methodInvocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CglibMethodInvocation</span> <span class="keyword">extends</span> <span class="title class_">ReflectiveMethodInvocation</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MethodProxy methodProxy;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">CglibMethodInvocation</span><span class="params">(Object target, Method method, Object[] arguments, MethodProxy methodProxy)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(target, method, arguments);</span><br><span class="line">            <span class="built_in">this</span>.methodProxy = methodProxy;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.methodProxy.invoke(<span class="built_in">this</span>.target, <span class="built_in">this</span>.arguments);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š-7"><a href="#ç»“æœï¼š-7" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><ol><li><p>æ–¹æ³•æ‹¦æˆªå™¨ ä¸»è¦é‡å†™invokeæ–¹æ³•ï¼Œå¤„ç†è‡ªå®šä¹‰çš„æ–°å¢å®ç°ï¼ˆé€šçŸ¥ï¼‰å¹¶è¿›è¡Œåå°„è°ƒç”¨æ”¾è¡Œã€‚</p></li><li><p>æ•´ä¸ªæµç¨‹å¤§æ¦‚å°±æ˜¯ å…ˆåœ¨JDKæˆ–CglibåŠ¨æ€ä»£ç†è¿‡ç¨‹ä¸­ï¼Œå¢åŠ æ–¹æ³•æ‹¦æˆªå™¨ï¼Œé€šè¿‡åˆ‡å…¥ç‚¹åŒ¹é…èŒƒå›´åˆ¤æ–­æ˜¯å¦ä½¿ç”¨æ‹¦æˆªå™¨è¿›è¡Œåå°„è°ƒç”¨ï¼Œä¹‹åè·å–åˆ°ä»£ç†ç±»è¿›è¡Œæ“ä½œã€‚ </p></li><li><p>ä¸ç†è§£ 9.3 ä¸­ ä¸ºä»€ä¹ˆç”¨åˆ°äº† CglibMethodInvocation ï¼Œæˆ‘è‡ªå·±è¯•äº†ä¸€ä¸‹ç›´æ¥new ReflectiveMethodInvocation ä¹Ÿèƒ½è¿è¡ŒæˆåŠŸï¼Œè€—æ—¶ä¹Ÿæ›´çŸ­ã€‚</p><p>å…·ä½“åŒºåˆ«å¯çœ‹ä»¥ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š</p><ul><li><a href="https://blog.csdn.net/psd0503/article/details/107116881">https://blog.csdn.net/psd0503/article/details/107116881</a></li><li><a href="https://www.cnblogs.com/xy7112/p/16400997.html">https://www.cnblogs.com/xy7112/p/16400997.html</a></li></ul></li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step11.drawio.png" alt="step11-ç¬¬ 3 é¡µ.drawio"></p><h2 id="Step12ï¼šåˆ©ç”¨-BeanPostProcessor-å°†AOPæ‰©å±•åˆ°Beançš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Step12ï¼šåˆ©ç”¨-BeanPostProcessor-å°†AOPæ‰©å±•åˆ°Beançš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Step12ï¼šåˆ©ç”¨ BeanPostProcessor å°†AOPæ‰©å±•åˆ°Beançš„ç”Ÿå‘½å‘¨æœŸ"></a>Step12ï¼šåˆ©ç”¨ BeanPostProcessor å°†AOPæ‰©å±•åˆ°Beançš„ç”Ÿå‘½å‘¨æœŸ</h2><h3 id="å®ç°ï¼š-10"><a href="#å®ç°ï¼š-10" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>å®šä¹‰ Adviceé€šçŸ¥ æ‹¦æˆªå™¨é“¾ã€‚ </p><ol><li>å®šä¹‰ BeforeAdvice æ¥å£ç»§æ‰¿äº Adviceï¼Œç”¨äºå½’çº³æ•´ç†ã€‚</li><li>å®šä¹‰ MethodBeforeAdvice æ¥å£ç»§æ‰¿äº BeforeAdvice ï¼Œå¹¶æä¾› before åœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰æ‰§è¡Œæ‹¦æˆªæ–¹æ³• çš„æ“ä½œï¼Œåç»­ç”¨æˆ·è‡ªå®šä¹‰æ‹¦æˆªæ–¹æ³•å®ç°è¯¥æ¥å£å³å¯ã€‚</li></ol></li><li><p>å®šä¹‰ MethodBeforeAdviceInterceptor æ–¹æ³•æ‹¦æˆªå™¨ï¼Œå®ç° MethodInterceptor æ¥å£ï¼Œå¹¶ åœ¨å…¶ invoke(MethodInvocation) æ–¹æ³•ä¸­ è°ƒç”¨ MethodBeforeAdvice çš„before æ–¹æ³•ã€‚ </p></li><li><p>å®šä¹‰ å„çº§è®¿é—®è€…ã€‚  </p><ol><li>å®šä¹‰ Advisor é€šçŸ¥è®¿é—®è€… æ¥å£ï¼Œæä¾› è·å–é€šçŸ¥ getAdvice çš„æ–¹æ³•ã€‚</li><li>å®šä¹‰ PointcutAdvisor åˆ‡å…¥ç‚¹è®¿é—®è€… ï¼Œå®ç° Advisor é€šçŸ¥è®¿é—®è€… æ¥å£ï¼Œå¹¶æä¾› è·å–é©±åŠ¨è¿™ä¸ªé€šçŸ¥çš„åˆ‡å…¥ getPointcut çš„æ–¹æ³•ã€‚</li><li>å®šä¹‰ AspectJExpressionPointcutAdvisor åˆ‡é¢è®¿é—®è€… ç±»ï¼Œå®ç° PointcutAdvisor åˆ‡å…¥ç‚¹è®¿é—®è€…  ï¼Œ å¹¶å®ç° è·å–é€šçŸ¥ ã€ è·å–åˆ‡é¢ çš„æ–¹æ³•ï¼Œå°† åˆ‡é¢  AspectJExpressionPointcut ï¼Œé€šçŸ¥ Advice ä»¥åŠ å…·ä½“çš„æ‹¦æˆªè¡¨è¾¾å¼ è¿›è¡ŒåŒ…è£…åœ¨ä¸€èµ·ï¼Œåç»­å°±å¯é…ç½® XMLæ–‡ä»¶ å°†å…¶æ³¨å…¥å®¹å™¨ä¸­ï¼Œä»¥ä¾›åç»­ä½¿ç”¨ã€‚ </li></ol></li><li><p>å®šä¹‰ ProxyFacotry ä»£ç†å·¥å‚ï¼Œé€šè¿‡ AdvisedSupport æä¾›çš„é…ç½®ä¿¡æ¯ é€‰æ‹©æŒ‡å®šä»£ç†æ–¹å¼ è¿”å›ä»£ç†å¯¹è±¡ã€‚ </p></li><li><p>å®šä¹‰ InstantiationAwareBeanPostProcessor æ¥å£ï¼Œè¯¥æ¥å£ç»§æ‰¿äº BeanPostProcessorï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ æ‰©å±• BeanPostProcessor çš„å±‚æ¬¡æ¥å£ï¼Œæä¾›äº† åœ¨Beanå®ä¾‹åŒ–ä¹‹å‰çš„æ“ä½œ æ–¹æ³•ã€‚ </p></li><li><p>å®šä¹‰ DefaultAdvisorAutoProxyCreator è‡ªåŠ¨ä»£ç†åˆ›å»ºè€…ï¼Œå®ç° InstantiationAwareBeanPostProcessorã€BeanFactoryAware æ¥å£ï¼Œä½¿å…¶å¯ä»¥ä¼˜å…ˆæ³¨å†Œå¹¶åœ¨åˆå§‹åŒ–å‰æ„ŸçŸ¥å®¹å™¨ä¸­çš„BeanFactoryï¼Œåœ¨ä¹‹åé€šè¿‡BeanFactoryè·å– æ³¨å†Œçš„ åˆ‡é¢è®¿é—®è€… AspectJExpressionPointcutAdvisorï¼Œç„¶åé€šè¿‡ åˆ‡é¢è®¿é—®è€… è¿›è¡Œé…ç½® AdvisedSupport ï¼Œæœ€ç»ˆreturn new ProxyFactory(advisedSupport).getProxy() è¿”å› ä»£ç†å·¥å‚ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.aop.framework.autoproxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.*;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.aspectj.AspectJExpressionPointcutAdvisor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.framework.ProxyFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactoryAware;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.support.DefaultListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.aopalliance.aop.Advice;</span><br><span class="line"><span class="keyword">import</span> org.aopalliance.intercept.MethodInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 20:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultAdvisorAutoProxyCreator</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryAware</span>,InstantiationAwareBeanPostProcessor &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="built_in">this</span>.beanFactory = (DefaultListableBeanFactory) beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isInfrastructureClass</span><span class="params">(Class&lt;?&gt; beanClass)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Advice.class.isAssignableFrom(beanClass) || Pointcut.class.isAssignableFrom(beanClass) || Advisor.class.isAssignableFrom(beanClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (isInfrastructureClass(beanClass)) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        Collection&lt;AspectJExpressionPointcutAdvisor&gt; advisors = beanFactory.getBeansOfType(AspectJExpressionPointcutAdvisor.class).values();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (AspectJExpressionPointcutAdvisor advisor : advisors) &#123;</span><br><span class="line">            <span class="type">ClassFilter</span> <span class="variable">classFilter</span> <span class="operator">=</span> advisor.getPointcut().getClassFilter();</span><br><span class="line">            <span class="keyword">if</span> (!classFilter.matches(beanClass)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">AdvisedSupport</span> <span class="variable">advisedSupport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvisedSupport</span>();</span><br><span class="line"></span><br><span class="line">            <span class="type">TargetSource</span> <span class="variable">targetSource</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                targetSource = <span class="keyword">new</span> <span class="title class_">TargetSource</span>(beanClass.getDeclaredConstructor().newInstance());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            advisedSupport.setTargetSource(targetSource);</span><br><span class="line">            advisedSupport.setMethodInterceptor((MethodInterceptor) advisor.getAdvice());</span><br><span class="line">            advisedSupport.setMethodMatcher(advisor.getPointcut().getMethodMatcher());</span><br><span class="line">            advisedSupport.setProxyTargetClass(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProxyFactory</span>(advisedSupport).getProxy();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®Œå–„ AbstractAutowireCapableBeanFactory çš„ createBean æ–¹æ³•ï¼Œåœ¨ Beanå®ä¾‹åŒ–ä¹‹å‰ï¼Œåˆ¤æ–­ æ˜¯å¦è¿”å›ä»£ç†å¯¹è±¡ ï¼Œå³ å®ä¾‹åŒ–ä¹‹å‰çš„BeanPostProcessor å³InstantiationAwareBeanPostProcessor æ˜¯å¦å­˜åœ¨ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.beans.factory.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValue;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValues;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.*;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/15 17:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractBeanFactory</span> <span class="keyword">implements</span> <span class="title class_">AutowireCapableBeanFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">InstantiationStrategy</span> <span class="variable">instantiationStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CglibSubclassingInstantiationStrategy</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> InstantiationStrategy <span class="title function_">getInstantiationStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instantiationStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInstantiationStrategy</span><span class="params">(InstantiationStrategy instantiationStrategy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.instantiationStrategy = instantiationStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, BeanDefinition beanDefinition, Object[] args)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦è¿”å›ä»£ç† Bean å¯¹è±¡</span></span><br><span class="line">            bean = resolveBeforeInstantiation(beanName, beanDefinition);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != bean) &#123;</span><br><span class="line">                <span class="keyword">return</span> bean;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å®ä¾‹åŒ–bean</span></span><br><span class="line">            bean = createBeanInstance(beanDefinition, beanName, args);</span><br><span class="line">            <span class="comment">// å¡«å……å±æ€§</span></span><br><span class="line">            applyPropertyValues(beanName, bean, beanDefinition);</span><br><span class="line">            <span class="comment">// æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•</span></span><br><span class="line">            bean = initializeBean(beanName,bean,beanDefinition);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Instantiation of bean failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å†Œå®ç°äº† DisposableBean æ¥å£çš„ Bean å¯¹è±¡</span></span><br><span class="line">        registerDisposableBeanIfNecessary(beanName,bean,beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­ SCOPE_SINGLETONã€SCOPE_PROTOTYPE</span></span><br><span class="line">        <span class="keyword">if</span> (beanDefinition.isSingleton()) &#123;</span><br><span class="line">            registerSingleton(beanName, bean);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">resolveBeforeInstantiation</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> applyBeanPostProcessorsBeforeInstantiation(beanDefinition.getBeanClass(), beanName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != bean) &#123;</span><br><span class="line">            bean = applyBeanPostProcessorsAfterInitialization(bean, beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">applyBeanPostProcessorsBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor beanPostProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanPostProcessor <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> ((InstantiationAwareBeanPostProcessor) beanPostProcessor).postProcessBeforeInstantiation(beanClass, beanName);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != result) <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerDisposableBeanIfNecessary</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é Singleton ç±»å‹çš„ Bean ä¸æ‰§è¡Œé”€æ¯æ–¹æ³•ï¼Œå•ä¾‹Beanåªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œä½¿ç”¨å®Œæˆä¹‹åä»£è¡¨æ•´ä¸ªç¨‹åºä¹Ÿå°±æ‰§è¡Œå®Œæ¯•ã€‚è€ŒåŸå‹åˆ™ä¸ä¸€å®šã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!beanDefinition.isSingleton()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> DisposableBean || StrUtil.isNotEmpty(beanDefinition.getDestroyMethodName())) &#123;</span><br><span class="line">            registerDisposableBean(beanName, <span class="keyword">new</span> <span class="title class_">DisposableBeanAdapter</span>(bean, beanName, beanDefinition));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">createBeanInstance</span><span class="params">(BeanDefinition beanDefinition, String beanName, Object[] args)</span> &#123;</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructorToUse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Class&lt;?&gt; beanClass = beanDefinition.getBeanClass();</span><br><span class="line">        Constructor&lt;?&gt;[] declaredConstructors = beanClass.getDeclaredConstructors(); <span class="comment">// è·å–æ„é€ å‡½æ•°çš„ä¸ªæ•°</span></span><br><span class="line">        <span class="keyword">for</span> (Constructor ctor : declaredConstructors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != args &amp;&amp; ctor.getParameterTypes().length == args.length) &#123; <span class="comment">// ç®€å•æ¯”å¯¹å…¥å‚ä¸ªæ•°</span></span><br><span class="line">                constructorToUse = ctor;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getInstantiationStrategy().instantiate(beanDefinition, beanName, constructorToUse, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bean å±æ€§å¡«å……</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">applyPropertyValues</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> beanDefinition.getPropertyValues();</span><br><span class="line">            <span class="keyword">for</span> (PropertyValue propertyValue : propertyValues.getPropertyValues()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> propertyValue.getName();</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> propertyValue.getValue();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BeanReference) &#123;</span><br><span class="line">                    <span class="comment">// A ä¾èµ– Bï¼Œè·å– B çš„å®ä¾‹åŒ–</span></span><br><span class="line">                    <span class="type">BeanReference</span> <span class="variable">beanReference</span> <span class="operator">=</span> (BeanReference) value;</span><br><span class="line">                    value = getBean(beanReference.getBeanName());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å±æ€§å¡«å……</span></span><br><span class="line">                BeanUtil.setFieldValue(bean, name, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Error setting property valuesï¼š&quot;</span> + beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">initializeBean</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// invokeAwareMethods</span></span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanFactoryAware) &#123;</span><br><span class="line">                ((BeanFactoryAware) bean).setBeanFactory(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanClassLoaderAware)&#123;</span><br><span class="line">                ((BeanClassLoaderAware) bean).setBeanClassLoader(getBeanClassLoader());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanNameAware) &#123;</span><br><span class="line">                ((BeanNameAware) bean).setBeanName(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. æ‰§è¡Œ BeanPostProcessor Before å¤„ç†</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> applyBeanPostProcessorsBeforeInitialization(bean, beanName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾…å®Œæˆå†…å®¹ï¼šinvokeInitMethods(beanName, wrappedBean, beanDefinition);</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            invokeInitMethods(beanName, wrappedBean, beanDefinition);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Invocation of init method of bean[&quot;</span> + beanName + <span class="string">&quot;] failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. æ‰§è¡Œ BeanPostProcessor After å¤„ç†</span></span><br><span class="line">        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">        <span class="keyword">return</span> wrappedBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokeInitMethods</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. å®ç°æ¥å£ InitializingBean</span></span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> InitializingBean) &#123;</span><br><span class="line">            ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. æ³¨è§£é…ç½® init-method &#123;åˆ¤æ–­æ˜¯ä¸ºäº†é¿å…äºŒæ¬¡æ‰§è¡Œåˆå§‹åŒ–&#125;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">initMethodName</span> <span class="operator">=</span> beanDefinition.getInitMethodName();</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotEmpty(initMethodName) &amp;&amp; !(bean <span class="keyword">instanceof</span> InitializingBean)) &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">initMethod</span> <span class="operator">=</span> beanDefinition.getBeanClass().getMethod(initMethodName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == initMethod) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Could not find an init method named &#x27;&quot;</span> + initMethodName + <span class="string">&quot;&#x27; on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            initMethod.invoke(bean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> existingBean;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">current</span> <span class="operator">=</span> processor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == current) <span class="keyword">return</span> result;</span><br><span class="line">            result = current;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">applyBeanPostProcessorsAfterInitialization</span><span class="params">(Object existingBean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> existingBean;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">current</span> <span class="operator">=</span> processor.postProcessAfterInitialization(result, beanName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == current) <span class="keyword">return</span> result;</span><br><span class="line">            result = current;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š-8"><a href="#ç»“æœï¼š-8" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><p>èå…¥æ€è·¯ï¼š </p><ol><li>é€šè¿‡XMLæ–‡ä»¶åŠ è½½ DefaultAdvisorAutoProxyCreator ã€MethodBeforeAdviceInterceptor ã€ AspectJExpressionPointcutAdvisor ä»¥åŠ ç”¨æˆ·è‡ªå®šä¹‰çš„æ‹¦æˆªæ–¹æ³•ã€‚ </li><li>åœ¨ AbstractApplicationContext åˆ·æ–°ä¸Šä¸‹æ–‡ä¸­ æå‰æ³¨å†Œ DefaultAdvisorAutoProxyCreator ä»¥ä¾¿åç»­çš„ä»£ç†æ“ä½œã€‚</li><li>DefaultAdvisorAutoProxyCreator.postProcessBeforeInstantiation(beanClass, beanName) ä¸­ ä¸»è¦æä¾›AspectJExpressionPointcutAdvisor åˆ‡é¢è®¿é—®è€… çš„å¤„ç†ï¼Œé€šè¿‡ è¡¨è¾¾å¼åŒ¹é… matches ã€åŒ…è£…ç›®æ ‡ç±» TargetSourceã€é…ç½® AdvisedSupportã€æ–°å»ºä»£ç†å·¥å‚ ProxyFactory(AdvisedSupport)  è¿”å› ä»£ç†å¯¹è±¡ã€‚</li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step12.drawio.png" alt="step12-ç¬¬ 3 é¡µ.drawio"></p><h2 id="Step13ï¼šåˆ©ç”¨-è‡ªå®šä¹‰æ³¨è§£-å®ç°Beançš„è‡ªåŠ¨åŒ–æ‰«ææ³¨å†Œ"><a href="#Step13ï¼šåˆ©ç”¨-è‡ªå®šä¹‰æ³¨è§£-å®ç°Beançš„è‡ªåŠ¨åŒ–æ‰«ææ³¨å†Œ" class="headerlink" title="Step13ï¼šåˆ©ç”¨ è‡ªå®šä¹‰æ³¨è§£ å®ç°Beançš„è‡ªåŠ¨åŒ–æ‰«ææ³¨å†Œ"></a>Step13ï¼šåˆ©ç”¨ è‡ªå®šä¹‰æ³¨è§£ å®ç°Beançš„è‡ªåŠ¨åŒ–æ‰«ææ³¨å†Œ</h2><h3 id="å®ç°ï¼š-11"><a href="#å®ç°ï¼š-11" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>å®šä¹‰æ‹¦æˆªæ³¨è§£</p><ol><li>å®šä¹‰ @Scope æ³¨è§£ï¼Œç”¨äºæ ‡è®°Beanå¯¹è±¡çš„ä½œç”¨åŸŸã€‚</li><li>å®šä¹‰ @Component æ³¨è§£ï¼Œç”¨äºæ ‡è®°æ˜¯å¦ä¸ºæ³¨å†ŒBeanï¼Œæä¾› value å±æ€§æŒ‡å®šBeanNameã€‚</li></ol></li><li><p>å¤„ç†å¯¹è±¡æ‰«æè£…é…</p><ol><li><p>å®šä¹‰ ClassPathScanningCandidateComponentProvider ç±»ï¼Œå…·æœ‰ findCandidateComponents(String basePackage) æ‰«æå¹¶è·å–æŒ‡å®šåŒ…ä¸‹çš„æ‰€æœ‰@Componentæ³¨è§£ä¸‹çš„BeanDefinition</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassPathScanningCandidateComponentProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Set&lt;BeanDefinition&gt; <span class="title function_">findCandidateComponents</span><span class="params">(String basePackage)</span> &#123;</span><br><span class="line">        Set&lt;BeanDefinition&gt; candidates = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; classes = ClassUtil.scanPackageByAnnotation(basePackage, Component.class);</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">            candidates.add(<span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(clazz));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> candidates;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰ ClassPathBeanDefinitionScanner æ‰«æåŒ…å¤„ç†ç±»ï¼Œç»§æ‰¿äºClassPathScanningCandidateComponentProvider ï¼Œå…·æœ‰ doScan(Stringâ€¦ basePackage) æ‰«æå¤„ç†æ–¹æ³•ï¼Œä¸»è¦ç”¨äº æ‰«æå¤šä¸ªåŒ…ä¸‹çš„BeanDefinitionï¼Œä¹‹åé€šè¿‡ è‡ªå®šä¹‰æ³¨è§£ @Scope ä»¥åŠ @Component è·å–å¹¶é…ç½®å…¶ä½œç”¨åŸŸå’ŒBeanNameè¿›è¡Œæ³¨å†Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassPathBeanDefinitionScanner</span> <span class="keyword">extends</span> <span class="title class_">ClassPathScanningCandidateComponentProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BeanDefinitionRegistry registry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.registry = registry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doScan</span><span class="params">(String... basePackages)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String basePackage : basePackages) &#123;</span><br><span class="line">            Set&lt;BeanDefinition&gt; beanDefinitions = findCandidateComponents(basePackage);</span><br><span class="line">            <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitions) &#123;</span><br><span class="line">                <span class="comment">// è§£æ Bean çš„ä½œç”¨åŸŸ singletonã€prototype</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">beanScope</span> <span class="operator">=</span> resolveBeanScope(beanDefinition);</span><br><span class="line">                <span class="keyword">if</span> (StrUtil.isNotEmpty(beanScope)) &#123;</span><br><span class="line">                    beanDefinition.setScope(beanScope);</span><br><span class="line">                &#125;</span><br><span class="line">                registry.registerBeanDefinition(determineBeanName(beanDefinition), beanDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">resolveBeanScope</span><span class="params">(BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; beanClass = beanDefinition.getBeanClass();</span><br><span class="line">        <span class="type">Scope</span> <span class="variable">scope</span> <span class="operator">=</span> beanClass.getAnnotation(Scope.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != scope) <span class="keyword">return</span> scope.value();</span><br><span class="line">        <span class="keyword">return</span> StrUtil.EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½® beanName</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">determineBeanName</span><span class="params">(BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; beanClass = beanDefinition.getBeanClass();</span><br><span class="line">        <span class="type">Component</span> <span class="variable">component</span> <span class="operator">=</span> beanClass.getAnnotation(Component.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> component.value();</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isEmpty(value)) &#123;</span><br><span class="line">            <span class="comment">// é¦–å­—æ¯å°å†™</span></span><br><span class="line">            value = StrUtil.lowerFirst(beanClass.getSimpleName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>å®Œå–„ XmlBeanDefinitionReader ï¼Œåœ¨ doLoadBeanDefinitions è§£ææ³¨å†Œæ“ä½œ ä¸­æ–°å¢å¯¹ context:component-scan æ ‡ç­¾çš„è§£æï¼Œä¹‹åè°ƒç”¨ClassPathBeanDefinitionScanner.doScan æ–¹æ³•è¿›è¡ŒBeanæ³¨å†Œæ“ä½œã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doLoadBeanDefinitions</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> ClassNotFoundException, DocumentException &#123;</span><br><span class="line">        <span class="type">SAXReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>();</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> reader.read(inputStream);</span><br><span class="line">        <span class="type">Element</span> <span class="variable">root</span> <span class="operator">=</span> document.getRootElement();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§£æ context:component-scan æ ‡ç­¾ï¼Œæ‰«æåŒ…ä¸­çš„ç±»å¹¶æå–ç›¸å…³ä¿¡æ¯ï¼Œç”¨äºç»„è£… BeanDefinition</span></span><br><span class="line">        <span class="type">Element</span> <span class="variable">componentScan</span> <span class="operator">=</span> root.element(<span class="string">&quot;component-scan&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != componentScan) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">scanPath</span> <span class="operator">=</span> componentScan.attributeValue(<span class="string">&quot;base-package&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isEmpty(scanPath)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;The value of base-package attribute can not be empty or null&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            scanPackage(scanPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Element&gt; beanList = root.elements(<span class="string">&quot;bean&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Element bean : beanList) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> bean.attributeValue(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> bean.attributeValue(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> bean.attributeValue(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">initMethod</span> <span class="operator">=</span> bean.attributeValue(<span class="string">&quot;init-method&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">destroyMethodName</span> <span class="operator">=</span> bean.attributeValue(<span class="string">&quot;destroy-method&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">beanScope</span> <span class="operator">=</span> bean.attributeValue(<span class="string">&quot;scope&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å– Classï¼Œæ–¹ä¾¿è·å–ç±»ä¸­çš„åç§°</span></span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">            <span class="comment">// ä¼˜å…ˆçº§ id &gt; name</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> StrUtil.isNotEmpty(id) ? id : name;</span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isEmpty(beanName)) &#123;</span><br><span class="line">                beanName = StrUtil.lowerFirst(clazz.getSimpleName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®šä¹‰Bean</span></span><br><span class="line">            <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(clazz);</span><br><span class="line">            beanDefinition.setInitMethodName(initMethod);</span><br><span class="line">            beanDefinition.setDestroyMethodName(destroyMethodName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isNotEmpty(beanScope)) &#123;</span><br><span class="line">                beanDefinition.setScope(beanScope);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;Element&gt; propertyList = bean.elements(<span class="string">&quot;property&quot;</span>);</span><br><span class="line">            <span class="comment">// è¯»å–å±æ€§å¹¶å¡«å……</span></span><br><span class="line">            <span class="keyword">for</span> (Element property : propertyList) &#123;</span><br><span class="line">                <span class="comment">// è§£ææ ‡ç­¾ï¼šproperty</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">attrName</span> <span class="operator">=</span> property.attributeValue(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">attrValue</span> <span class="operator">=</span> property.attributeValue(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">attrRef</span> <span class="operator">=</span> property.attributeValue(<span class="string">&quot;ref&quot;</span>);</span><br><span class="line">                <span class="comment">// è·å–å±æ€§å€¼ï¼šå¼•å…¥å¯¹è±¡ã€å€¼å¯¹è±¡</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> StrUtil.isNotEmpty(attrRef) ? <span class="keyword">new</span> <span class="title class_">BeanReference</span>(attrRef) : attrValue;</span><br><span class="line">                <span class="comment">// åˆ›å»ºå±æ€§ä¿¡æ¯</span></span><br><span class="line">                <span class="type">PropertyValue</span> <span class="variable">propertyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyValue</span>(attrName, value);</span><br><span class="line">                beanDefinition.getPropertyValues().addPropertyValue(propertyValue);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (getRegistry().containsBeanDefinition(beanName)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Duplicate beanName[&quot;</span> + beanName + <span class="string">&quot;] is not allowed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ³¨å†Œ BeanDefinition</span></span><br><span class="line">            getRegistry().registerBeanDefinition(beanName, beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scanPackage</span><span class="params">(String scanPath)</span> &#123;</span><br><span class="line">        String[] basePackages = StrUtil.splitToArray(scanPath, <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        <span class="type">ClassPathBeanDefinitionScanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathBeanDefinitionScanner</span>(getRegistry());</span><br><span class="line">        scanner.doScan(basePackages);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="æ‰©å±•ï¼šåˆ©ç”¨-BeanFactoryPostProcessor-è¿›è¡Œå ä½ç¬¦é…ç½®ï¼ˆ-xxx-ï¼‰"><a href="#æ‰©å±•ï¼šåˆ©ç”¨-BeanFactoryPostProcessor-è¿›è¡Œå ä½ç¬¦é…ç½®ï¼ˆ-xxx-ï¼‰" class="headerlink" title="æ‰©å±•ï¼šåˆ©ç”¨ BeanFactoryPostProcessor è¿›è¡Œå ä½ç¬¦é…ç½®ï¼ˆ${ xxx }ï¼‰"></a>æ‰©å±•ï¼šåˆ©ç”¨ BeanFactoryPostProcessor è¿›è¡Œå ä½ç¬¦é…ç½®ï¼ˆ${ xxx }ï¼‰</h3><ol><li><p>å®šä¹‰ PropertyPlaceholderConfigurer é…ç½®ç±»ï¼Œå®ç° BeanFactoryPostProcessor æ¥å£ï¼Œåœ¨å…¶ postProcessBeanFactory æ–¹æ³•ä¸‹ï¼Œå¤„ç†å ä½ç¬¦é…ç½®ï¼Œé¦–å…ˆè·å– æ‰€æœ‰BeanDefinition å…·æœ‰æŒ‡å®šå‰åç¼€å³å½¢å¦‚ ${key} çš„ Beanå±æ€§ï¼Œä¹‹åè§£ææŒ‡å®šè·¯å¾„ä¸‹çš„ properties é…ç½®æ–‡ä»¶ä¸­ç›¸åŒ key çš„å€¼ï¼Œé€šè¿‡ replace å­—ç¬¦ä¸²æ›¿æ¢ï¼Œå°† BeanDefinition å±æ€§å€¼ å˜ä¸º é…ç½®æ–‡ä»¶ä¸­å¯¹åº” key çš„å€¼ã€‚æœ€åé€šè¿‡propertyValues.addPropertyValue(new PropertyValue(propertyValue.getName(), buffer.toString())); è¿›è¡ŒBeanå±æ€§ä¿¡æ¯çš„æ›¿æ¢ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// åŠ è½½å±æ€§æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DefaultResourceLoader</span> <span class="variable">resourceLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultResourceLoader</span>();</span><br><span class="line">            <span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> resourceLoader.getResource(location);</span><br><span class="line">            <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            properties.load(resource.getInputStream());</span><br><span class="line"></span><br><span class="line">            String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();</span><br><span class="line">            <span class="keyword">for</span> (String beanName : beanDefinitionNames) &#123;</span><br><span class="line">                <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> beanFactory.getBeanDefinition(beanName);</span><br><span class="line"></span><br><span class="line">                <span class="type">PropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> beanDefinition.getPropertyValues();</span><br><span class="line">                <span class="keyword">for</span> (PropertyValue propertyValue : propertyValues.getPropertyValues()) &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> propertyValue.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> String)) <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="comment">// bean å®šä¹‰çš„value</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">strVal</span> <span class="operator">=</span> (String) value;</span><br><span class="line">                    <span class="type">StringBuilder</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(strVal);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">startIdx</span> <span class="operator">=</span> strVal.indexOf(DEFAULT_PLACEHOLDER_PREFIX);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">stopIdx</span> <span class="operator">=</span> strVal.indexOf(DEFAULT_PLACEHOLDER_SUFFIX);</span><br><span class="line">                    <span class="comment">// å¦‚æœå­˜åœ¨å ä½ç¬¦ï¼Œä»é…ç½®æ–‡ä»¶ä¸­æå–å±æ€§å¹¶æ›¿æ¢beanå®šä¹‰</span></span><br><span class="line">                    <span class="keyword">if</span> (startIdx != -<span class="number">1</span> &amp;&amp; stopIdx != -<span class="number">1</span> &amp;&amp; startIdx &lt; stopIdx) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">propKey</span> <span class="operator">=</span> strVal.substring(startIdx + <span class="number">2</span>, stopIdx);</span><br><span class="line">                        <span class="comment">// ä»é…ç½®æ–‡ä»¶ä¸­ æ‹¿åˆ°æŒ‡å®š key çš„ value</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">propVal</span> <span class="operator">=</span> properties.getProperty(propKey);</span><br><span class="line">                        <span class="comment">// æ›¿æ¢</span></span><br><span class="line">                        buffer.replace(startIdx, stopIdx + <span class="number">1</span>, propVal);</span><br><span class="line">                        propertyValues.addPropertyValue(<span class="keyword">new</span> <span class="title class_">PropertyValue</span>(propertyValue.getName(), buffer.toString()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Could not load properties&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š-9"><a href="#ç»“æœï¼š-9" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><ol><li>ç»è¿‡è¿™å‡ ç« AOPçš„å­¦ä¹ ï¼Œå¯¹ æ•´ä¸ªSpringçš„æ‰©å±•æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯åœ¨ å®Œå–„ Beançš„ç”Ÿå‘½å‘¨æœŸï¼Œä½¿å¾—æ•´ä¸ªSpringçš„åŠŸèƒ½ä½¿ç”¨æ›´åŠ æ–¹ä¾¿å¿«æ·ã€‚</li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step13.drawio.png" alt="step13-ç¬¬ 2 é¡µ.drawio"></p><h2 id="Step14ï¼šåˆ©ç”¨-BeanPostProcessor-å®ç°Beanå±æ€§çš„æ³¨è§£æ³¨å…¥"><a href="#Step14ï¼šåˆ©ç”¨-BeanPostProcessor-å®ç°Beanå±æ€§çš„æ³¨è§£æ³¨å…¥" class="headerlink" title="Step14ï¼šåˆ©ç”¨ BeanPostProcessor å®ç°Beanå±æ€§çš„æ³¨è§£æ³¨å…¥"></a>Step14ï¼šåˆ©ç”¨ BeanPostProcessor å®ç°Beanå±æ€§çš„æ³¨è§£æ³¨å…¥</h2><h3 id="å®ç°ï¼š-12"><a href="#å®ç°ï¼š-12" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>å®šä¹‰å±æ€§æ³¨å…¥ç›¸å…³æ³¨è§£</p><ol><li>å®šä¹‰ @Autowired æ³¨è§£ï¼Œç”¨äºæ ‡è®°Beanæ³¨å…¥çš„ä¾èµ–å¯¹è±¡ã€‚</li><li>å®šä¹‰ @Qualifier æ³¨è§£ï¼Œç”¨äºæ ‡è®°Beanæ³¨å…¥çš„ä¾èµ–å¯¹è±¡çš„å…·ä½“åå­—ã€‚æä¾› value å±æ€§æŒ‡å®š å…·ä½“çš„beanName 1.3 å®šä¹‰ @Value æ³¨è§£ï¼Œç”¨äºæ ‡è®°Beanæ³¨å…¥çš„å±æ€§ï¼Œæä¾› value å±æ€§æŒ‡å®š  beanå…·ä½“å±æ€§å€¼ï¼Œå¯ä»¥æ˜¯å ä½ç¬¦ï¼Œä¹Ÿå¯ä»¥æ˜¯æ™®é€šå€¼ã€‚</li></ol></li><li><p>å‘å®¹å™¨ä¸­æ·»åŠ å­—ç¬¦ä¸²è§£æå™¨ï¼Œç”¨äºè§£æ @Value æ³¨è§£ã€‚</p><ol><li><p>å®šä¹‰ StringValueResolver å­—ç¬¦ä¸²è§£æ æ¥å£ï¼Œæä¾› resolveStringValue(String)  è§£ææŒ‡å®šå­—ç¬¦ä¸² çš„æ–¹æ³•ã€‚ </p></li><li><p>å®Œå–„ ConfigurableBeanFactory å·¥å‚é…ç½®åŒ–æ¥å£ï¼Œæ–°å¢ addEmbeddedValueResolver(StringValueResolver) æ·»åŠ å­—ç¬¦ä¸²è§£æå™¨ ä»¥åŠ  resolveEmbeddedValue(String) è§£ææŒ‡å®šå­—ç¬¦ä¸² çš„æ–¹æ³•ã€‚ </p></li><li><p>å®Œå–„ AbstractBeanFactory ï¼Œå®ç° ConfigurableBeanFactory æ–°å¢çš„  æ·»åŠ å­—ç¬¦ä¸²è§£æå™¨ ä»¥åŠ è§£ææŒ‡å®šå­—ç¬¦ä¸² çš„æ–¹æ³•ã€‚</p></li><li><p>å®Œå–„ PropertyPlaceholderConfigurer é…ç½®ç±»ï¼Œæ–°å¢ PlaceholderResolvingStringValueResolver å†…éƒ¨ç±»ï¼Œå®ç° StringValueResolver æ¥å£ çš„ resolveStringValue(String) æ–¹æ³• ã€‚è¯¥é…ç½®ç±»åˆ©ç”¨ BeanFactoryPostProcessor åœ¨Beanå®šä¹‰åŠ è½½å®Œä¹‹åæ‰§è¡Œçš„ç‰¹ç‚¹ï¼Œåœ¨å¤„ç†å®Œ XML æ–‡ä»¶çš„ å±æ€§ä¹‹åï¼Œå°†å…¶ è§£ææ“ä½œ é€šè¿‡ PlaceholderResolvingStringValueResolver å†…éƒ¨ç±» å°è£…ï¼Œå¹¶é€šè¿‡ beanFactory.addEmbeddedValueResolver(StringValueResolver) æ·»åŠ  å­—ç¬¦ä¸²è§£æå™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.beans.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValue;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValues;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanDefinition;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanFactoryPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.core.io.DefaultResourceLoader;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.utils.StringValueResolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/11 20:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertyPlaceholderConfigurer</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default placeholder prefix: &#123;<span class="doctag">@value</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_PLACEHOLDER_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;$&#123;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default placeholder suffix: &#123;<span class="doctag">@value</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_PLACEHOLDER_SUFFIX</span> <span class="operator">=</span> <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String location;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLocation</span><span class="params">(String location)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.location = location;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åŠ è½½å±æ€§æ–‡ä»¶</span></span><br><span class="line">            <span class="type">DefaultResourceLoader</span> <span class="variable">resourceLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultResourceLoader</span>();</span><br><span class="line">            <span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> resourceLoader.getResource(location);</span><br><span class="line">            <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            properties.load(resource.getInputStream());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å ä½ç¬¦æ›¿æ¢å±æ€§å€¼</span></span><br><span class="line">            String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();</span><br><span class="line">            <span class="keyword">for</span> (String beanName : beanDefinitionNames) &#123;</span><br><span class="line">                <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> beanFactory.getBeanDefinition(beanName);</span><br><span class="line"></span><br><span class="line">                <span class="type">PropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> beanDefinition.getPropertyValues();</span><br><span class="line">                <span class="keyword">for</span> (PropertyValue propertyValue : propertyValues.getPropertyValues()) &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> propertyValue.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> String)) <span class="keyword">continue</span>;</span><br><span class="line">                    value = resolvePlaceholder((String) value,properties);</span><br><span class="line">                    propertyValues.addPropertyValue(<span class="keyword">new</span> <span class="title class_">PropertyValue</span>(propertyValue.getName(),value));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å‘å®¹å™¨ä¸­æ·»åŠ å­—ç¬¦ä¸²è§£æå™¨ï¼Œä¾›è§£æ@Valueæ³¨è§£ä½¿ç”¨</span></span><br><span class="line">            <span class="type">StringValueResolver</span> <span class="variable">stringValueResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PlaceholderResolvingStringValueResolver</span>(properties);</span><br><span class="line">            beanFactory.addEmbeddedValueResolver(stringValueResolver);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Could not load properties&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å ä½ç¬¦æ›¿æ¢å±æ€§å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value beanå±æ€§å®šä¹‰çš„value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> properties é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> é…ç½®æ–‡ä»¶ä¸­ æŒ‡å®š key çš„ value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">resolvePlaceholder</span><span class="params">(String value, Properties properties)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">strVal</span> <span class="operator">=</span> value;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(strVal);</span><br><span class="line">        <span class="type">int</span> <span class="variable">startIdx</span> <span class="operator">=</span> strVal.indexOf(DEFAULT_PLACEHOLDER_PREFIX);</span><br><span class="line">        <span class="type">int</span> <span class="variable">stopIdx</span> <span class="operator">=</span> strVal.indexOf(DEFAULT_PLACEHOLDER_SUFFIX);</span><br><span class="line">        <span class="comment">// å¦‚æœå­˜åœ¨å ä½ç¬¦ï¼Œä»é…ç½®æ–‡ä»¶ä¸­æå–å±æ€§å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (startIdx != -<span class="number">1</span> &amp;&amp; stopIdx != -<span class="number">1</span> &amp;&amp; startIdx &lt; stopIdx) &#123;</span><br><span class="line">            <span class="comment">// å ä½ç¬¦ä¸­ çš„ key</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">propKey</span> <span class="operator">=</span> strVal.substring(startIdx + <span class="number">2</span>, stopIdx);</span><br><span class="line">            <span class="comment">// ä»é…ç½®æ–‡ä»¶ä¸­ æ‹¿åˆ°æŒ‡å®š key çš„ value</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">propVal</span> <span class="operator">=</span> properties.getProperty(propKey);</span><br><span class="line">            buffer.replace(startIdx, stopIdx + <span class="number">1</span>, propVal);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PlaceholderResolvingStringValueResolver</span> <span class="keyword">implements</span> <span class="title class_">StringValueResolver</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Properties properties;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">PlaceholderResolvingStringValueResolver</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.properties = properties;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">resolveStringValue</span><span class="params">(String strVal)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> PropertyPlaceholderConfigurer.<span class="built_in">this</span>.resolvePlaceholder(strVal, properties);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>è§£æè‡ªå®šä¹‰æ³¨è§£</p><ol><li><p>å®Œå–„ InstantiationAwareBeanPostProcessor æ¥å£ï¼Œæ–°å¢ postProcessPropertyValues åœ¨å¡«å……å±æ€§ä¹‹å‰æ‰§è¡Œçš„æ–¹æ³•ã€‚</p></li><li><p>å®šä¹‰ AutowiredAnnotationBeanPostProcessor ç±»ï¼Œå®ç° InstantiationAwareBeanPostProcessor, BeanFactoryAware æ¥å£ï¼Œåœ¨å®ç°çš„ postProcessPropertyValues æ–¹æ³•ä¸­ï¼Œé€šè¿‡ è·å– beanClassçš„Fieldï¼Œæ‰«æå¹¶è§£æå…¶@Value æ³¨è§£ã€ beanFactory.resolveEmbeddedValue(value) ã€‘è®¾ç½®å…¶å±æ€§å€¼     BeanUtil.setFieldValue(bean, field.getName(), value)  ï¼Œæ‰«æ @Autowired ä»¥åŠ @Qualifier å¹¶è·å–åˆ° ä¸ Field.Type åŒç±»å‹ çš„ bean è®¾ç½®å…¶ä¾èµ–å¯¹è±¡ BeanUtil.setFieldValue(bean, field.getName(), dependentBean)  ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.beans.factory.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValues;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactoryAware;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.utils.ClassUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/15 18:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutowiredAnnotationBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">InstantiationAwareBeanPostProcessor</span>, BeanFactoryAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConfigurableListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="built_in">this</span>.beanFactory = (ConfigurableListableBeanFactory) beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PropertyValues <span class="title function_">postProcessPropertyValues</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// 1. å¤„ç†æ³¨è§£ @Value</span></span><br><span class="line">        Class&lt;?&gt; clazz = bean.getClass();</span><br><span class="line">        clazz = ClassUtil.isCglibProxyClass(clazz) ? clazz.getSuperclass() : clazz;</span><br><span class="line"></span><br><span class="line">        Field[] declaredFields = clazz.getDeclaredFields();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">            <span class="type">Value</span> <span class="variable">valueAnnotation</span> <span class="operator">=</span> field.getAnnotation(Value.class);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != valueAnnotation) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> valueAnnotation.value();</span><br><span class="line">                value = beanFactory.resolveEmbeddedValue(value);</span><br><span class="line">                BeanUtil.setFieldValue(bean, field.getName(), value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. å¤„ç†æ³¨è§£ @Autowired</span></span><br><span class="line">        <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">            <span class="type">Autowired</span> <span class="variable">autowiredAnnotation</span> <span class="operator">=</span> field.getAnnotation(Autowired.class);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != autowiredAnnotation) &#123;</span><br><span class="line">                Class&lt;?&gt; fieldType = field.getType();</span><br><span class="line">                <span class="type">String</span> <span class="variable">dependentBeanName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">dependentBean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">Qualifier</span> <span class="variable">qualifierAnnotation</span> <span class="operator">=</span> field.getAnnotation(Qualifier.class);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != qualifierAnnotation) &#123;</span><br><span class="line">                    dependentBeanName = qualifierAnnotation.value();</span><br><span class="line">                    dependentBean = beanFactory.getBean(dependentBeanName, fieldType);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    dependentBean = beanFactory.getBean(fieldType);</span><br><span class="line">                &#125;</span><br><span class="line">                BeanUtil.setFieldValue(bean, field.getName(), dependentBean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è¿™é‡Œæ€ä¹ˆè·å–åˆ°çš„ å˜åŒ–åçš„propertyValues ï¼Ÿ</span></span><br><span class="line">      <span class="comment">// ä¼¼ä¹è¿”å›ä»€ä¹ˆéƒ½ä¸æ˜¯é‡ç‚¹ï¼Œè¿™é‡Œå·²ç»è¿›è¡Œäº†å±æ€§å¡«å……ã€‚ã€‚ã€‚  BeanUtil.setFieldValue</span></span><br><span class="line">        <span class="keyword">return</span> pvs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>æ‰©å±• Beançš„ç”Ÿå‘½å‘¨æœŸ</p><ol><li><p>å®Œå–„ AbstractAutowireCapableBeanFactory çš„ createBean æ–¹æ³•ï¼Œåœ¨ å…¶å¡«å……Beanå±æ€§ä¹‹å‰ï¼Œæ£€ç´¢æ˜¯å¦å­˜åœ¨ InstantiationAwareBeanPostProcessorï¼Œå¹¶è°ƒç”¨å…¶ postProcessPropertyValues è¿›è¡ŒBeanå±æ€§çš„æ³¨è§£æ³¨å…¥ã€‚ </p><p>Tipsï¼špostProcessPropertyValues æ–¹æ³• è°ƒç”¨åï¼Œå¯èƒ½è¿˜å­˜åœ¨ æ— æ³¨è§£çš„å±æ€§å€¼ï¼Œå› æ­¤éœ€è¦è¿›è¡Œåˆ¤æ–­ pvs æ˜¯å¦ä¸ºç©ºï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° BeanDefinition ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractBeanFactory</span> <span class="keyword">implements</span> <span class="title class_">AutowireCapableBeanFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">  â€¦â€¦â€¦â€¦</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, BeanDefinition beanDefinition, Object[] args)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦è¿”å›ä»£ç† Bean å¯¹è±¡</span></span><br><span class="line">            bean = resolveBeforeInstantiation(beanName, beanDefinition);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != bean) &#123;</span><br><span class="line">                <span class="keyword">return</span> bean;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å®ä¾‹åŒ–bean</span></span><br><span class="line">            bean = createBeanInstance(beanDefinition, beanName, args);</span><br><span class="line">            <span class="comment">// åœ¨å¡«å…… Bean å±æ€§ä¹‹å‰ï¼Œå…è®¸ BeanPostProcessor ä¿®æ”¹å±æ€§å€¼</span></span><br><span class="line">            applyBeanPostProcessorsBeforeApplyingPropertyValues(beanName,bean,beanDefinition);</span><br><span class="line">            <span class="comment">// å¡«å……å±æ€§</span></span><br><span class="line">            applyPropertyValues(beanName, bean, beanDefinition);</span><br><span class="line">            <span class="comment">// æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•</span></span><br><span class="line">            bean = initializeBean(beanName,bean,beanDefinition);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Instantiation of bean failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å†Œå®ç°äº† DisposableBean æ¥å£çš„ Bean å¯¹è±¡</span></span><br><span class="line">        registerDisposableBeanIfNecessary(beanName,bean,beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­ SCOPE_SINGLETONã€SCOPE_PROTOTYPE</span></span><br><span class="line">        <span class="keyword">if</span> (beanDefinition.isSingleton()) &#123;</span><br><span class="line">            registerSingleton(beanName, bean);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨è®¾ç½® Bean å±æ€§ä¹‹å‰ï¼Œå…è®¸ BeanPostProcessor ä¿®æ”¹å±æ€§å€¼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanDefinition</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">applyBeanPostProcessorsBeforeApplyingPropertyValues</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor beanPostProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanPostProcessor <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor)&#123;</span><br><span class="line">                <span class="type">PropertyValues</span> <span class="variable">pvs</span> <span class="operator">=</span> ((InstantiationAwareBeanPostProcessor) beanPostProcessor).postProcessPropertyValues(beanDefinition.getPropertyValues(), bean, beanName);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != pvs) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (PropertyValue propertyValue : pvs.getPropertyValues()) &#123;</span><br><span class="line">                        beanDefinition.getPropertyValues().addPropertyValue(propertyValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br></pre></td></tr></table></figure></li></ol></li><li><p>å®Œå–„ ClassPathBeanDefinitionScanner çš„ doScan æ–¹æ³•ï¼Œåœ¨å…¶æ³¨å†Œ BeanDefinition ä¹‹åï¼Œæ³¨å†Œ AutowiredAnnotationBeanPostProcessor ï¼Œå°±ä¸ç”¨æ‰‹åŠ¨å»é…ç½® XML æ–‡ä»¶äº†ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.context.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.BeanDefinition;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.support.BeanDefinitionRegistry;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/11 21:26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassPathBeanDefinitionScanner</span> <span class="keyword">extends</span> <span class="title class_">ClassPathScanningCandidateComponentProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BeanDefinitionRegistry registry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.registry = registry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doScan</span><span class="params">(String... basePackages)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String basePackage : basePackages) &#123;</span><br><span class="line">            Set&lt;BeanDefinition&gt; beanDefinitions = findCandidateComponents(basePackage);</span><br><span class="line">            <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitions) &#123;</span><br><span class="line">                <span class="comment">// è§£æ Bean çš„ä½œç”¨åŸŸ singletonã€prototype</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">beanScope</span> <span class="operator">=</span> resolveBeanScope(beanDefinition);</span><br><span class="line">                <span class="keyword">if</span> (StrUtil.isNotEmpty(beanScope)) &#123;</span><br><span class="line">                    beanDefinition.setScope(beanScope);</span><br><span class="line">                &#125;</span><br><span class="line">                registry.registerBeanDefinition(determineBeanName(beanDefinition), beanDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ³¨å†Œå¤„ç†æ³¨è§£çš„ BeanPostProcessorï¼ˆ@Autowiredã€@Valueï¼‰</span></span><br><span class="line">        registry.registerBeanDefinition(<span class="string">&quot;cn.ray.springframework.context.annotation.internalAutowiredAnnotationProcessor&quot;</span>, <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(AutowiredAnnotationBeanPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">resolveBeanScope</span><span class="params">(BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; beanClass = beanDefinition.getBeanClass();</span><br><span class="line">        <span class="type">Scope</span> <span class="variable">scope</span> <span class="operator">=</span> beanClass.getAnnotation(Scope.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != scope) <span class="keyword">return</span> scope.value();</span><br><span class="line">        <span class="keyword">return</span> StrUtil.EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½® beanName</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">determineBeanName</span><span class="params">(BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; beanClass = beanDefinition.getBeanClass();</span><br><span class="line">        <span class="type">Component</span> <span class="variable">component</span> <span class="operator">=</span> beanClass.getAnnotation(Component.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> component.value();</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isEmpty(value)) &#123;</span><br><span class="line">            <span class="comment">// é¦–å­—æ¯å°å†™</span></span><br><span class="line">            value = StrUtil.lowerFirst(beanClass.getSimpleName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š-10"><a href="#ç»“æœï¼š-10" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><ol><li>å¤–éƒ¨æ¥å£é€šè¿‡å†…éƒ¨ç±»å»å®ç°ï¼Œä½“ç°äº†è‰¯å¥½çš„å°è£…æ€§ï¼Œä¹Ÿæ›´å¥½çš„å°†ä¸¤ä¸ªå…·æœ‰ä¸€å®šå…³è”çš„ç±»ç»„ç»‡åœ¨äº†ä¸€èµ·ï¼Œè§£å†³äº†å…±åŒçš„é€»è¾‘æ“ä½œã€‚</li><li>æ¥å£ç”¨ instanceof åˆ¤æ–­ï¼Œçˆ¶ç±»æˆ–åŒç±»ç”¨ isAssignableFrom åˆ¤æ–­ï¼Œæ³¨è§£ç”¨ getAnnotation(Annotation.class) è¿™äº›éƒ½ç›¸å½“äºåœ¨ç±»ä¸Šçš„ä¸€äº›æ ‡è¯†ä¿¡æ¯ï¼Œä¾¿äºä¸€äº›æ–¹æ³•æ‰¾åˆ°åŠŸèƒ½ç‚¹ï¼Œå¹¶å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚åƒ Spring ä¸­å¤šæ¬¡ç”¨åˆ°çš„ BeanPostProcessorã€‚</li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step14.drawio.png" alt="step15-ç¬¬ 2 é¡µ.drawio"></p><h2 id="Step15ï¼šè°ƒæ•´-AOP-ä»£ç†å¯¹è±¡ç”Ÿæˆçš„æ—¶æœº-å®ç°å…¶å±æ€§æ³¨å…¥"><a href="#Step15ï¼šè°ƒæ•´-AOP-ä»£ç†å¯¹è±¡ç”Ÿæˆçš„æ—¶æœº-å®ç°å…¶å±æ€§æ³¨å…¥" class="headerlink" title="Step15ï¼šè°ƒæ•´ AOP ä»£ç†å¯¹è±¡ç”Ÿæˆçš„æ—¶æœº å®ç°å…¶å±æ€§æ³¨å…¥"></a>Step15ï¼šè°ƒæ•´ AOP ä»£ç†å¯¹è±¡ç”Ÿæˆçš„æ—¶æœº å®ç°å…¶å±æ€§æ³¨å…¥</h2><h3 id="å®ç°ï¼š-13"><a href="#å®ç°ï¼š-13" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><p>ä¹‹å‰ ä»£ç†å¯¹è±¡ çš„ç”Ÿæˆ æ˜¯åœ¨ Beanå¯¹è±¡åˆ›å»ºä¹‹å‰ï¼Œå³ä¸åœ¨ Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ— æ³•å®ç°å±æ€§çš„æ³¨å…¥ï¼Œç°åœ¨éœ€è¦è°ƒæ•´å…¶ç”Ÿæˆæ—¶æœºï¼Œæ•´ä¸ªæµç¨‹å…¶å®ååˆ†ç®€å•ï¼Œè¿ç§» ä¹‹å‰ AOPä»£ç†æ–¹æ³• åˆ° BeanPostProcessor çš„ postProcessAfterInitialization çš„æ–¹æ³•ï¼Œè¿™æ ·åœ¨ bean å±æ€§æ³¨å…¥å¹¶åˆå§‹åŒ–ä¹‹åï¼Œå°±ä¼šè°ƒç”¨ å…¶ä»£ç†æ–¹æ³•æ¥å®Œæˆ AOP ä»£ç†ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.aop.framework.autoproxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.*;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.aspectj.AspectJExpressionPointcutAdvisor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.framework.ProxyFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValues;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactoryAware;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.support.DefaultListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.aopalliance.aop.Advice;</span><br><span class="line"><span class="keyword">import</span> org.aopalliance.intercept.MethodInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 20:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultAdvisorAutoProxyCreator</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryAware</span>,InstantiationAwareBeanPostProcessor &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="built_in">this</span>.beanFactory = (DefaultListableBeanFactory) beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isInfrastructureClass</span><span class="params">(Class&lt;?&gt; beanClass)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Advice.class.isAssignableFrom(beanClass) || Pointcut.class.isAssignableFrom(beanClass) || Advisor.class.isAssignableFrom(beanClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (isInfrastructureClass(bean.getClass())) <span class="keyword">return</span> bean;</span><br><span class="line"></span><br><span class="line">        Collection&lt;AspectJExpressionPointcutAdvisor&gt; advisors = beanFactory.getBeansOfType(AspectJExpressionPointcutAdvisor.class).values();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (AspectJExpressionPointcutAdvisor advisor : advisors) &#123;</span><br><span class="line">            <span class="type">ClassFilter</span> <span class="variable">classFilter</span> <span class="operator">=</span> advisor.getPointcut().getClassFilter();</span><br><span class="line">            <span class="keyword">if</span> (!classFilter.matches(bean.getClass())) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">AdvisedSupport</span> <span class="variable">advisedSupport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvisedSupport</span>();</span><br><span class="line"></span><br><span class="line">            <span class="type">TargetSource</span> <span class="variable">targetSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TargetSource</span>(bean);</span><br><span class="line">            advisedSupport.setTargetSource(targetSource);</span><br><span class="line">            advisedSupport.setMethodInterceptor((MethodInterceptor) advisor.getAdvice());</span><br><span class="line">            advisedSupport.setMethodMatcher(advisor.getPointcut().getMethodMatcher());</span><br><span class="line">            advisedSupport.setProxyTargetClass(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProxyFactory</span>(advisedSupport).getProxy();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºåˆ¤æ–­å®ä¾‹åŒ–ä¹‹åçš„å¯¹è±¡æ˜¯å¦å·²ç»å±æ€§å¡«å……</span></span><br><span class="line"><span class="comment">// å½“å‰å·²ç”Ÿæˆå¡«å……å±æ€§ä¹‹åçš„ä»£ç†å¯¹è±¡,æ•…è¿”å›true</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">postProcessAfterInstantiation</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PropertyValues <span class="title function_">postProcessPropertyValues</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> pvs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>Tipï¼š 1. å› ä¸ºæ­¤æ—¶ ä»£ç†å¯¹è±¡çš„ç”Ÿæˆ æ˜¯åœ¨ Beanå®ä¾‹åŒ–ä¹‹åï¼Œæ‰€ä»¥ DefaultAdvisorAutoProxyCreator é…ç½® TargetSource éœ€å°† targetSource = new TargetSource(beanClass.getDeclaredConstructor().newInstance()); ä¿®æ”¹ä¸º targetSource = new TargetSource(bean);  ï¼Œå¦åˆ™å°†ä»£ç†æ–°çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œä»è€Œå¯¼è‡´å±æ€§æ— æ³•æ³¨å…¥ã€‚</p></blockquote><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/createBean.png" alt="createBean"></p><h2 id="Step15ï¼šä¸‰çº§ç¼“å­˜å¤„ç†å¾ªç¯ä¾èµ–"><a href="#Step15ï¼šä¸‰çº§ç¼“å­˜å¤„ç†å¾ªç¯ä¾èµ–" class="headerlink" title="Step15ï¼šä¸‰çº§ç¼“å­˜å¤„ç†å¾ªç¯ä¾èµ–"></a>Step15ï¼šä¸‰çº§ç¼“å­˜å¤„ç†å¾ªç¯ä¾èµ–</h2><h3 id="å®ç°ï¼š-14"><a href="#å®ç°ï¼š-14" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><ol><li><p>å®šä¹‰ ObjectFactory å‡½æ•°å¼æ¥å£ï¼Œç”¨äºè·å–ä¸‰çº§ç¼“å­˜ singletonFactories çš„ ä»£ç†å¯¹è±¡ã€‚ </p></li><li><p>å®Œå–„ DefaultSingletonBeanRegistry ï¼Œå¢åŠ  singletonObjects ä¸€çº§ç¼“å­˜ï¼ŒearlySingletonObjects äºŒçº§ç¼“å­˜ï¼ŒsingletonFactories ä¸‰çº§ç¼“å­˜ã€‚å¹¶æä¾› getSingleton è·å–æœ‰æ•ˆç¼“å­˜ä¸­çš„å¯¹è±¡ ï¼Œ registerSingleton æ³¨å†Œå•ä¾‹å¯¹è±¡ã€addSingletonFactory æ·»åŠ ä¸‰çº§ç¼“å­˜ çš„æ–¹æ³•ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.beans.factory.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.DisposableBean;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.SingletonBeanRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSingletonBeanRegistry</span> <span class="keyword">implements</span> <span class="title class_">SingletonBeanRegistry</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Internal marker for a null singleton object:</span></span><br><span class="line"><span class="comment">     * used as marker value for concurrent Maps (which don&#x27;t support null values).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">NULL_OBJECT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸€çº§ç¼“å­˜ï¼Œæ™®é€šå¯¹è±¡</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cache of singleton objects: bean name --&gt; bean instance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äºŒçº§ç¼“å­˜ï¼Œæå‰æš´æ¼å¯¹è±¡ï¼Œæ²¡æœ‰å®Œå…¨å®ä¾‹åŒ–çš„å¯¹è±¡</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cache of early singleton objects: bean name --&gt; bean instance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‰çº§ç¼“å­˜ï¼Œå­˜æ”¾ä»£ç†å¯¹è±¡</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cache of singleton factories: bean name --&gt; ObjectFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, ObjectFactory&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, DisposableBean&gt; disposableBeans = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getSingleton</span><span class="params">(String beanName)</span> &#123;</span><br><span class="line">        <span class="comment">//  è·å–ä¸€çº§ç¼“å­˜ä¸­çš„å¯¹è±¡</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">singletonObject</span> <span class="operator">=</span> singletonObjects.get(beanName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == singletonObject) &#123;</span><br><span class="line">            singletonObject = earlySingletonObjects.get(beanName);</span><br><span class="line">            <span class="comment">// åˆ¤æ–­äºŒçº§ç¼“å­˜ä¸­æ˜¯å¦æœ‰å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ä»£ç†å¯¹è±¡ï¼Œå› ä¸ºåªæœ‰ä»£ç†å¯¹è±¡æ‰ä¼šæ”¾åˆ°ä¸‰çº§ç¼“å­˜ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == singletonObject) &#123;</span><br><span class="line">                ObjectFactory&lt;?&gt; singletonFactory = singletonFactories.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (singletonFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    <span class="comment">// æŠŠä¸‰çº§ç¼“å­˜ä¸­çš„ä»£ç†å¯¹è±¡ä¸­çš„çœŸå®å¯¹è±¡è·å–å‡ºæ¥ï¼Œæ”¾å…¥äºŒçº§ç¼“å­˜ä¸­</span></span><br><span class="line">                    earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                    singletonFactories.remove(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singletonObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerSingleton</span><span class="params">(String beanName, Object singletonObject)</span> &#123;</span><br><span class="line">        singletonObjects.put(beanName, singletonObject);</span><br><span class="line">        earlySingletonObjects.remove(beanName);</span><br><span class="line">        singletonFactories.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addSingletonFactory</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.singletonObjects.containsKey(beanName)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">            <span class="built_in">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerDisposableBean</span><span class="params">(String beanName, DisposableBean bean)</span> &#123;</span><br><span class="line">        disposableBeans.put(beanName, bean);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroySingletons</span><span class="params">()</span> &#123;</span><br><span class="line">        Set&lt;String&gt; keySet = <span class="built_in">this</span>.disposableBeans.keySet();</span><br><span class="line">        Object[] disposableBeanNames = keySet.toArray();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> disposableBeanNames.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">beanName</span> <span class="operator">=</span> disposableBeanNames[i];</span><br><span class="line">            <span class="type">DisposableBean</span> <span class="variable">disposableBean</span> <span class="operator">=</span> disposableBeans.remove(beanName);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                disposableBean.destroy();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Destroy method on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; threw an exception&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®Œå–„ InstantiationAwareBeanPostProcessor ï¼Œå®šä¹‰ä¸€ä¸ª default æ™®é€šæ–¹æ³• getEarlyBeanReference ï¼Œè¿”å›ä¸€ä¸ªbean ï¼Œ å¹¶ä¾› DefaultAdvisorAutoProxyCreator å®ç°ã€‚</p></li><li><p>å®Œå–„ DefaultAdvisorAutoProxyCreator ï¼Œå¢åŠ  earlyProxyReferences åˆ—è¡¨ï¼Œç”¨äºè®°å½• åŸå§‹å¯¹è±¡ æ˜¯å¦å·²ç»ä»£ç†ï¼Œ å®ç° InstantiationAwareBeanPostProcessor.getEarlyBeanReference æ–¹æ³•ï¼Œç”Ÿæˆä»£ç†å¯¹è±¡å¹¶è®°å½•ï¼Œä¿®æ”¹ postProcessAfterInitialization æ–¹æ³•ï¼Œåˆ¤æ–­ earlyProxyReferences æ˜¯å¦å­˜åœ¨ å½“å‰å¯¹è±¡ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™è¡¨ç¤ºå·²ç» æå‰ä»£ç†ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.aop.framework.autoproxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.*;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.aspectj.AspectJExpressionPointcutAdvisor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.aop.framework.ProxyFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValues;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactory;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.BeanFactoryAware;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.support.DefaultListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.aopalliance.aop.Advice;</span><br><span class="line"><span class="keyword">import</span> org.aopalliance.intercept.MethodInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 20:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultAdvisorAutoProxyCreator</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryAware</span>,InstantiationAwareBeanPostProcessor &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Object&gt; earlyProxyReferences = Collections.synchronizedSet(<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="built_in">this</span>.beanFactory = (DefaultListableBeanFactory) beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isInfrastructureClass</span><span class="params">(Class&lt;?&gt; beanClass)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Advice.class.isAssignableFrom(beanClass) || Pointcut.class.isAssignableFrom(beanClass) || Advisor.class.isAssignableFrom(beanClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!earlyProxyReferences.contains(beanName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> wrapIfNecessary(bean);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">wrapIfNecessary</span><span class="params">(Object bean)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isInfrastructureClass(bean.getClass())) <span class="keyword">return</span> bean;</span><br><span class="line"></span><br><span class="line">        Collection&lt;AspectJExpressionPointcutAdvisor&gt; advisors = beanFactory.getBeansOfType(AspectJExpressionPointcutAdvisor.class).values();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (AspectJExpressionPointcutAdvisor advisor : advisors) &#123;</span><br><span class="line">            <span class="type">ClassFilter</span> <span class="variable">classFilter</span> <span class="operator">=</span> advisor.getPointcut().getClassFilter();</span><br><span class="line">            <span class="keyword">if</span> (!classFilter.matches(bean.getClass())) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">AdvisedSupport</span> <span class="variable">advisedSupport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvisedSupport</span>();</span><br><span class="line"></span><br><span class="line">            <span class="type">TargetSource</span> <span class="variable">targetSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TargetSource</span>(bean);</span><br><span class="line">            advisedSupport.setTargetSource(targetSource);</span><br><span class="line">            advisedSupport.setMethodInterceptor((MethodInterceptor) advisor.getAdvice());</span><br><span class="line">            advisedSupport.setMethodMatcher(advisor.getPointcut().getMethodMatcher());</span><br><span class="line">            advisedSupport.setProxyTargetClass(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProxyFactory</span>(advisedSupport).getProxy();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">postProcessAfterInstantiation</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PropertyValues <span class="title function_">postProcessPropertyValues</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> pvs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getEarlyBeanReference</span><span class="params">(Object bean, String beanName)</span> &#123;</span><br><span class="line">        earlyProxyReferences.add(beanName);</span><br><span class="line">        <span class="keyword">return</span> wrapIfNecessary(bean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®Œå–„ AbstractAutowireCapableBeanFactory ï¼Œåœ¨ createBean å®ä¾‹åŒ–Beanä¹‹åæ·»åŠ ä¸‰çº§ç¼“å­˜ addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, beanDefinition, finalBean));  ï¼Œ å¹¶åœ¨æœ€å åˆ¤æ–­å•ä¾‹ æ—¶ï¼Œè°ƒç”¨ getSingleton æ ¹æ®å®é™…æƒ…å†µè¿”å›å¯¹è±¡ï¼Œæœ€ç»ˆæ³¨å…¥ ä¸€çº§ç¼“å­˜ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.springframework.beans.factory.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValue;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.PropertyValues;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.*;</span><br><span class="line"><span class="keyword">import</span> cn.ray.springframework.beans.factory.config.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JOJO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/8/15 17:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractBeanFactory</span> <span class="keyword">implements</span> <span class="title class_">AutowireCapableBeanFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">InstantiationStrategy</span> <span class="variable">instantiationStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CglibSubclassingInstantiationStrategy</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> InstantiationStrategy <span class="title function_">getInstantiationStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instantiationStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInstantiationStrategy</span><span class="params">(InstantiationStrategy instantiationStrategy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.instantiationStrategy = instantiationStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, BeanDefinition beanDefinition, Object[] args)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦è¿”å›ä»£ç† Bean å¯¹è±¡</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> resolveBeforeInstantiation(beanName, beanDefinition);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != bean) &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> doCreateBean(beanName,beanDefinition,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(String beanName, BeanDefinition beanDefinition, Object[] args)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å®ä¾‹åŒ– Bean</span></span><br><span class="line">            bean = createBeanInstance(beanDefinition, beanName, args);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¤„ç†å¾ªç¯ä¾èµ–ï¼Œå°†å®ä¾‹åŒ–åçš„Beanå¯¹è±¡æå‰æ”¾å…¥ç¼“å­˜ä¸­æš´éœ²å‡ºæ¥</span></span><br><span class="line">            <span class="keyword">if</span> (beanDefinition.isSingleton()) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">finalBean</span> <span class="operator">=</span> bean;</span><br><span class="line">                addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, beanDefinition, finalBean));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®ä¾‹åŒ–ååˆ¤æ–­</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">continueWithPropertyPopulation</span> <span class="operator">=</span> applyBeanPostProcessorsAfterInstantiation(beanName, bean);</span><br><span class="line">            <span class="keyword">if</span> (!continueWithPropertyPopulation) &#123;</span><br><span class="line">                <span class="keyword">return</span> bean;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åœ¨è®¾ç½® Bean å±æ€§ä¹‹å‰ï¼Œå…è®¸ BeanPostProcessor ä¿®æ”¹å±æ€§å€¼</span></span><br><span class="line">            applyBeanPostProcessorsBeforeApplyingPropertyValues(beanName, bean, beanDefinition);</span><br><span class="line">            <span class="comment">// ç»™ Bean å¡«å……å±æ€§</span></span><br><span class="line">            applyPropertyValues(beanName, bean, beanDefinition);</span><br><span class="line">            <span class="comment">// æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•</span></span><br><span class="line">            bean = initializeBean(beanName, bean, beanDefinition);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Instantiation of bean failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å†Œå®ç°äº† DisposableBean æ¥å£çš„ Bean å¯¹è±¡</span></span><br><span class="line">        registerDisposableBeanIfNecessary(beanName, bean, beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­ SCOPE_SINGLETONã€SCOPE_PROTOTYPE</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">exposedObject</span> <span class="operator">=</span> bean;</span><br><span class="line">        <span class="keyword">if</span> (beanDefinition.isSingleton()) &#123;</span><br><span class="line">            <span class="comment">// è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">            exposedObject = getSingleton(beanName);</span><br><span class="line">            registerSingleton(beanName, exposedObject);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> exposedObject;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">getEarlyBeanReference</span><span class="params">(String beanName, BeanDefinition beanDefinition, Object bean)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">exposedObject</span> <span class="operator">=</span> bean;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor beanPostProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanPostProcessor <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">                exposedObject = ((InstantiationAwareBeanPostProcessor) beanPostProcessor).getEarlyBeanReference(exposedObject, beanName);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == exposedObject) <span class="keyword">return</span> exposedObject;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> exposedObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»£ç†å¯¹è±¡æˆ–å·²é…ç½®è¿‡å±æ€§åˆ™ä¸å†æ‰§è¡Œä¹‹åçš„æ“ä½œï¼Œç›´æ¥è¿”å›bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">applyBeanPostProcessorsAfterInstantiation</span><span class="params">(String beanName, Object bean)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">continueWithPropertyPopulation</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor beanPostProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanPostProcessor <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">                <span class="type">InstantiationAwareBeanPostProcessor</span> <span class="variable">instantiationAwareBeanPostProcessor</span> <span class="operator">=</span> (InstantiationAwareBeanPostProcessor) beanPostProcessor;</span><br><span class="line">                <span class="keyword">if</span> (!instantiationAwareBeanPostProcessor.postProcessAfterInstantiation(bean, beanName)) &#123;</span><br><span class="line">                    continueWithPropertyPopulation = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> continueWithPropertyPopulation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨è®¾ç½® Bean å±æ€§ä¹‹å‰ï¼Œå…è®¸ BeanPostProcessor ä¿®æ”¹å±æ€§å€¼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanDefinition</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">applyBeanPostProcessorsBeforeApplyingPropertyValues</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor beanPostProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanPostProcessor <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor)&#123;</span><br><span class="line">                <span class="type">PropertyValues</span> <span class="variable">pvs</span> <span class="operator">=</span> ((InstantiationAwareBeanPostProcessor) beanPostProcessor).postProcessPropertyValues(beanDefinition.getPropertyValues(), bean, beanName);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != pvs) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (PropertyValue propertyValue : pvs.getPropertyValues()) &#123;</span><br><span class="line">                        beanDefinition.getPropertyValues().addPropertyValue(propertyValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">resolveBeforeInstantiation</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> applyBeanPostProcessorsBeforeInstantiation(beanDefinition.getBeanClass(), beanName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != bean) &#123;</span><br><span class="line">            bean = applyBeanPostProcessorsAfterInitialization(bean, beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">applyBeanPostProcessorsBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor beanPostProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanPostProcessor <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> ((InstantiationAwareBeanPostProcessor) beanPostProcessor).postProcessBeforeInstantiation(beanClass, beanName);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != result) <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerDisposableBeanIfNecessary</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é Singleton ç±»å‹çš„ Bean ä¸æ‰§è¡Œé”€æ¯æ–¹æ³•ï¼Œå•ä¾‹Beanåªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œä½¿ç”¨å®Œæˆä¹‹åä»£è¡¨æ•´ä¸ªç¨‹åºä¹Ÿå°±æ‰§è¡Œå®Œæ¯•ã€‚è€ŒåŸå‹åˆ™ä¸ä¸€å®šã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!beanDefinition.isSingleton()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> DisposableBean || StrUtil.isNotEmpty(beanDefinition.getDestroyMethodName())) &#123;</span><br><span class="line">            registerDisposableBean(beanName, <span class="keyword">new</span> <span class="title class_">DisposableBeanAdapter</span>(bean, beanName, beanDefinition));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">createBeanInstance</span><span class="params">(BeanDefinition beanDefinition, String beanName, Object[] args)</span> &#123;</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructorToUse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Class&lt;?&gt; beanClass = beanDefinition.getBeanClass();</span><br><span class="line">        Constructor&lt;?&gt;[] declaredConstructors = beanClass.getDeclaredConstructors(); <span class="comment">// è·å–æ„é€ å‡½æ•°çš„ä¸ªæ•°</span></span><br><span class="line">        <span class="keyword">for</span> (Constructor ctor : declaredConstructors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != args &amp;&amp; ctor.getParameterTypes().length == args.length) &#123; <span class="comment">// ç®€å•æ¯”å¯¹å…¥å‚ä¸ªæ•°</span></span><br><span class="line">                constructorToUse = ctor;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getInstantiationStrategy().instantiate(beanDefinition, beanName, constructorToUse, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bean å±æ€§å¡«å……</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">applyPropertyValues</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> beanDefinition.getPropertyValues();</span><br><span class="line">            <span class="keyword">for</span> (PropertyValue propertyValue : propertyValues.getPropertyValues()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> propertyValue.getName();</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> propertyValue.getValue();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BeanReference) &#123;</span><br><span class="line">                    <span class="comment">// A ä¾èµ– Bï¼Œè·å– B çš„å®ä¾‹åŒ–</span></span><br><span class="line">                    <span class="type">BeanReference</span> <span class="variable">beanReference</span> <span class="operator">=</span> (BeanReference) value;</span><br><span class="line">                    value = getBean(beanReference.getBeanName());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å±æ€§å¡«å……</span></span><br><span class="line">                BeanUtil.setFieldValue(bean, name, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Error setting property valuesï¼š&quot;</span> + beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">initializeBean</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// invokeAwareMethods</span></span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanFactoryAware) &#123;</span><br><span class="line">                ((BeanFactoryAware) bean).setBeanFactory(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanClassLoaderAware)&#123;</span><br><span class="line">                ((BeanClassLoaderAware) bean).setBeanClassLoader(getBeanClassLoader());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanNameAware) &#123;</span><br><span class="line">                ((BeanNameAware) bean).setBeanName(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. æ‰§è¡Œ BeanPostProcessor Before å¤„ç†</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> applyBeanPostProcessorsBeforeInitialization(bean, beanName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾…å®Œæˆå†…å®¹ï¼šinvokeInitMethods(beanName, wrappedBean, beanDefinition);</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            invokeInitMethods(beanName, wrappedBean, beanDefinition);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Invocation of init method of bean[&quot;</span> + beanName + <span class="string">&quot;] failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. æ‰§è¡Œ BeanPostProcessor After å¤„ç†</span></span><br><span class="line">        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">        <span class="keyword">return</span> wrappedBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokeInitMethods</span><span class="params">(String beanName, Object bean, BeanDefinition beanDefinition)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. å®ç°æ¥å£ InitializingBean</span></span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> InitializingBean) &#123;</span><br><span class="line">            ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. æ³¨è§£é…ç½® init-method &#123;åˆ¤æ–­æ˜¯ä¸ºäº†é¿å…äºŒæ¬¡æ‰§è¡Œåˆå§‹åŒ–&#125;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">initMethodName</span> <span class="operator">=</span> beanDefinition.getInitMethodName();</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotEmpty(initMethodName) &amp;&amp; !(bean <span class="keyword">instanceof</span> InitializingBean)) &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">initMethod</span> <span class="operator">=</span> beanDefinition.getBeanClass().getMethod(initMethodName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == initMethod) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeansException</span>(<span class="string">&quot;Could not find an init method named &#x27;&quot;</span> + initMethodName + <span class="string">&quot;&#x27; on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            initMethod.invoke(bean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> existingBean;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">current</span> <span class="operator">=</span> processor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == current) <span class="keyword">return</span> result;</span><br><span class="line">            result = current;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">applyBeanPostProcessorsAfterInitialization</span><span class="params">(Object existingBean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> existingBean;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">current</span> <span class="operator">=</span> processor.postProcessAfterInitialization(result, beanName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == current) <span class="keyword">return</span> result;</span><br><span class="line">            result = current;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç»“æœï¼š-11"><a href="#ç»“æœï¼š-11" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h3><ol><li>singletonObjects ä¸€çº§ç¼“å­˜ï¼šç¼“å­˜æŸä¸ªbeanNameå¯¹åº”çš„ç»è¿‡äº†å®Œæ•´ç”Ÿå‘½å‘¨æœŸçš„bean</li><li>earlySingletonObjects äºŒçº§ç¼“å­˜ï¼šç¼“å­˜æå‰æ‹¿åŸå§‹å¯¹è±¡è¿›è¡Œäº†AOPä¹‹åå¾—åˆ°çš„ä»£ç†å¯¹è±¡ï¼ŒåŸå§‹å¯¹è±¡è¿˜æ²¡æœ‰è¿›è¡Œå±æ€§æ³¨å…¥å’Œåç»­çš„BeanPostProcessorç­‰ç”Ÿå‘½å‘¨æœŸ</li><li>singletonFactories ä¸‰çº§ç¼“å­˜ï¼šç¼“å­˜çš„æ˜¯ä¸€ä¸ªObjectFactoryï¼Œä¸»è¦ç”¨æ¥ç”ŸæˆåŸå§‹å¯¹è±¡è¿›è¡Œäº†AOPä¹‹åå¾—åˆ°çš„ä»£ç†å¯¹è±¡ï¼Œåœ¨æ¯ä¸ªBeançš„ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šæå‰æš´éœ²ä¸€ä¸ªå·¥å‚ï¼Œè¿™ä¸ªå·¥å‚å¯èƒ½ç”¨åˆ°ï¼Œä¹Ÿå¯èƒ½ç”¨ä¸åˆ°ï¼Œå¦‚æœæ²¡æœ‰å‡ºç°å¾ªç¯ä¾èµ–é‚£ä¹ˆè¿™ä¸ªå·¥å‚æ— ç”¨ï¼ŒbeanæŒ‰ç…§è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œï¼Œæ‰§è¡Œå®Œåç›´æ¥æ”¾å…¥singletonObjectsä¸­å³å¯ï¼Œå¦‚æœå‡ºç°äº†å¾ªç¯ä¾èµ– A ä¾èµ– Bï¼Œåˆ™ A æ‰§è¡ŒObjectFactoryæäº¤å¾—åˆ°ä¸€ä¸ªAOPä¹‹åçš„ä»£ç†å¯¹è±¡(å¦‚æœæœ‰AOPçš„è¯ï¼Œå¦‚æœæ— éœ€AOPï¼Œåˆ™ç›´æ¥å¾—åˆ°ä¸€ä¸ªåŸå§‹å¯¹è±¡)ã€‚</li></ol><p><img src="https://blog-1314261683.cos.ap-chongqing.myqcloud.com/image/step16.png" alt="step16"></p>]]></content>
      
      
      <categories>
          
          <category> æˆ‘çš„å­¦ä¹ æ—¥è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
